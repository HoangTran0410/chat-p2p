import{r as m,O as Ke,$ as wt,j as l,X as Pe,B as Ae,Q as be,V as xt,T as vt,W as St,Y as bt,Z as It,J as Ct,_ as kt,a0 as Pt}from"./vendor-CdBe9qih.js";import{c as Nt,v as Tt,d as Dt,e as Mt,a as jt,b as We,i as Xe,g as Ue,f as ze,h as Re,j as Rt}from"./services/crypto-DOdyDEE6.js";import{g as Be,s as He,a as Ve,b as Et,d as _t,e as qe,f as At,h as re,i as Kt}from"./services/db-DWyvzVjS.js";import{d as Gt,s as Qe,g as Se,a as Ne,b as Lt,e as $t}from"./services/storage-CphQKvNS.js";import{C as Ot}from"./components/chatsidebar-N4NieqU7.js";import{C as Ft}from"./components/chatwindow-XC-w3d8m.js";import{S as Yt}from"./components/settingsmodal-DYSvJKjO.js";import{S as Wt}from"./components/syncmodal-B1XTo6O9.js";import{K as Xt}from"./components/keychangewarningmodal-CYALWP-E.js";import"./index-Fs2phppL.js";import"./components/sessionswitcher-B1c3n44j.js";import"./components/newsessiondialog-Bx6hUwZz.js";import"./components/gameselector-DIblEhII.js";import"./components/gamecontainer-BIudOPOB.js";(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))t(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const d of r.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&t(d)}).observe(document,{childList:!0,subtree:!0});function e(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerPolicy&&(r.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?r.credentials="include":n.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function t(n){if(n.ep)return;n.ep=!0;const r=e(n);fetch(n.href,r)}})();function Cn(a){return a&&a.__esModule&&Object.prototype.hasOwnProperty.call(a,"default")?a.default:a}function Ut({sessionId:a,onKeyChange:s}){const[e,t]=m.useState(!1),[n,r]=m.useState(null),[d,c]=m.useState(null),u=m.useRef(null),p=m.useRef(null),i=m.useRef(new Map),[,g]=m.useState({}),C=m.useCallback(()=>g({}),[]);m.useEffect(()=>{if(!a)return;(async()=>{try{const N=await Et(a);if(N){const _=await Xe({publicKey:N.identityPubKey,privateKey:N.identityPrivKey});u.current=_}else{const _=await Rt();u.current=_;const ne=await We(_),le={sessionId:a,identityPubKey:ne.publicKey,identityPrivKey:ne.privateKey,createdAt:Date.now()};await Ve(le)}p.current=await Re();const b=await Ue(u.current.publicKey),A=await ze(u.current.publicKey);r(b),c(A),t(!0)}catch(N){console.error("Failed to initialize encryption:",N)}})()},[a]);const O=m.useCallback(async()=>!u.current||!p.current?null:Nt(u.current,p.current),[]),x=m.useCallback(async(y,N)=>{if(!p.current)return!1;try{const b=await Tt(N);if(!b.valid||!b.sessionKey||!b.fingerprint)return console.warn("Invalid key exchange from",y),!1;const A=await Dt(p.current.privateKey,b.sessionKey),_=await Be(y);let ne=!1;_&&_.fingerprint!==b.fingerprint&&(ne=!0,s&&s(y,_.fingerprint,b.fingerprint)),i.current.set(y,{sessionKey:A,fingerprint:b.fingerprint,verified:(_==null?void 0:_.verified)||!1,keyChanged:ne});const le={peerId:y,identityPubKey:N.identityPubKey,fingerprint:b.fingerprint,firstSeen:(_==null?void 0:_.firstSeen)||Date.now(),lastSeen:Date.now(),verified:(_==null?void 0:_.verified)||!1};return await He(le),C(),!0}catch(b){return console.error("Key exchange failed:",b),!1}},[s,C]),R=m.useCallback(async(y,N)=>{const b=i.current.get(y);if(!(b!=null&&b.sessionKey))return console.warn("No session key for peer:",y),null;try{return await Mt(N,b.sessionKey)}catch(A){return console.error("Encryption failed:",A),null}},[]),V=m.useCallback(async(y,N)=>{const b=i.current.get(y);if(!(b!=null&&b.sessionKey))return console.warn("No session key for peer:",y),null;try{return await jt(N,b.sessionKey)}catch(A){return console.error("Decryption failed:",A),null}},[]),Q=m.useCallback(y=>{var N;return((N=i.current.get(y))==null?void 0:N.fingerprint)||null},[]),U=m.useCallback(y=>{var N;return i.current.has(y)&&((N=i.current.get(y))==null?void 0:N.sessionKey)!==null},[]),L=m.useCallback(async y=>{const N=i.current.get(y);if(!N)return;N.verified=!0,N.keyChanged=!1;const b=await Be(y);b&&(b.verified=!0,await He(b)),C()},[C]),k=m.useCallback(async()=>{if(!u.current)return null;try{const y=await We(u.current);return JSON.stringify({sessionId:a,keys:y,exportedAt:Date.now()},null,2)}catch(y){return console.error("Failed to export keys:",y),null}},[a]),D=m.useCallback(async y=>{var N,b;try{const A=JSON.parse(y);if(!((N=A.keys)!=null&&N.publicKey)||!((b=A.keys)!=null&&b.privateKey))throw new Error("Invalid key format");const _=await Xe(A.keys);u.current=_;const ne={sessionId:a,identityPubKey:A.keys.publicKey,identityPrivKey:A.keys.privateKey,createdAt:A.exportedAt||Date.now()};await Ve(ne);const le=await Ue(_.publicKey),he=await ze(_.publicKey);return r(le),c(he),p.current=await Re(),!0}catch(A){return console.error("Failed to import keys:",A),!1}},[a]),j=m.useCallback(async()=>{p.current=await Re(),i.current.clear(),C()},[C]);return{isReady:e,myFingerprint:n,myShortFingerprint:d,identityKeyPair:u.current,sessionKeyPair:p.current,peerStates:i.current,createKeyExchange:O,handleKeyExchange:x,encrypt:R,decrypt:V,getPeerFingerprint:Q,hasPeerKey:U,markPeerVerified:L,exportMyKeys:k,importMyKeys:D,regenerateSessionKey:j}}function kn(a){return`${window.location.origin}${window.location.pathname}#connect=${a}`}function zt(){const a=window.location.hash;let s=null;return a.startsWith("#connect=")&&(s=a.slice(9),window.history.replaceState(null,"",window.location.pathname+window.location.search)),{pendingConnect:s}}const Te={host:"fbaio.xyz",port:443,path:"/peer",secure:!0,debug:3},et=50,{pendingConnect:Bt}=zt(),Ht=()=>{try{const a=localStorage.getItem("peer_config");return a?JSON.parse(a):Te}catch{return Te}},Vt=Ke((a,s)=>({chats:{},isStorageReady:!1,typingStates:{},sessions:[],activeSessionId:"",peerConfig:Ht(),selectedPeerId:null,showMobileDashboard:!1,showSettings:!1,showNewSessionDialog:!1,pendingConnectPeerId:Bt,setChats:e=>a(t=>({chats:typeof e=="function"?e(t.chats):e})),setIsStorageReady:e=>a({isStorageReady:e}),setTypingStates:e=>a(t=>({typingStates:typeof e=="function"?e(t.typingStates):e})),setSessions:e=>a(t=>({sessions:typeof e=="function"?e(t.sessions):e})),setActiveSessionId:e=>a({activeSessionId:e}),setPeerConfig:e=>{localStorage.setItem("peer_config",JSON.stringify(e)),a({peerConfig:e})},setSelectedPeerId:e=>a({selectedPeerId:e}),setShowMobileDashboard:e=>a({showMobileDashboard:e}),setShowSettings:e=>a({showSettings:e}),setShowNewSessionDialog:e=>a({showNewSessionDialog:e}),setPendingConnectPeerId:e=>a({pendingConnectPeerId:e}),selectChat:e=>a({selectedPeerId:e,showMobileDashboard:!1}),backToSidebar:()=>a({selectedPeerId:null,showMobileDashboard:!1}),renameChat:(e,t)=>{const n=s(),r=n.chats[e];if(!r)return;const d={...r,name:t.trim()===""?void 0:t.trim()};re(n.activeSessionId,d),a({chats:{...n.chats,[e]:d}})},deleteChat:(e,t)=>{const n=s();if(e&&confirm("Are you sure you want to delete this conversation?")){t(e);const r={...n.chats};delete r[e],At(n.activeSessionId,e),a({chats:r,selectedPeerId:null})}},switchSession:async e=>{const t=s();if(e!==t.activeSessionId){a({selectedPeerId:null,chats:{}}),Ne(e),a({activeSessionId:e});try{const n=await qe(e);a({chats:n})}catch(n){console.error("Failed to load chats for session:",n)}}},createNewSession:async()=>{const e=s(),t=Se(),n={id:t,createdAt:Date.now()};Qe(n);const r=[...e.sessions,n];Ne(t),a({sessions:r,activeSessionId:t,chats:{},selectedPeerId:null,showNewSessionDialog:!1})},deleteSession:async e=>{const t=s();if(e!==t.activeSessionId){Gt(e);try{await _t(e)}catch(n){console.error("Failed to delete chats for session:",n)}a({sessions:t.sessions.filter(n=>n.id!==e)})}}}));let ae=null;const q=new Map,de=[];let Je=Te;const Ee={message:new Set,connectionOpened:new Set,connectionClosed:new Set,connectionLimitExceeded:new Set},pe=Ke((a,s)=>({myId:"",isReady:!1,isReconnecting:!1,peerError:null,connectionStates:{},activeConnectionsCount:0,addListener:(e,t)=>(Ee[e].add(t),()=>Ee[e].delete(t)),emit:(e,t,n)=>{Ee[e].forEach(r=>r(t,n))},updatePeerState:(e,t)=>a(n=>({connectionStates:{...n.connectionStates,[e]:t}})),handleConnection:e=>{s().updatePeerState(e.peer,"connecting"),e.on("open",()=>{const n=s();if(q.size>=et){const r=de[0];if(r){const d=q.get(r);d&&d.close(),q.delete(r);const c=de.indexOf(r);c>-1&&de.splice(c,1),n.updatePeerState(r,"disconnected"),n.emit("connectionClosed",r),n.emit("connectionLimitExceeded",r)}}q.set(e.peer,e),de.push(e.peer),n.updatePeerState(e.peer,"connected"),n.emit("connectionOpened",e.peer),a({activeConnectionsCount:Array.from(q.values()).filter(r=>r==null?void 0:r.open).length}),e.send({type:"presence",status:"online"})}),e.on("data",n=>{const r=s();n&&typeof n=="object"&&n.type==="presence"||r.emit("message",e.peer,n)}),e.on("close",()=>{const n=s();q.delete(e.peer);const r=de.indexOf(e.peer);r>-1&&de.splice(r,1),n.updatePeerState(e.peer,"disconnected"),n.emit("connectionClosed",e.peer),a({activeConnectionsCount:Array.from(q.values()).filter(d=>d==null?void 0:d.open).length})}),e.on("error",n=>{console.error("Connection-specific error:",n),q.delete(e.peer),s().updatePeerState(e.peer,"failed")})},initPeer:(e,t=Te)=>{Je=t,a({isReconnecting:!0,myId:e});const n=window.Peer||wt,r=new n(e,{host:t.host,port:t.port,path:t.path,secure:t.secure,debug:t.debug||0});r.on("open",c=>{console.log("My Peer ID is: "+c),a({isReady:!0,isReconnecting:!1,peerError:null})}),r.on("connection",c=>{s().handleConnection(c)}),r.on("disconnected",()=>{console.log("Peer disconnected from server."),a({isReady:!1}),setTimeout(()=>{ae&&!ae.destroyed&&(console.log("Attempting to reconnect..."),a({isReconnecting:!0}),ae.reconnect())},3e3)}),r.on("error",c=>{if(console.error("PeerJS error:",c),a({isReconnecting:!1}),c.type==="unavailable-id")a({peerError:"ID is already taken. Please choose another.",isReady:!1});else if(c.message&&c.message.includes("is taken"))a({peerError:`ID is taken: ${c.message}`,isReady:!1});else if(c.type==="peer-unavailable"){const p=(c.message||"").match(/Could not connect to peer (.*)/);p&&p[1]&&s().updatePeerState(p[1],"failed")}else c.type==="network"||c.type==="disconnected"?(a({isReady:!1,peerError:"Network error. Reconnecting..."}),setTimeout(()=>{ae&&!ae.destroyed&&(a({isReconnecting:!0}),ae.reconnect())},3e3)):a({peerError:"Connection error: "+(c.message||"Unknown error")})}),ae=r;const d=()=>{r==null||r.destroy()};window.addEventListener("beforeunload",d)},destroyPeer:()=>{ae&&(ae.destroy(),ae=null),q.clear(),de.length=0,a({connectionStates:{},isReady:!1,activeConnectionsCount:0})},connectToPeer:e=>{const t=s();if(!(!ae||!t.isReady)){if(q.has(e)){const n=q.get(e);if(n!=null&&n.open){t.updatePeerState(e,"connected");return}}t.updatePeerState(e,"connecting");try{const n=ae.connect(e,{reliable:!0});t.handleConnection(n),setTimeout(()=>{a(r=>r.connectionStates[e]==="connecting"?{connectionStates:{...r.connectionStates,[e]:"failed"}}:r)},1e4)}catch(n){console.error("Connect error",n),t.updatePeerState(e,"failed")}}},disconnectPeer:e=>{const t=q.get(e);t&&(t.close(),q.delete(e));const n=de.indexOf(e);n>-1&&de.splice(n,1),s().updatePeerState(e,"disconnected"),a({activeConnectionsCount:Array.from(q.values()).filter(r=>r==null?void 0:r.open).length})},sendMessage:(e,t)=>{const n=q.get(e);return n&&n.open?(n.send(t),!0):!1},updateId:(e,t)=>{const n=s();!e||e===n.myId||(n.destroyPeer(),a({peerError:null}),n.initPeer(e,t||Je))}})),_e=64*1024,Pn=50*1024*1024;class Jt{constructor(){this.gameClasses=new Map,this.gameDefinitionCache=new Map}register(s){const e=new s,t=e.gameId;if(this.gameClasses.has(t)){console.warn(`Game ${t} is already registered, skipping...`);return}this.gameClasses.set(t,s),this.gameDefinitionCache.set(t,e.getDefinition())}createInstance(s){const e=this.gameClasses.get(s);return e?new e:(console.warn(`Game ${s} not found in registry`),null)}getAllDefinitions(){return Array.from(this.gameDefinitionCache.values())}has(s){return this.gameClasses.has(s)}getDefinition(s){return this.gameDefinitionCache.get(s)}}const te=new Jt;class tt{getDefinition(){return{id:this.gameId,name:this.gameName,icon:this.gameIcon,description:this.gameDescription,minPlayers:2,maxPlayers:2}}getNextTurn(s){return s.currentTurn===s.hostId?s.guestId:s.hostId}isPlayerTurn(s,e){return s.currentTurn===e&&s.status==="playing"}}function Zt({state:a,myId:s,onMove:e,isMyTurn:t}){const{board:n}=a.data,d=s===a.hostId?"X":"O",{leaveGame:c}=ve(),p=(()=>{const g=[[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];for(const C of g){const[O,x,R]=C;if(n[O]&&n[O]===n[x]&&n[O]===n[R])return C}return null})(),i=g=>{!t||n[g]||a.status!=="playing"||e(g)};return l.jsxs("div",{className:"flex flex-col items-center gap-6 p-4 w-full max-w-sm mx-auto",children:[l.jsxs("div",{className:"flex flex-col items-center gap-2",children:[l.jsx("div",{className:"text-xl font-bold flex items-center gap-2",children:a.status==="finished"?a.winner?l.jsx("span",{className:a.winner===s?"text-green-400":"text-red-400",children:a.winner===s?"You Won!":"Opponent Won!"}):l.jsx("span",{className:"text-yellow-400",children:"Draw!"}):l.jsx("span",{className:t?"text-primary-400":"text-slate-400",children:t?"Your Turn":"Opponent's Turn"})}),l.jsxs("div",{className:"text-sm text-slate-500 flex items-center gap-4",children:[l.jsxs("span",{className:"flex items-center gap-1",children:[l.jsx(Pe,{className:"w-4 h-4 text-blue-400"})," You: ",d]}),l.jsxs("span",{className:"flex items-center gap-1",children:[l.jsx(Ae,{className:"w-4 h-4 text-red-400"})," Opponent:"," ",d==="X"?"O":"X"]})]})]}),l.jsx("div",{className:"grid grid-cols-3 gap-3 bg-slate-800 p-3 rounded-xl relative",children:n.map((g,C)=>{const O=p==null?void 0:p.includes(C),x=t&&!g&&a.status==="playing";return l.jsxs("button",{onClick:()=>i(C),disabled:!x,className:`
                w-20 h-20 sm:w-24 sm:h-24 rounded-lg flex items-center justify-center text-4xl transition-all
                ${g?"bg-slate-700 shadow-inner":"bg-slate-750 hover:bg-slate-700"}
                ${O?"bg-green-500/20 ring-2 ring-green-500":""}
                ${x?"cursor-pointer hover:ring-2 hover:ring-primary-500/50":"cursor-default"}
              `,children:[g==="X"&&l.jsx(Pe,{className:`w-12 h-12 ${O?"text-green-400":"text-blue-400"}`,strokeWidth:2.5}),g==="O"&&l.jsx(Ae,{className:`w-10 h-10 ${O?"text-green-400":"text-red-400"}`,strokeWidth:2.5})]},C)})}),a.status==="finished"&&l.jsxs("div",{className:"flex gap-3 w-full",children:[l.jsx("button",{onClick:()=>ve.getState().restartGame(),className:"flex-1 py-3 bg-primary-600 hover:bg-primary-500 rounded-lg text-white font-medium transition-colors shadow-lg shadow-primary-900/20",children:"Play Again"}),l.jsx("button",{onClick:c,className:"flex-1 py-3 bg-slate-800 hover:bg-slate-700 rounded-lg text-slate-300 font-medium transition-colors",children:"Close Game"})]})]})}const qt=[[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];class Qt extends tt{constructor(){super(...arguments),this.gameId="tictactoe",this.gameName="Tic-Tac-Toe",this.gameIcon="â­•",this.gameDescription="Classic 3x3 strategy game"}createInitialState(s,e){return{board:Array(9).fill(null),winningLine:null}}isValidMove(s,e){const{board:t}=s.data,n=e.payload;return!(n<0||n>8||t[n]!==null||s.winner||!this.isPlayerTurn(s,e.playerId))}applyMove(s,e){const{board:t}=s.data,n=e.payload,r=e.playerId===s.hostId?"X":"O",d=[...t];return d[n]=r,{...s,data:{...s.data,board:d}}}checkGameEnd(s){const{board:e}=s.data;for(const t of qt){const[n,r,d]=t;if(e[n]&&e[n]===e[r]&&e[n]===e[d])return{isEnded:!0,winner:e[n]==="X"?s.hostId:s.guestId,isDraw:!1}}return e.every(t=>t!==null)?{isEnded:!0,winner:null,isDraw:!0}:{isEnded:!1,winner:null,isDraw:!1}}renderGame(s,e,t,n){return be.createElement(Zt,{state:s,myId:e,onMove:t,isMyTurn:n})}}class nt{getDefinition(){return{id:this.gameId,name:this.gameName,icon:this.gameIcon,description:this.gameDescription,minPlayers:2,maxPlayers:2,isRealTime:!0}}}const Ze=["#ef4444","#3b82f6","#22c55e","#eab308","#a855f7","#ec4899","#000000"];function en({state:a,myId:s,onAction:e}){const t=m.useRef(null),[n,r]=m.useState(!1),[d,c]=m.useState(Ze[0]),[u,p]=m.useState([]),{leaveGame:i}=ve();a.hostId,m.useEffect(()=>{const k=t.current;if(!k)return;const D=k.getContext("2d");D&&(D.clearRect(0,0,k.width,k.height),a.data.strokes.forEach(j=>{if(!(j.points.length<2)){D.strokeStyle=j.color,D.lineWidth=j.width,D.lineCap="round",D.lineJoin="round",D.beginPath(),D.moveTo(j.points[0].x,j.points[0].y);for(let y=1;y<j.points.length;y++)D.lineTo(j.points[y].x,j.points[y].y);D.stroke()}}))},[a.data.strokes]);const g=k=>{const D=t.current,j=D.getBoundingClientRect(),y=k.clientX-j.left,N=k.clientY-j.top,b=D.width/j.width,A=D.height/j.height;return{x:y*b,y:N*A}},C=k=>{r(!0);const D=g(k);p([D])},O=k=>{if(!n)return;const D=g(k);p(N=>[...N,D]);const y=t.current.getContext("2d");u.length>0&&(y.strokeStyle=d,y.lineWidth=3,y.lineCap="round",y.lineJoin="round",y.beginPath(),y.moveTo(u[u.length-1].x,u[u.length-1].y),y.lineTo(D.x,D.y),y.stroke())},x=()=>{if(!n||u.length<2){r(!1),p([]);return}const k={id:`${s}_${Date.now()}`,playerId:s,points:u,color:d,width:3};e({type:"draw",stroke:k}),r(!1),p([])},R=k=>{const D=t.current,j=D.getBoundingClientRect(),y=k.touches[0]||k.changedTouches[0],N=y.clientX-j.left,b=y.clientY-j.top,A=D.width/j.width,_=D.height/j.height;return{x:N*A,y:b*_}},V=k=>{r(!0);const D=R(k);p([D])},Q=k=>{if(!n)return;const D=R(k);p(N=>[...N,D]);const y=t.current.getContext("2d");u.length>0&&(y.strokeStyle=d,y.lineWidth=3,y.lineCap="round",y.lineJoin="round",y.beginPath(),y.moveTo(u[u.length-1].x,u[u.length-1].y),y.lineTo(D.x,D.y),y.stroke())},U=()=>{if(!n||u.length<2){r(!1),p([]);return}const k={id:`${s}_${Date.now()}`,playerId:s,points:u,color:d,width:3};e({type:"draw",stroke:k}),r(!1),p([])},L=()=>{confirm("Clear the entire canvas?")&&e({type:"clear"})};return l.jsxs("div",{className:"flex flex-col items-center gap-2 md:gap-4 p-2 md:p-4 w-full h-full max-w-full md:max-w-2xl mx-auto",children:[l.jsxs("div",{className:"flex items-center gap-1.5 md:gap-2 p-1.5 md:p-2 bg-slate-800 rounded-lg w-full justify-center",children:[l.jsx(xt,{className:"w-3 h-3 md:w-4 md:h-4 text-slate-400 hidden md:block"}),Ze.map(k=>l.jsx("button",{onClick:()=>c(k),className:`w-7 h-7 md:w-8 md:h-8 rounded-full border-2 transition-all ${d===k?"border-white scale-110":"border-slate-600 hover:scale-105"}`,style:{backgroundColor:k},title:k},k)),l.jsx("div",{className:"w-px h-6 md:h-8 bg-slate-700 mx-0.5 md:mx-1"}),l.jsx("button",{onClick:L,className:"p-2 hover:bg-slate-700 rounded-lg transition-colors text-slate-400 hover:text-red-400",title:"Clear canvas",children:l.jsx(vt,{className:"w-4 h-4"})})]}),l.jsx("canvas",{ref:t,width:600,height:400,onMouseDown:C,onMouseMove:O,onMouseUp:x,onMouseLeave:x,onTouchStart:V,onTouchMove:Q,onTouchEnd:U,className:"w-full flex-1 md:flex-none border-2 border-slate-700 rounded-lg bg-white cursor-crosshair touch-none",style:{aspectRatio:"3/2",minHeight:"200px"}}),l.jsxs("div",{className:"text-xs text-slate-500",children:[a.data.strokes.length," strokes"]})]})}class tn extends nt{constructor(){super(...arguments),this.gameId="canvas",this.gameName="Draw Together",this.gameIcon="ðŸŽ¨",this.gameDescription="Collaborative drawing canvas"}createInitialState(s,e){return{strokes:[]}}applyAction(s,e){const{payload:t}=e;switch(t.type){case"draw":return{...s,data:{...s.data,strokes:[...s.data.strokes,t.stroke]},updatedAt:Date.now()};case"clear":return{...s,data:{...s.data,strokes:[]},updatedAt:Date.now()};default:return s}}renderGame(s,e,t){return be.createElement(en,{state:s,myId:e,onAction:t})}}function nn({state:a,myId:s,onAction:e}){const t=m.useRef(null),[n,r]=m.useState(""),[d,c]=m.useState(!1),u=m.useRef(!1),p=s===a.hostId;m.useEffect(()=>{var V;if(window.YT){c(!0);return}const x=document.createElement("script");x.src="https://www.youtube.com/iframe_api";const R=document.getElementsByTagName("script")[0];(V=R.parentNode)==null||V.insertBefore(x,R),window.onYouTubeIframeAPIReady=()=>{c(!0)}},[]),m.useEffect(()=>{!d||!a.data.videoId||(t.current&&t.current.destroy(),t.current=new window.YT.Player("youtube-player",{videoId:a.data.videoId,playerVars:{autoplay:0,controls:1,modestbranding:1,rel:0},events:{onReady:i,onStateChange:g}}))},[d,a.data.videoId]),m.useEffect(()=>{if(!t.current||!t.current.getPlayerState||u.current)return;const x=t.current;a.data.isPlaying?x.getPlayerState()!==1&&(u.current=!0,x.playVideo(),setTimeout(()=>u.current=!1,500)):x.getPlayerState()===1&&(u.current=!0,x.pauseVideo(),setTimeout(()=>u.current=!1,500));const R=x.getCurrentTime();Math.abs(R-a.data.currentTime)>2&&(u.current=!0,x.seekTo(a.data.currentTime,!0),setTimeout(()=>u.current=!1,500))},[a.data.isPlaying,a.data.currentTime,a.updatedAt]);const i=x=>{t.current=x.target},g=x=>{if(u.current)return;const V=x.target.getCurrentTime();x.data===1?e({type:"play",time:V}):x.data===2&&e({type:"pause",time:V})},C=x=>{const R=[/(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&\n?#]+)/,/^([a-zA-Z0-9_-]{11})$/];for(const V of R){const Q=x.match(V);if(Q)return Q[1]}return null},O=()=>{const x=C(n);x?(e({type:"load_video",videoId:x}),r("")):alert("Invalid YouTube URL or video ID")};return l.jsxs("div",{className:"flex flex-col gap-3 p-2 md:p-4 w-full h-full max-w-full md:max-w-6xl mx-auto",children:[l.jsxs("div",{className:"flex gap-2",children:[l.jsxs("div",{className:"flex-1 relative",children:[l.jsx(St,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"}),l.jsx("input",{type:"text",value:n,onChange:x=>r(x.target.value),onKeyDown:x=>{x.key==="Enter"&&O()},placeholder:"Paste YouTube URL or video ID...",className:"w-full pl-10 pr-4 py-2 bg-slate-800 border border-slate-700 rounded-lg text-slate-200 placeholder-slate-500 focus:outline-none focus:border-primary-500"})]}),l.jsx("button",{onClick:O,className:"px-4 py-2 bg-primary-600 hover:bg-primary-500 rounded-lg text-white font-medium transition-colors",children:"Load"})]}),a.data.videoId?l.jsx("div",{className:"relative w-full flex-1 bg-black rounded-lg overflow-hidden min-h-[400px] md:min-h-[500px]",children:l.jsx("div",{id:"youtube-player",className:"absolute inset-0",style:{width:"100%",height:"100%"}})}):l.jsx("div",{className:"flex-1 flex items-center justify-center bg-slate-800 rounded-lg border-2 border-dashed border-slate-700",children:l.jsxs("div",{className:"text-center p-8",children:[l.jsx("div",{className:"text-6xl mb-4",children:"ðŸ“º"}),l.jsx("div",{className:"text-slate-300 font-semibold mb-2",children:"No video loaded"}),l.jsx("div",{className:"text-sm text-slate-500",children:"Paste a YouTube URL above to start watching together"})]})}),l.jsxs("div",{className:"text-xs text-slate-500 flex items-center justify-between",children:[l.jsxs("span",{children:["You are ",p?"Host":"Guest"]}),a.data.videoId&&l.jsx("span",{className:"flex items-center gap-2",children:a.data.isPlaying?l.jsxs(l.Fragment,{children:[l.jsx(bt,{className:"w-3 h-3 text-green-400"}),"Playing"]}):l.jsxs(l.Fragment,{children:[l.jsx(It,{className:"w-3 h-3 text-yellow-400"}),"Paused"]})})]})]})}class sn extends nt{constructor(){super(...arguments),this.gameId="youtube",this.gameName="Watch Together",this.gameIcon="ðŸ“º",this.gameDescription="Watch YouTube videos together"}createInitialState(s,e){return{videoId:null,isPlaying:!1,currentTime:0}}applyAction(s,e){const{payload:t}=e;switch(t.type){case"load_video":return{...s,data:{videoId:t.videoId,isPlaying:!1,currentTime:0},updatedAt:Date.now()};case"play":return{...s,data:{...s.data,isPlaying:!0,currentTime:t.time},updatedAt:Date.now()};case"pause":return{...s,data:{...s.data,isPlaying:!1,currentTime:t.time},updatedAt:Date.now()};case"seek":return{...s,data:{...s.data,currentTime:t.time},updatedAt:Date.now()};default:return s}}renderGame(s,e,t){return be.createElement(nn,{state:s,myId:e,onAction:t})}}const me=50,xe=40;function an({state:a,myId:s,onMove:e,isMyTurn:t}){const{board:n,winningLine:r}=a.data,c=s===a.hostId?"X":"O",{leaveGame:u}=ve(),p=m.useRef(null),i=m.useRef(null),[g,C]=m.useState({x:20,y:20}),[O,x]=m.useState(!1),[R,V]=m.useState({x:0,y:0,viewportX:0,viewportY:0}),[Q,U]=m.useState(null),[L,k]=m.useState({width:600,height:600}),D=()=>{const v=Object.keys(n);if(v.length===0)return null;const f=v[v.length-1],[P,W]=f.split(",").map(Number);return{row:P,col:W}};m.useEffect(()=>{const v=()=>{if(i.current){const f=i.current.clientWidth,P=i.current.clientHeight;k({width:f,height:P})}};return v(),window.addEventListener("resize",v),()=>window.removeEventListener("resize",v)},[]),m.useEffect(()=>{const v=p.current;if(!v)return;const f=v.getContext("2d");if(!f)return;f.clearRect(0,0,L.width,L.height);const P=xe,W=Math.ceil(L.width/P),ee=Math.ceil(L.height/P),ie=-(g.x*P)%P,ce=-(g.y*P)%P,J=Math.floor(g.x),se=Math.floor(g.y);f.strokeStyle="#334155",f.lineWidth=1;for(let X=0;X<=W+1;X++){const F=ie+X*P;f.beginPath(),f.moveTo(F,0),f.lineTo(F,L.height),f.stroke()}for(let X=0;X<=ee+1;X++){const F=ce+X*P;f.beginPath(),f.moveTo(0,F),f.lineTo(L.width,F),f.stroke()}if(Q&&t&&a.status==="playing"){const X=Q.col-J,F=Q.row-se;X>=0&&X<W&&F>=0&&F<ee&&(f.fillStyle="rgba(148, 163, 184, 0.2)",f.fillRect(ie+X*P,ce+F*P,P,P))}for(let X=0;X<W+1;X++)for(let F=0;F<ee+1;F++){const oe=J+X,ye=se+F;if(oe<0||oe>=me||ye<0||ye>=me)continue;const Ge=`${ye},${oe}`,De=n[Ge];if(!De)continue;const we=ie+X*P+P/2,ue=ce+F*P+P/2,Ie=r==null?void 0:r.some(([Z,fe])=>Z===ye&&fe===oe),z=D(),Me=z&&z.row===ye&&z.col===oe;if(De==="X"){f.strokeStyle=Ie?"#4ade80":"#3b82f6",f.lineWidth=Me?4:3;const Z=P*.3;f.beginPath(),f.moveTo(we-Z,ue-Z),f.lineTo(we+Z,ue+Z),f.stroke(),f.beginPath(),f.moveTo(we+Z,ue-Z),f.lineTo(we-Z,ue+Z),f.stroke()}else{f.strokeStyle=Ie?"#4ade80":"#ef4444",f.lineWidth=Me?4:3;const Z=P*.25;f.beginPath(),f.arc(we,ue,Z,0,Math.PI*2),f.stroke()}}f.fillStyle="#64748b",f.font="10px monospace",f.fillText(`(${J}, ${se})`,5,15)},[g,n,r,Q,t,a.status,L]);const j=(v,f)=>{const P=p.current;if(!P)return null;const W=P.getBoundingClientRect(),ee=v-W.left,ie=f-W.top,ce=xe,J=Math.floor(g.x+ee/ce),se=Math.floor(g.y+ie/ce);return J<0||J>=me||se<0||se>=me?null:{row:se,col:J}},y=v=>{x(!0),V({x:v.clientX,y:v.clientY,viewportX:g.x,viewportY:g.y})},N=v=>{const f=j(v.clientX,v.clientY);if(U(f),O){const P=(R.x-v.clientX)/xe,W=(R.y-v.clientY)/xe;C({x:Math.max(0,Math.min(me-1,R.viewportX+P)),y:Math.max(0,Math.min(me-1,R.viewportY+W))})}},b=()=>{x(!1)},A=()=>{x(!1),U(null)},_=v=>{if(Math.abs(v.clientX-R.x)>5||Math.abs(v.clientY-R.y)>5||!t||a.status!=="playing")return;const f=j(v.clientX,v.clientY);if(!f)return;const P=`${f.row},${f.col}`;n[P]||e(f)},ne=v=>{const f=v.touches[0];x(!0),V({x:f.clientX,y:f.clientY,viewportX:g.x,viewportY:g.y})},le=v=>{const f=v.touches[0],P=j(f.clientX,f.clientY);if(U(P),O){const W=(R.x-f.clientX)/xe,ee=(R.y-f.clientY)/xe;C({x:Math.max(0,Math.min(me-1,R.viewportX+W)),y:Math.max(0,Math.min(me-1,R.viewportY+ee))})}},he=v=>{const f=v.changedTouches[0];if(Math.abs(f.clientX-R.x)>5||Math.abs(f.clientY-R.y)>5){x(!1),U(null);return}if(x(!1),U(null),!t||a.status!=="playing")return;const P=j(f.clientX,f.clientY);if(!P)return;const W=`${P.row},${P.col}`;n[W]||e(P)},ge=()=>{const v=D();if(!v)return;const f=Math.max(0,v.col-3),P=Math.max(0,v.row-3),W=g.x,ee=g.y,ie=performance.now(),ce=300,J=se=>{const X=se-ie,F=Math.min(X/ce,1),oe=1-Math.pow(1-F,3);C({x:W+(f-W)*oe,y:ee+(P-ee)*oe}),F<1&&requestAnimationFrame(J)};requestAnimationFrame(J)};return l.jsxs("div",{className:"flex flex-col gap-3 p-2 md:p-4 w-full h-full",children:[l.jsxs("div",{className:"flex items-center justify-between",children:[l.jsxs("div",{className:"flex items-center gap-3",children:[l.jsx("div",{className:"text-sm font-semibold",children:a.status==="finished"?a.winner?l.jsx("span",{className:a.winner===s?"text-green-400":"text-red-400",children:a.winner===s?"You Won!":"Opponent Won!"}):l.jsx("span",{className:"text-yellow-400",children:"Draw!"}):l.jsx("span",{className:t?"text-primary-400":"text-slate-400",children:t?"Your Turn":"Opponent's Turn"})}),l.jsxs("div",{className:"text-xs text-slate-500 flex items-center gap-2",children:[l.jsxs("span",{className:"flex items-center gap-1",children:[l.jsx(Pe,{className:"w-3 h-3 text-blue-400"})," ",c==="X"?"You":"Opp"]}),l.jsxs("span",{className:"flex items-center gap-1",children:[l.jsx(Ae,{className:"w-3 h-3 text-red-400"})," ",c==="O"?"You":"Opp"]})]})]}),l.jsx("div",{className:"flex gap-2 text-xs",children:a.status==="finished"?l.jsxs("button",{onClick:()=>ve.getState().restartGame(),className:"px-2 py-1 bg-primary-600 hover:bg-primary-500 rounded text-white flex items-center gap-1",title:"New game",children:[l.jsx(Ct,{className:"w-3 h-3"}),l.jsx("span",{children:"New Game"})]}):l.jsxs("button",{onClick:ge,disabled:Object.keys(n).length===0,className:"px-2 py-1 bg-slate-800 hover:bg-slate-700 rounded text-slate-300 flex items-center gap-1 disabled:opacity-50 disabled:cursor-not-allowed",title:"Focus to last move",children:[l.jsx(kt,{className:"w-3 h-3"}),l.jsx("span",{children:"Last"})]})})]}),l.jsx("div",{ref:i,className:"flex-1 min-h-0",children:l.jsx("canvas",{ref:p,width:L.width,height:L.height,className:"w-full h-full border-2 border-slate-700 rounded-lg bg-slate-900 cursor-move touch-none",onMouseDown:y,onMouseMove:N,onMouseUp:b,onMouseLeave:A,onClick:_,onTouchStart:ne,onTouchMove:le,onTouchEnd:he})}),l.jsx("div",{className:"text-xs text-slate-500 text-center",children:"Drag to pan â€¢ Click to place"})]})}class rn extends tt{constructor(){super(...arguments),this.gameId="caro",this.gameName="Caro (Gomoku)",this.gameIcon="âŒ",this.gameDescription="5-in-a-row on large board",this.BOARD_SIZE=50,this.WIN_LENGTH=5}createInitialState(s,e){return{board:{},winningLine:null}}isValidMove(s,e){const{row:t,col:n}=e.payload,r=`${t},${n}`;return s.currentTurn===e.playerId&&!s.data.board[r]&&t>=0&&t<this.BOARD_SIZE&&n>=0&&n<this.BOARD_SIZE}applyMove(s,e){const{row:t,col:n}=e.payload,r=`${t},${n}`,d=s.currentTurn===s.hostId?"X":"O";return{...s,data:{...s.data,board:{...s.data.board,[r]:d}}}}checkGameEnd(s){const{board:e}=s.data;for(const t in e){const[n,r]=t.split(",").map(Number);if(this.checkWinFrom(e,n,r))return{isEnded:!0,winner:e[t]==="X"?s.hostId:s.guestId,isDraw:!1}}return{isEnded:!1,winner:null,isDraw:!1}}checkWinFrom(s,e,t){const n=s[`${e},${t}`];if(!n)return null;const r=[[0,1],[1,0],[1,1],[1,-1]];for(const[d,c]of r){const u=[[e,t]];for(let p=1;p<this.WIN_LENGTH;p++){const i=e+d*p,g=t+c*p;if(s[`${i},${g}`]===n)u.push([i,g]);else break}for(let p=1;p<this.WIN_LENGTH;p++){const i=e-d*p,g=t-c*p;if(s[`${i},${g}`]===n)u.unshift([i,g]);else break}if(u.length>=this.WIN_LENGTH)return u.slice(0,this.WIN_LENGTH)}return null}renderGame(s,e,t,n){return be.createElement(an,{state:s,myId:e,onMove:t,isMyTurn:n})}}te.register(Qt);te.register(rn);te.register(tn);te.register(sn);const on=()=>`game_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,ve=Ke((a,s)=>({activeGame:null,pendingInvites:[],setActiveGame:e=>a({activeGame:e}),addPendingInvite:e=>a(t=>({pendingInvites:[...t.pendingInvites,e]})),removePendingInvite:e=>a(t=>({pendingInvites:t.pendingInvites.filter(n=>n.sessionId!==e)})),clearPendingInvites:()=>a({pendingInvites:[]}),createGame:(e,t)=>{const{sendMessage:n,myId:r}=pe.getState(),d=te.createInstance(e);if(!d||!r)return null;const c=on(),u=d.createInitialState(r,t),p={id:c,gameType:e,hostId:r,guestId:t,status:"waiting",currentTurn:r,winner:null,isDraw:!1,data:u,createdAt:Date.now(),updatedAt:Date.now()};return a({activeGame:p}),n(t,{type:"game_invite",gameType:e,sessionId:c,hostId:r}),c},acceptInvite:e=>{const t=s(),{sendMessage:n,myId:r}=pe.getState(),d=t.pendingInvites.find(i=>i.sessionId===e);if(!d||!r)return;const c=te.createInstance(d.gameType);if(!c)return;t.removePendingInvite(e),n(d.hostId,{type:"game_accept",sessionId:e});const u=c.createInitialState(d.hostId,r),p={id:e,gameType:d.gameType,hostId:d.hostId,guestId:r,status:"waiting",currentTurn:d.hostId,winner:null,isDraw:!1,data:u,createdAt:Date.now(),updatedAt:Date.now()};a({activeGame:p})},declineInvite:e=>{const t=s(),{sendMessage:n}=pe.getState(),r=t.pendingInvites.find(d=>d.sessionId===e);r&&(t.removePendingInvite(e),n(r.hostId,{type:"game_decline",sessionId:e}))},makeMove:e=>{const t=s(),{sendMessage:n,myId:r}=pe.getState(),{activeGame:d}=t;if(!d||d.status!=="playing"||!r)return;const c=te.createInstance(d.gameType),u=te.getDefinition(d.gameType);if(!c)return;const p=r===d.hostId?d.guestId:d.hostId;if(u!=null&&u.isRealTime){const i={type:"action",playerId:r,timestamp:Date.now(),payload:e};let g=c.applyAction(d,i);if(typeof c.checkGameEnd=="function"){const C=c.checkGameEnd(g);C.isEnded&&(g={...g,status:"finished",winner:C.winner,isDraw:C.isDraw})}g.updatedAt=Date.now(),a({activeGame:g}),n(p,{type:"game_realtime_action",sessionId:d.id,action:i})}else{const i={type:"move",playerId:r,timestamp:Date.now(),payload:e};if(!c.isValidMove(d,i)){console.warn("Invalid move attempted");return}if(r===d.hostId){let C=c.applyMove(d,i);const O=c.checkGameEnd(C);O.isEnded?C={...C,status:"finished",winner:O.winner,isDraw:O.isDraw}:C={...C,currentTurn:c.getNextTurn(C)},C.updatedAt=Date.now(),a({activeGame:C}),n(p,{type:"game_state_sync",sessionId:d.id,state:C})}else n(p,{type:"game_action",sessionId:d.id,action:i})}},restartGame:()=>{const e=s(),{sendMessage:t,myId:n}=pe.getState(),{activeGame:r}=e;if(!r||!n)return;const d=te.createInstance(r.gameType);if(!d)return;const c=n===r.hostId?r.guestId:r.hostId,u=d.createInitialState(r.hostId,r.guestId),p={...r,status:"playing",currentTurn:r.hostId,winner:null,isDraw:!1,data:u,updatedAt:Date.now()};a({activeGame:p}),t(c,{type:"game_state_sync",sessionId:r.id,state:p})},leaveGame:()=>{const e=s(),{sendMessage:t,myId:n}=pe.getState(),{activeGame:r}=e;if(!r||!n){a({activeGame:null});return}const d=n===r.hostId?r.guestId:r.hostId;t(d,{type:"game_leave",sessionId:r.id}),a({activeGame:null})},handleGameMessage:(e,t)=>{const n=s(),{sendMessage:r,myId:d}=pe.getState();switch(t.type){case"game_invite":{n.addPendingInvite({sessionId:t.sessionId,gameType:t.gameType,hostId:t.hostId,receivedAt:Date.now()});break}case"game_accept":{const{activeGame:c}=n;if(!c||c.id!==t.sessionId||!d)break;const u=te.createInstance(c.gameType);if(!u)break;const p=u.createInitialState(d,c.guestId),i={...c,status:"playing",data:p,updatedAt:Date.now()};a({activeGame:i}),r(c.guestId,{type:"game_state_sync",sessionId:c.id,state:i});break}case"game_decline":{const{activeGame:c}=n;(c==null?void 0:c.id)===t.sessionId&&a({activeGame:null});break}case"game_action":{const{activeGame:c}=n;if(!c||c.id!==t.sessionId||!d||d!==c.hostId)break;const u=te.createInstance(c.gameType),p=te.getDefinition(c.gameType);if(!u||p!=null&&p.isRealTime)break;const i=t.action;if(!u.isValidMove(c,i)){console.warn("Invalid move from guest");break}let g=u.applyMove(c,i);const C=u.checkGameEnd(g);C.isEnded?g={...g,status:"finished",winner:C.winner,isDraw:C.isDraw}:g={...g,currentTurn:u.getNextTurn(g)},g.updatedAt=Date.now(),a({activeGame:g}),r(c.guestId,{type:"game_state_sync",sessionId:c.id,state:g});break}case"game_state_sync":{const{activeGame:c}=n;if(!c||c.id!==t.sessionId)break;a({activeGame:t.state});break}case"game_realtime_action":{const{activeGame:c}=n;if(!c||c.id!==t.sessionId)break;const u=te.createInstance(c.gameType);if(!u)break;const p=t.action;let i=u.applyAction(c,p);if(typeof u.checkGameEnd=="function"){const g=u.checkGameEnd(i);g.isEnded&&(i={...i,status:"finished",winner:g.winner,isDraw:g.isDraw})}i.updatedAt=Date.now(),a({activeGame:i});break}case"game_leave":{const{activeGame:c}=n;(c==null?void 0:c.id)===t.sessionId&&a({activeGame:{...c,status:"cancelled"}});break}}}}));function cn(){var Fe,Ye;const{chats:a,setChats:s,isStorageReady:e,setIsStorageReady:t,setTypingStates:n,setSessions:r,activeSessionId:d,setActiveSessionId:c,peerConfig:u,setPeerConfig:p,selectedPeerId:i,setSelectedPeerId:g,showMobileDashboard:C,showSettings:O,pendingConnectPeerId:x,setPendingConnectPeerId:R}=Vt(),{handleGameMessage:V}=ve(),[Q,U]=m.useState("idle"),[L,k]=m.useState(null),[D,j]=m.useState(null),[y,N]=m.useState(null),[b,A]=m.useState(null),[_,ne]=m.useState(null),[le,he]=m.useState(null),ge=m.useRef(new Map),v=m.useRef("");m.useEffect(()=>{v.current=d},[d]);const f=m.useRef(()=>!1),P=m.useRef(async()=>!1),W=m.useRef(async()=>null),ee=m.useRef(()=>{}),ie=m.useRef(()=>!1);m.useEffect(()=>{(async()=>{try{await Kt();let o=Lt(),M=$t();if(o.length===0){const K=Se(),$={id:K,createdAt:Date.now()};Qe($),Ne(K),o=[$],M=K}else(!M||!o.find(K=>K.id===M))&&(M=o[0].id,Ne(M));r(o),c(M);const G=await qe(M);s(G)}catch(o){console.error("Failed to init storage:",o)}finally{t(!0)}})()},[]);const ce=h=>{p(h)},J=m.useCallback((h,o)=>{if(o&&typeof o=="object"&&o.type==="typing"){n(S=>({...S,[h]:o.isTyping}));return}if(o&&typeof o=="object"&&o.type==="presence")return;if(o&&typeof o=="object"&&o.type==="key_exchange"){const S=ie.current(h);P.current(h,o).then(w=>{w&&(console.log("Key exchange completed with",h),S||W.current().then(I=>{I&&f.current(h,{type:"key_exchange",...I})}))});return}if(o&&typeof o=="object"&&o.type==="encrypted_message"){Oe.current(h,o.payload).then(S=>{if(S)try{const w=JSON.parse(S);ee.current(h,{...w,_encrypted:!0})}catch{console.error("Failed to parse decrypted message")}});return}if(o&&typeof o=="object"&&o.type==="receipt"){const{messageId:S,status:w,timestamp:I}=o;s(T=>{const E=T[h];if(!E)return T;const Y=E.messages.map(H=>{if(H.id===S){if(w==="delivered")return{...H,status:"delivered",receivedAt:I};if(w==="read")return{...H,status:"read",readAt:I}}return H}),B={...E,messages:Y};return re(v.current,B),{...T,[h]:B}});return}if(o&&typeof o=="object"&&o.type==="file_start"){const{fileId:S,fileName:w,fileSize:I,mimeType:T,totalChunks:E,messageType:Y}=o,B={id:S,fileName:w,fileSize:I,mimeType:T,totalChunks:E,receivedChunks:new Map,progress:0,messageType:Y||"file"};ge.current.set(S,B),he({fileId:S,fileName:w,progress:0});return}if(o&&typeof o=="object"&&o.type==="file_chunk"){const{fileId:S,chunkIndex:w,data:I}=o,T=ge.current.get(S);if(!T)return;T.receivedChunks.set(w,I);const E=Math.round(T.receivedChunks.size/T.totalChunks*100);T.progress=E,he({fileId:S,fileName:T.fileName,progress:E});return}if(o&&typeof o=="object"&&o.type==="file_end"){const{fileId:S}=o,w=ge.current.get(S);if(!w)return;const I=[];for(let Y=0;Y<w.totalChunks;Y++){const B=w.receivedChunks.get(Y);B&&I.push(B)}const T=new Blob(I),E={id:Se(),senderId:h,content:w.fileName,timestamp:Date.now(),receivedAt:Date.now(),status:"delivered",type:w.messageType,file:{name:w.fileName,size:w.fileSize,mimeType:w.mimeType,data:T}};s(Y=>{const B=Y[h]||{peerId:h,messages:[],lastUpdated:Date.now(),unreadCount:0},H={...B,messages:[...B.messages,E],lastUpdated:Date.now(),unreadCount:i===h?0:B.unreadCount+1};return re(v.current,H),{...Y,[h]:H}}),f.current(h,{type:"receipt",messageId:E.id,status:"delivered",timestamp:Date.now()}),ge.current.delete(S),he(null);return}if(o&&typeof o=="object"&&o.type==="sync_request"){U("incoming"),k(h);return}if(o&&typeof o=="object"&&o.type==="sync_reject"){U("idle"),k(null),alert(`${h} declined the sync request.`);return}if(o&&typeof o=="object"&&o.type==="sync_cancel"){U("idle"),k(null);return}if(o&&typeof o=="object"&&(o.type==="sync_data_initial"||o.type==="sync_data_final")){const S=o.messages;if(!Array.isArray(S))return;s(w=>{const I=w[h]||{peerId:h,messages:[],lastUpdated:Date.now(),unreadCount:0},T=new Set(I.messages.map(H=>H.id)),E=S.filter(H=>!T.has(H.id));if(E.length===0&&o.type==="sync_data_final")return w;const Y=[...I.messages,...E].sort((H,yt)=>H.timestamp-yt.timestamp),B={...I,messages:Y};return re(v.current,B),o.type==="sync_data_initial"&&f.current(h,{type:"sync_data_final",messages:Y}),{...w,[h]:B}}),j({phase:o.type==="sync_data_initial"?"Receiving":"Merging",count:S.length}),setTimeout(()=>{U("idle"),k(null),j(null)},500);return}const M=o.id||Se(),G=o.timestamp||Date.now(),K=o._encrypted===!0;let $;typeof o=="string"?$={id:M,senderId:h,content:o,timestamp:G,receivedAt:Date.now(),status:"delivered",type:"text",encrypted:!1}:$={id:M,senderId:h,content:o.content||"",timestamp:G,receivedAt:Date.now(),status:"delivered",type:o.type||"text",file:o.file,encrypted:K},!(!$.content&&!$.file)&&(f.current(h,{type:"receipt",messageId:M,status:"delivered",timestamp:Date.now()}),s(S=>{const w=S[h]||{peerId:h,messages:[],lastUpdated:Date.now(),unreadCount:0},I={...w,messages:[...w.messages,$],lastUpdated:Date.now(),unreadCount:i===h?0:w.unreadCount+1},T={...S,[h]:I};return re(v.current,I),T}))},[i]),se=m.useCallback(h=>{s(o=>{if(!o[h]){const M={peerId:h,messages:[],lastUpdated:Date.now(),unreadCount:0};return re(v.current,M),{...o,[h]:M}}return o}),W.current().then(o=>{o&&f.current(h,{type:"key_exchange",...o})}),window.innerWidth>=768&&!i&&g(h)},[i]),X=m.useCallback(h=>{n(o=>({...o,[h]:!1}))},[]),{myId:F,isReady:oe,isReconnecting:ye,peerError:Ge,connectionStates:De,activeConnectionsCount:we,connectToPeer:ue,disconnectPeer:Ie,sendMessage:z,updateId:Me,initPeer:Z,addListener:fe}=pe();m.useEffect(()=>{const h=M=>{var K;const G=((K=a[M])==null?void 0:K.name)||M.slice(0,8);N(`Disconnected "${G}" - max ${et} connections reached`),setTimeout(()=>N(null),4e3)},o=[fe("message",J),fe("message",V),fe("connectionOpened",se),fe("connectionClosed",X),fe("connectionLimitExceeded",h)];return()=>o.forEach(M=>M())},[J,se,X,a,fe]),m.useEffect(()=>{d&&e&&Z(d,u)},[d,u,e,Z]);const{myFingerprint:at,createKeyExchange:Le,handleKeyExchange:$e,encrypt:Ce,decrypt:je,getPeerFingerprint:rt,hasPeerKey:ke,markPeerVerified:ot,exportMyKeys:it,importMyKeys:ct}=Ut({sessionId:d,onKeyChange:(h,o,M)=>{A({peerId:h,oldFingerprint:o,newFingerprint:M})}}),lt=m.useRef(Ce),Oe=m.useRef(je);m.useEffect(()=>{lt.current=Ce,Oe.current=je,P.current=$e,W.current=Le,ie.current=ke},[Ce,je,$e,Le,ke]),m.useEffect(()=>{f.current=z},[z]),m.useEffect(()=>{ee.current=J},[J]),m.useEffect(()=>{oe&&x&&x!==F&&(console.log("Auto-connecting to peer from URL:",x),ue(x),g(x),R(null))},[oe,x,F,ue]);const dt=async h=>{if(!i)return;const o=Se(),M=Date.now();let G={id:o,timestamp:M};typeof h=="string"?(G.content=h,G.type="text"):G={...G,...h};const K=ke(i);let $=!1,S=!1;if(K){const w=await Ce(i,JSON.stringify(G));w?($=z(i,{type:"encrypted_message",payload:w}),S=!0):$=z(i,G)}else $=z(i,G);if($){const w={id:o,senderId:F,content:G.content||"",timestamp:M,status:"sent",type:G.type,file:G.file,encrypted:S};s(I=>{const T=I[i]||{peerId:i,messages:[],lastUpdated:Date.now(),unreadCount:0},E={...T,messages:[...T.messages,w],lastUpdated:Date.now()},Y={...I,[i]:E};return re(v.current,E),Y}),setTimeout(()=>{s(I=>{const T=I[i];if(!T)return I;const E=T.messages.find(Y=>Y.id===o);if(E&&E.status==="sent"){const Y=T.messages.map(H=>H.id===o?{...H,status:"failed"}:H),B={...T,messages:Y};return re(v.current,B),{...I,[i]:B}}return I})},1e4)}else{const w={id:o,senderId:F,content:G.content||"",timestamp:M,status:"failed",type:G.type,file:G.file};s(I=>{const T=I[i]||{peerId:i,messages:[],lastUpdated:Date.now(),unreadCount:0},E={...T,messages:[...T.messages,w],lastUpdated:Date.now()},Y={...I,[i]:E};return re(v.current,E),Y})}},ut=async(h,o,M)=>{if(!i)return;const G=Math.ceil(o.size/_e),K=await o.arrayBuffer();z(i,{type:"file_start",fileId:h,fileName:o.name,fileSize:o.size,mimeType:o.type,totalChunks:G,messageType:M});const $={id:h,senderId:F,content:o.name,timestamp:Date.now(),status:"sending",type:M,file:{name:o.name,size:o.size,mimeType:o.type,data:new Blob([K])}};s(S=>{const w=S[i]||{peerId:i,messages:[],lastUpdated:Date.now(),unreadCount:0},I={...w,messages:[...w.messages,$],lastUpdated:Date.now()};return{...S,[i]:I}});for(let S=0;S<G;S++){const w=S*_e,I=Math.min(w+_e,o.size),T=K.slice(w,I);z(i,{type:"file_chunk",fileId:h,chunkIndex:S,data:T});const E=Math.round((S+1)/G*100);ne({fileId:h,progress:E}),await new Promise(Y=>setTimeout(Y,10))}z(i,{type:"file_end",fileId:h}),s(S=>{const w=S[i];if(!w)return S;const I=w.messages.map(E=>E.id===h?{...E,status:"sent"}:E),T={...w,messages:I};return re(v.current,T),{...S,[i]:T}}),ne(null)},ft=h=>{if(!i)return;const o=a[i];if(!o)return;const M=o.messages.find(K=>K.id===h);if(!M||M.status!=="failed")return;z(i,{id:M.id,content:M.content,timestamp:M.timestamp})&&(s(K=>{const $=K[i];if(!$)return K;const S=$.messages.map(I=>I.id===h?{...I,status:"sent"}:I),w={...$,messages:S};return re(v.current,w),{...K,[i]:w}}),setTimeout(()=>{s(K=>{const $=K[i];if(!$)return K;const S=$.messages.find(w=>w.id===h);if(S&&S.status==="sent"){const w=$.messages.map(T=>T.id===h?{...T,status:"failed"}:T),I={...$,messages:w};return re(v.current,I),{...K,[i]:I}}return K})},1e4))},mt=()=>{i&&(z(i,{type:"sync_request"}),U("outgoing"),k(i))},pt=()=>{L&&z(L,{type:"sync_cancel"}),U("idle"),k(null)},ht=()=>{if(!L)return;const h=a[L],o=h?h.messages:[];U("outgoing"),j({phase:"Sending",count:o.length}),z(L,{type:"sync_data_initial",messages:o}),setTimeout(()=>{U("idle"),k(null),j(null)},800)},gt=()=>{L&&(z(L,{type:"sync_reject"}),U("idle"),k(null))};return e?l.jsxs("div",{className:"flex h-screen overflow-hidden bg-slate-950 text-slate-100 font-sans selection:bg-primary-500/30 relative",children:[y&&l.jsx("div",{className:"absolute bottom-20 left-1/2 -translate-x-1/2 z-50 animate-in fade-in slide-in-from-bottom-4",children:l.jsxs("div",{className:"bg-yellow-500/10 border border-yellow-500/50 backdrop-blur-md text-yellow-200 px-4 py-3 rounded-lg shadow-xl flex items-center gap-3",children:[l.jsx("span",{className:"text-sm font-medium",children:y}),l.jsx("button",{onClick:()=>N(null),className:"p-1 hover:bg-yellow-500/20 rounded-full transition-colors",children:l.jsx(Pe,{className:"w-4 h-4"})})]})}),l.jsx("div",{className:`
        ${i||C?"hidden md:flex":"flex"}
        w-full md:w-80 flex-col border-r border-slate-800
      `,children:l.jsx(Ot,{})}),l.jsx("div",{className:`
        ${i||C?"flex":"hidden md:flex"}
        flex-1 flex-col min-w-0 bg-slate-950
      `,children:l.jsx(Ft,{onSendMessage:dt,onResendMessage:ft,onRequestSync:mt,onSendFileChunked:ut,sendingProgress:_,receivingProgress:le,peerFingerprint:i?rt(i):null,isEncrypted:i?ke(i):!1})}),l.jsx(Wt,{status:Q,targetPeerId:L,peerName:L?(Fe=a[L])==null?void 0:Fe.name:void 0,progress:D,onCancel:pt,onAccept:ht,onReject:gt}),O&&l.jsx(Yt,{config:u,onSave:ce,myFingerprint:at,onExportKeys:it,onImportKeys:ct}),l.jsx(Xt,{warning:b,peerName:b?(Ye=a[b.peerId])==null?void 0:Ye.name:void 0,onDisconnect:()=>{b&&(Ie(b.peerId),A(null))},onTrust:()=>{b&&(ot(b.peerId),A(null))}})]}):l.jsx("div",{className:"h-screen w-screen flex items-center justify-center bg-slate-950 text-white",children:"Initializing..."})}const st=document.getElementById("root");if(!st)throw new Error("Could not find root element to mount to");const ln=Pt.createRoot(st);ln.render(l.jsx(be.StrictMode,{children:l.jsx(cn,{})}));export{Te as D,_e as F,Pn as M,pe as a,ve as b,kn as c,Cn as d,te as g,Vt as u};
