import{r as c,$ as Le,j as o,X as me,R as $e,v as Ie,y as qe,z as We}from"./vendor-D-SuBDzD.js";import{a as Ge,g as F,s as fe,b as Je,c as Xe,d as pe,e as te,f as Ke}from"./services/storage-zbee7ku7.js";import{s as R,i as Ze,g as ge,d as He,a as Ye}from"./services/db-C_AZMdlw.js";import{C as Qe}from"./components/chatsidebar-Btx7hkR4.js";import{C as Ve}from"./components/chatwindow-BLGDwyLa.js";import{S as et}from"./components/settingsmodal-BG3jvEUU.js";import"./index-Crz8AdiB.js";import"./components/sessionswitcher-c47p_zF3.js";(function(){const p=document.createElement("link").relList;if(p&&p.supports&&p.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))z(s);new MutationObserver(s=>{for(const y of s)if(y.type==="childList")for(const P of y.addedNodes)P.tagName==="LINK"&&P.rel==="modulepreload"&&z(P)}).observe(document,{childList:!0,subtree:!0});function W(s){const y={};return s.integrity&&(y.integrity=s.integrity),s.referrerPolicy&&(y.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?y.credentials="include":s.crossOrigin==="anonymous"?y.credentials="omit":y.credentials="same-origin",y}function z(s){if(s.ep)return;s.ep=!0;const y=W(s);fetch(s.href,y)}})();function ft(S){return S&&S.__esModule&&Object.prototype.hasOwnProperty.call(S,"default")?S.default:S}const he={host:"fbaio.xyz",port:443,path:"/peer",secure:!0,debug:3},tt=50,st=({config:S=he,onMessageReceived:p,onConnectionOpened:W,onConnectionClosed:z,onConnectionLimitExceeded:s})=>{const[y,P]=c.useState(""),[C,H]=c.useState(null),w=c.useRef(new Map),A=c.useRef([]),[K,E]=c.useState({}),[B,G]=c.useState(!1),[Z,J]=c.useState(null),[Y,L]=c.useState(null),M=(n,i)=>{E(g=>({...g,[n]:i}))},$=c.useCallback(n=>{M(n.peer,"connecting"),n.on("open",()=>{if(w.current.size>=tt){const i=A.current[0];if(i){const g=w.current.get(i);g&&g.close(),w.current.delete(i),A.current=A.current.filter(D=>D!==i),M(i,"disconnected"),z(i),s&&s(i)}}w.current.set(n.peer,n),A.current.push(n.peer),M(n.peer,"connected"),W(n.peer),n.send({type:"presence",status:"online"})}),n.on("data",i=>{i&&typeof i=="object"&&i.type==="presence"||p(n.peer,i)}),n.on("close",()=>{w.current.delete(n.peer),A.current=A.current.filter(i=>i!==n.peer),M(n.peer,"disconnected"),z(n.peer)}),n.on("error",i=>{console.error("Connection-specific error:",i),w.current.delete(n.peer),M(n.peer,"failed")})},[W,z,p]);c.useCallback(()=>{C&&(C.destroy(),H(null)),w.current.clear(),E({}),G(!1)},[C]);const N=c.useCallback(n=>{const i=window.Peer||Le,g=new i(n,{host:S.host,port:S.port,path:S.path,secure:S.secure,debug:S.debug||0});return g.on("open",D=>{console.log("My Peer ID is: "+D),G(!0),J(null)}),g.on("connection",D=>{$(D)}),g.on("error",D=>{if(console.error("PeerJS error:",D),D.type==="unavailable-id")J("ID is already taken. Please choose another."),G(!1);else if(D.type==="peer-unavailable"){const U=(D.message||"").match(/Could not connect to peer (.*)/);U&&U[1]?(M(U[1],"failed"),L(`User '${U[1]}' not found or offline.`)):L("Peer not found or offline.")}else J("Connection error: "+(D.message||"Unknown error"))}),H(g),g},[$]);c.useEffect(()=>{let n=Ge();n||(n=F(),fe(n)),P(n),P(n);const i=N(n),g=()=>{i==null||i.destroy()};return window.addEventListener("beforeunload",g),()=>{window.removeEventListener("beforeunload",g),i==null||i.destroy()}},[S]);const v=c.useCallback(n=>{!n||n===y||(C&&C.destroy(),w.current.clear(),E({}),G(!1),J(null),L(null),fe(n),P(n),N(n))},[y,C,N]),T=c.useCallback(n=>{if(!(!C||!B)){if(w.current.has(n)){const i=w.current.get(n);if(i!=null&&i.open){M(n,"connected");return}}M(n,"connecting");try{const i=C.connect(n,{reliable:!0});$(i),setTimeout(()=>{E(g=>g[n]==="connecting"?{...g,[n]:"failed"}:g)},1e4)}catch(i){console.error("Connect error",i),M(n,"failed")}}},[C,B,$]),I=c.useCallback(n=>{const i=w.current.get(n);i&&(i.close(),w.current.delete(n)),M(n,"disconnected")},[]),X=c.useCallback((n,i)=>{const g=w.current.get(n);return g&&g.open?(g.send(i),!0):!1},[]);return{myId:y,isReady:B,peerError:Z,connectionError:Y,resetConnectionError:()=>L(null),connectionStates:K,activeConnectionsCount:Array.from(w.current.values()).filter(n=>n==null?void 0:n.open).length,connectToPeer:T,disconnectPeer:I,sendMessage:X,updateId:v}},ne=64*1024,pt=50*1024*1024;function nt(){var ue;const[S,p]=c.useState({}),[W,z]=c.useState(!1),[s,y]=c.useState(null),[P,C]=c.useState(!1),[H,w]=c.useState({}),[A,K]=c.useState([]),[E,B]=c.useState(""),[G,Z]=c.useState(!1),[J,Y]=c.useState(!1),[L,M]=c.useState(()=>{const t=localStorage.getItem("peer_config");return t?JSON.parse(t):he}),[$,N]=c.useState("idle"),[v,T]=c.useState(null),[I,X]=c.useState(null),[se,n]=c.useState(null),[i,g]=c.useState(null),[D,Q]=c.useState(null),U=c.useRef(new Map),j=c.useRef("");c.useEffect(()=>{j.current=E},[E]);const V=c.useRef(()=>!1);c.useEffect(()=>{(async()=>{try{await Ze();let e=Je(),d=Xe();if(e.length===0){const f=F(),u={id:f,createdAt:Date.now()};pe(u),te(f),e=[u],d=f}else(!d||!e.find(f=>f.id===d))&&(d=e[0].id,te(d));K(e),B(d);const h=await ge(d);p(h)}catch(e){console.error("Failed to init storage:",e)}finally{z(!0)}})()},[]);const xe=t=>{M(t),localStorage.setItem("peer_config",JSON.stringify(t))},Se=c.useCallback((t,e)=>{if(e&&typeof e=="object"&&e.type==="typing"){w(u=>({...u,[t]:e.isTyping}));return}if(e&&typeof e=="object"&&e.type==="presence")return;if(e&&typeof e=="object"&&e.type==="receipt"){const{messageId:u,status:r,timestamp:a}=e;p(l=>{const m=l[t];if(!m)return l;const x=m.messages.map(k=>{if(k.id===u){if(r==="delivered")return{...k,status:"delivered",receivedAt:a};if(r==="read")return{...k,status:"read",readAt:a}}return k}),b={...m,messages:x};return R(j.current,b),{...l,[t]:b}});return}if(e&&typeof e=="object"&&e.type==="file_start"){const{fileId:u,fileName:r,fileSize:a,mimeType:l,totalChunks:m,messageType:x}=e,b={id:u,fileName:r,fileSize:a,mimeType:l,totalChunks:m,receivedChunks:new Map,progress:0,messageType:x||"file"};U.current.set(u,b),Q({fileId:u,fileName:r,progress:0});return}if(e&&typeof e=="object"&&e.type==="file_chunk"){const{fileId:u,chunkIndex:r,data:a}=e,l=U.current.get(u);if(!l)return;l.receivedChunks.set(r,a);const m=Math.round(l.receivedChunks.size/l.totalChunks*100);l.progress=m,Q({fileId:u,fileName:l.fileName,progress:m});return}if(e&&typeof e=="object"&&e.type==="file_end"){const{fileId:u}=e,r=U.current.get(u);if(!r)return;const a=[];for(let x=0;x<r.totalChunks;x++){const b=r.receivedChunks.get(x);b&&a.push(b)}const l=new Blob(a),m={id:F(),senderId:t,content:r.fileName,timestamp:Date.now(),receivedAt:Date.now(),status:"delivered",type:r.messageType,file:{name:r.fileName,size:r.fileSize,mimeType:r.mimeType,data:l}};p(x=>{const b=x[t]||{peerId:t,messages:[],lastUpdated:Date.now(),unreadCount:0},k={...b,messages:[...b.messages,m],lastUpdated:Date.now(),unreadCount:s===t?0:b.unreadCount+1};return R(j.current,k),{...x,[t]:k}}),V.current(t,{type:"receipt",messageId:m.id,status:"delivered",timestamp:Date.now()}),U.current.delete(u),Q(null);return}if(e&&typeof e=="object"&&e.type==="sync_request"){N("incoming"),T(t);return}if(e&&typeof e=="object"&&e.type==="sync_reject"){N("idle"),T(null),alert(`${t} declined the sync request.`);return}if(e&&typeof e=="object"&&e.type==="sync_cancel"){N("idle"),T(null);return}if(e&&typeof e=="object"&&(e.type==="sync_data_initial"||e.type==="sync_data_final")){const u=e.messages;if(!Array.isArray(u))return;p(r=>{const a=r[t]||{peerId:t,messages:[],lastUpdated:Date.now(),unreadCount:0},l=new Set(a.messages.map(k=>k.id)),m=u.filter(k=>!l.has(k.id));if(m.length===0&&e.type==="sync_data_final")return r;const x=[...a.messages,...m].sort((k,Be)=>k.timestamp-Be.timestamp),b={...a,messages:x};return R(j.current,b),e.type==="sync_data_initial"&&V.current(t,{type:"sync_data_final",messages:x}),{...r,[t]:b}}),X({phase:e.type==="sync_data_initial"?"Receiving":"Merging",count:u.length}),setTimeout(()=>{N("idle"),T(null),X(null)},500);return}const d=e.id||F(),h=e.timestamp||Date.now();let f;typeof e=="string"?f={id:d,senderId:t,content:e,timestamp:h,receivedAt:Date.now(),status:"delivered",type:"text"}:f={id:d,senderId:t,content:e.content||"",timestamp:h,receivedAt:Date.now(),status:"delivered",type:e.type||"text",file:e.file},!(!f.content&&!f.file)&&(V.current(t,{type:"receipt",messageId:d,status:"delivered",timestamp:Date.now()}),p(u=>{const r=u[t]||{peerId:t,messages:[],lastUpdated:Date.now(),unreadCount:0},a={...r,messages:[...r.messages,f],lastUpdated:Date.now(),unreadCount:s===t?0:r.unreadCount+1},l={...u,[t]:a};return R(j.current,a),l}))},[s]),be=c.useCallback(t=>{p(e=>{if(!e[t]){const d={peerId:t,messages:[],lastUpdated:Date.now(),unreadCount:0};return R(j.current,d),{...e,[t]:d}}return e}),window.innerWidth>=768&&y(e=>e||t)},[]),we=c.useCallback(t=>{w(e=>({...e,[t]:!1}))},[]),{myId:q,activeConnectionsCount:Ce,connectToPeer:oe,disconnectPeer:re,sendMessage:_,updateId:O,peerError:ae,connectionError:ie,resetConnectionError:je,isReady:ce,connectionStates:ee}=st({config:L,onMessageReceived:Se,onConnectionOpened:be,onConnectionClosed:we,onConnectionLimitExceeded:t=>{var d;const e=((d=S[t])==null?void 0:d.name)||t.slice(0,8);n(`Disconnected "${e}" - max 5 connections reached`),setTimeout(()=>n(null),4e3)}});c.useEffect(()=>{V.current=_},[_]);const Ne=t=>{if(!s)return;const e=F(),d=Date.now();let h={id:e,timestamp:d};if(typeof t=="string"?(h.content=t,h.type="text"):h={...h,...t},_(s,h)){const u={id:e,senderId:q,content:h.content||"",timestamp:d,status:"sent",type:h.type,file:h.file};p(r=>{const a=r[s]||{peerId:s,messages:[],lastUpdated:Date.now(),unreadCount:0},l={...a,messages:[...a.messages,u],lastUpdated:Date.now()},m={...r,[s]:l};return R(j.current,l),m}),setTimeout(()=>{p(r=>{const a=r[s];if(!a)return r;const l=a.messages.find(m=>m.id===e);if(l&&l.status==="sent"){const m=a.messages.map(b=>b.id===e?{...b,status:"failed"}:b),x={...a,messages:m};return R(j.current,x),{...r,[s]:x}}return r})},1e4)}else{const u={id:e,senderId:q,content:h.content||"",timestamp:d,status:"failed",type:h.type,file:h.file};p(r=>{const a=r[s]||{peerId:s,messages:[],lastUpdated:Date.now(),unreadCount:0},l={...a,messages:[...a.messages,u],lastUpdated:Date.now()},m={...r,[s]:l};return R(j.current,l),m})}},ve=async(t,e,d)=>{if(!s)return;const h=Math.ceil(e.size/ne),f=await e.arrayBuffer();_(s,{type:"file_start",fileId:t,fileName:e.name,fileSize:e.size,mimeType:e.type,totalChunks:h,messageType:d});const u={id:t,senderId:q,content:e.name,timestamp:Date.now(),status:"sending",type:d,file:{name:e.name,size:e.size,mimeType:e.type,data:new Blob([f])}};p(r=>{const a=r[s]||{peerId:s,messages:[],lastUpdated:Date.now(),unreadCount:0},l={...a,messages:[...a.messages,u],lastUpdated:Date.now()};return{...r,[s]:l}});for(let r=0;r<h;r++){const a=r*ne,l=Math.min(a+ne,e.size),m=f.slice(a,l);_(s,{type:"file_chunk",fileId:t,chunkIndex:r,data:m});const x=Math.round((r+1)/h*100);g({fileId:t,progress:x}),await new Promise(b=>setTimeout(b,10))}_(s,{type:"file_end",fileId:t}),p(r=>{const a=r[s];if(!a)return r;const l=a.messages.map(x=>x.id===t?{...x,status:"sent"}:x),m={...a,messages:l};return R(j.current,m),{...r,[s]:m}}),g(null)},De=t=>{s&&_(s,{type:"typing",isTyping:t})},ke=t=>{if(!s)return;const e=S[s];if(!e)return;const d=e.messages.find(f=>f.id===t);if(!d||d.status!=="failed")return;_(s,{id:d.id,content:d.content,timestamp:d.timestamp})&&(p(f=>{const u=f[s];if(!u)return f;const r=u.messages.map(l=>l.id===t?{...l,status:"sent"}:l),a={...u,messages:r};return R(j.current,a),{...f,[s]:a}}),setTimeout(()=>{p(f=>{const u=f[s];if(!u)return f;const r=u.messages.find(a=>a.id===t);if(r&&r.status==="sent"){const a=u.messages.map(m=>m.id===t?{...m,status:"failed"}:m),l={...u,messages:a};return R(j.current,l),{...f,[s]:l}}return f})},1e4))},Me=()=>{s&&(_(s,{type:"sync_request"}),N("outgoing"),T(s))},_e=()=>{v&&_(v,{type:"sync_cancel"}),N("idle"),T(null)},Re=()=>{if(!v)return;const t=S[v],e=t?t.messages:[];N("outgoing"),X({phase:"Sending",count:e.length}),_(v,{type:"sync_data_initial",messages:e}),setTimeout(()=>{N("idle"),T(null),X(null)},800)},Pe=()=>{v&&(_(v,{type:"sync_reject"}),N("idle"),T(null))},le=t=>{oe(t),y(t),C(!1)},Ee=()=>{s&&confirm("Are you sure you want to delete this conversation?")&&(re(s),p(t=>{const e={...t};return delete e[s],He(j.current,s),e}),y(null))},de=(t,e)=>{p(d=>{const h=d[t];if(!h)return d;const f={...h,name:e.trim()===""?void 0:e.trim()};return R(j.current,f),{...d,[t]:f}})},Te=()=>{y(null),C(!1)},Ae=async t=>{if(t!==E){y(null),p({}),te(t),B(t),O(t);try{const e=await ge(t);p(e)}catch(e){console.error("Failed to load chats for session:",e)}}},Ue=()=>{Z(!0)},ze=async()=>{const t=F(),e={id:t,createdAt:Date.now()};pe(e);const d=[...A,e];K(d),te(t),B(t),O(t),p({}),y(null),Z(!1)},Oe=async t=>{if(t!==E){Ke(t);try{await Ye(t)}catch(e){console.error("Failed to delete chats for session:",e)}K(e=>e.filter(d=>d.id!==t))}},Fe=Object.keys(ee).filter(t=>ee[t]==="connected");return W?o.jsxs("div",{className:"flex h-screen overflow-hidden bg-slate-950 text-slate-100 font-sans selection:bg-primary-500/30 relative",children:[ie&&o.jsx("div",{className:"absolute bottom-6 left-1/2 -translate-x-1/2 z-50 animate-in fade-in slide-in-from-bottom-4",children:o.jsxs("div",{className:"bg-red-500/10 border border-red-500/50 backdrop-blur-md text-red-200 px-4 py-3 rounded-lg shadow-xl flex items-center gap-3",children:[o.jsx("span",{className:"text-sm font-medium",children:ie}),o.jsx("button",{onClick:je,className:"p-1 hover:bg-red-500/20 rounded-full transition-colors",children:o.jsx(me,{className:"w-4 h-4"})})]})}),se&&o.jsx("div",{className:"absolute bottom-20 left-1/2 -translate-x-1/2 z-50 animate-in fade-in slide-in-from-bottom-4",children:o.jsxs("div",{className:"bg-yellow-500/10 border border-yellow-500/50 backdrop-blur-md text-yellow-200 px-4 py-3 rounded-lg shadow-xl flex items-center gap-3",children:[o.jsx("span",{className:"text-sm font-medium",children:se}),o.jsx("button",{onClick:()=>n(null),className:"p-1 hover:bg-yellow-500/20 rounded-full transition-colors",children:o.jsx(me,{className:"w-4 h-4"})})]})}),o.jsx("div",{className:`
        ${s||P?"hidden md:flex":"flex"}
        w-full md:w-80 flex-col border-r border-slate-800
      `,children:o.jsx(Qe,{myId:q,chats:S,activeConnections:Fe,selectedPeerId:s,onSelectPeer:t=>{y(t),C(!1),ee[t]!=="connected"&&oe(t)},onConnect:le,onUpdateId:O,onRenameChat:de,onShowDashboard:()=>C(!0),peerError:ae,isReady:ce,onRetry:()=>O(q),onRandomId:()=>O(F()),onOpenSettings:()=>Y(!0),sessions:A,activeSessionId:E,onSwitchSession:Ae,onCreateNewSession:Ue,onDeleteSession:Oe})}),o.jsx("div",{className:`
        ${s||P?"flex":"hidden md:flex"}
        flex-1 flex-col min-w-0 bg-slate-950
      `,children:o.jsx(Ve,{myId:q,peerId:s||"",session:s?S[s]:void 0,connectionState:s&&ee[s]||"disconnected",onSendMessage:Ne,onDeleteChat:Ee,onBack:Te,onConnect:()=>s&&le(s),onCancelConnection:()=>s&&re(s),isReady:ce,activeConnectionsCount:Ce,totalChats:Object.keys(S).length,isPeerTyping:s?H[s]:!1,onTyping:De,peerError:ae,onRetry:()=>O(q),onRandomId:()=>O(F()),onUpdateId:O,onRenameChat:t=>s&&de(s,t),onResendMessage:ke,onRequestSync:Me,onSendFileChunked:ve,sendingProgress:i,receivingProgress:D})}),$==="outgoing"&&o.jsx("div",{className:"fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4",children:o.jsxs("div",{className:"bg-slate-900 border border-slate-700 rounded-xl p-6 max-w-sm w-full shadow-xl",children:[o.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[o.jsx("div",{className:"animate-spin",children:o.jsx($e,{className:"w-6 h-6 text-primary-400"})}),o.jsxs("div",{children:[o.jsx("h3",{className:"text-lg font-medium text-white",children:I?I.phase:"Waiting for confirmation..."}),I&&o.jsxs("p",{className:"text-sm text-slate-400",children:[I.count," messages"]})]})]}),I?o.jsx("div",{className:"mb-4",children:o.jsx("div",{className:"h-2 bg-slate-700 rounded-full overflow-hidden",children:o.jsx("div",{className:"h-full bg-primary-500 animate-pulse w-full"})})}):o.jsx("p",{className:"text-slate-400 mb-4",children:"Asking peer to authorize history sync."}),o.jsx("button",{onClick:_e,className:"w-full py-2 bg-slate-800 hover:bg-slate-700 text-white rounded-lg transition-colors",children:"Cancel"})]})}),$==="incoming"&&o.jsx("div",{className:"fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4",children:o.jsxs("div",{className:"bg-slate-900 border border-slate-700 rounded-xl p-6 max-w-sm w-full shadow-xl",children:[o.jsx("h3",{className:"text-lg font-medium text-white mb-2",children:"Sync Request"}),o.jsxs("p",{className:"text-slate-400 mb-6",children:[o.jsx("span",{className:"font-mono text-primary-400",children:((ue=S[v||""])==null?void 0:ue.name)||(v==null?void 0:v.slice(0,8))}),"wants to sync chat history. This will merge messages on both devices."]}),o.jsxs("div",{className:"flex gap-3",children:[o.jsx("button",{onClick:Pe,className:"flex-1 py-2 bg-slate-800 hover:bg-slate-700 text-slate-300 rounded-lg transition-colors",children:"Decline"}),o.jsx("button",{onClick:Re,className:"flex-1 py-2 bg-primary-600 hover:bg-primary-500 text-white rounded-lg transition-colors",children:"Allow"})]})]})}),G&&o.jsx("div",{className:"fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4",children:o.jsxs("div",{className:"bg-slate-900 border border-slate-700 rounded-xl p-6 max-w-sm w-full shadow-xl",children:[o.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[o.jsx("div",{className:"p-2 bg-yellow-500/10 rounded-full",children:o.jsx(Ie,{className:"w-6 h-6 text-yellow-400"})}),o.jsx("h3",{className:"text-lg font-medium text-white",children:"Create New Session?"})]}),o.jsx("p",{className:"text-slate-400 mb-2",children:"Creating a new session will:"}),o.jsxs("ul",{className:"text-sm text-slate-400 mb-4 space-y-1 ml-4",children:[o.jsx("li",{children:"• Disconnect all current chats"}),o.jsx("li",{children:"• Generate a new ID"}),o.jsx("li",{children:"• Start with an empty chat list"})]}),o.jsx("p",{className:"text-sm text-slate-500 mb-6",children:"You can switch back to this session anytime."}),o.jsxs("div",{className:"flex gap-3",children:[o.jsx("button",{onClick:()=>Z(!1),className:"flex-1 py-2 bg-slate-800 hover:bg-slate-700 text-slate-300 rounded-lg transition-colors",children:"Cancel"}),o.jsx("button",{onClick:ze,className:"flex-1 py-2 bg-primary-600 hover:bg-primary-500 text-white rounded-lg transition-colors",children:"Create Session"})]})]})}),J&&o.jsx(et,{config:L,onSave:xe,onClose:()=>Y(!1)})]}):o.jsx("div",{className:"h-screen w-screen flex items-center justify-center bg-slate-950 text-white",children:"Initializing..."})}const ye=document.getElementById("root");if(!ye)throw new Error("Could not find root element to mount to");const ot=qe.createRoot(ye);ot.render(o.jsx(We.StrictMode,{children:o.jsx(nt,{})}));export{he as D,ne as F,pt as M,ft as g};
