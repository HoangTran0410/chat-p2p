import{r as m,N as Ke,$ as wt,j as l,X as ke,B as Ae,O as be,Q as xt,T as vt,V as St,W as bt,Y as It,Z as Ct,_ as Pt,a0 as kt}from"./vendor-DoBkD9ct.js";import{c as Nt,v as Tt,d as Dt,e as Mt,a as jt,b as We,i as Xe,g as ze,f as Ue,h as Re,j as Rt}from"./services/crypto-DOdyDEE6.js";import{g as Be,s as He,a as Ve,b as Et,d as _t,e as qe,f as At,h as re,i as Kt}from"./services/db-DWyvzVjS.js";import{d as Gt,s as Qe,g as Se,a as Ne,b as Lt,e as $t}from"./services/storage-CphQKvNS.js";import{C as Yt}from"./components/chatsidebar-Djm2wSJh.js";import{C as Ot}from"./components/chatwindow-CQ2xmVpY.js";import{S as Ft}from"./components/settingsmodal-jEx-mvgt.js";import{S as Wt}from"./components/syncmodal-geqtvQia.js";import{K as Xt}from"./components/keychangewarningmodal-DvGZp-Ym.js";import"./index-CxuO6HPh.js";import"./components/sessionswitcher-CGgQGmMy.js";import"./components/newsessiondialog-DHqh3Ssa.js";import"./components/gameselector-CnIDPr1g.js";import"./components/gamecontainer-50DAxEQ3.js";(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))t(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const c of r.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&t(c)}).observe(document,{childList:!0,subtree:!0});function e(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerPolicy&&(r.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?r.credentials="include":n.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function t(n){if(n.ep)return;n.ep=!0;const r=e(n);fetch(n.href,r)}})();function Cn(a){return a&&a.__esModule&&Object.prototype.hasOwnProperty.call(a,"default")?a.default:a}function zt({sessionId:a,onKeyChange:s}){const[e,t]=m.useState(!1),[n,r]=m.useState(null),[c,u]=m.useState(null),d=m.useRef(null),h=m.useRef(null),i=m.useRef(new Map),[,g]=m.useState({}),C=m.useCallback(()=>g({}),[]);m.useEffect(()=>{if(!a)return;(async()=>{try{const N=await Et(a);if(N){const _=await Xe({publicKey:N.identityPubKey,privateKey:N.identityPrivKey});d.current=_}else{const _=await Rt();d.current=_;const ne=await We(_),le={sessionId:a,identityPubKey:ne.publicKey,identityPrivKey:ne.privateKey,createdAt:Date.now()};await Ve(le)}h.current=await Re();const b=await ze(d.current.publicKey),A=await Ue(d.current.publicKey);r(b),u(A),t(!0)}catch(N){console.error("Failed to initialize encryption:",N)}})()},[a]);const Y=m.useCallback(async()=>!d.current||!h.current?null:Nt(d.current,h.current),[]),x=m.useCallback(async(y,N)=>{if(!h.current)return!1;try{const b=await Tt(N);if(!b.valid||!b.sessionKey||!b.fingerprint)return console.warn("Invalid key exchange from",y),!1;const A=await Dt(h.current.privateKey,b.sessionKey),_=await Be(y);let ne=!1;_&&_.fingerprint!==b.fingerprint&&(ne=!0,s&&s(y,_.fingerprint,b.fingerprint)),i.current.set(y,{sessionKey:A,fingerprint:b.fingerprint,verified:(_==null?void 0:_.verified)||!1,keyChanged:ne});const le={peerId:y,identityPubKey:N.identityPubKey,fingerprint:b.fingerprint,firstSeen:(_==null?void 0:_.firstSeen)||Date.now(),lastSeen:Date.now(),verified:(_==null?void 0:_.verified)||!1};return await He(le),C(),!0}catch(b){return console.error("Key exchange failed:",b),!1}},[s,C]),R=m.useCallback(async(y,N)=>{const b=i.current.get(y);if(!(b!=null&&b.sessionKey))return console.warn("No session key for peer:",y),null;try{return await Mt(N,b.sessionKey)}catch(A){return console.error("Encryption failed:",A),null}},[]),V=m.useCallback(async(y,N)=>{const b=i.current.get(y);if(!(b!=null&&b.sessionKey))return console.warn("No session key for peer:",y),null;try{return await jt(N,b.sessionKey)}catch(A){return console.error("Decryption failed:",A),null}},[]),Q=m.useCallback(y=>{var N;return((N=i.current.get(y))==null?void 0:N.fingerprint)||null},[]),z=m.useCallback(y=>{var N;return i.current.has(y)&&((N=i.current.get(y))==null?void 0:N.sessionKey)!==null},[]),L=m.useCallback(async y=>{const N=i.current.get(y);if(!N)return;N.verified=!0,N.keyChanged=!1;const b=await Be(y);b&&(b.verified=!0,await He(b)),C()},[C]),P=m.useCallback(async()=>{if(!d.current)return null;try{const y=await We(d.current);return JSON.stringify({sessionId:a,keys:y,exportedAt:Date.now()},null,2)}catch(y){return console.error("Failed to export keys:",y),null}},[a]),D=m.useCallback(async y=>{var N,b;try{const A=JSON.parse(y);if(!((N=A.keys)!=null&&N.publicKey)||!((b=A.keys)!=null&&b.privateKey))throw new Error("Invalid key format");const _=await Xe(A.keys);d.current=_;const ne={sessionId:a,identityPubKey:A.keys.publicKey,identityPrivKey:A.keys.privateKey,createdAt:A.exportedAt||Date.now()};await Ve(ne);const le=await ze(_.publicKey),ge=await Ue(_.publicKey);return r(le),u(ge),h.current=await Re(),!0}catch(A){return console.error("Failed to import keys:",A),!1}},[a]),j=m.useCallback(async()=>{h.current=await Re(),i.current.clear(),C()},[C]);return{isReady:e,myFingerprint:n,myShortFingerprint:c,identityKeyPair:d.current,sessionKeyPair:h.current,peerStates:i.current,createKeyExchange:Y,handleKeyExchange:x,encrypt:R,decrypt:V,getPeerFingerprint:Q,hasPeerKey:z,markPeerVerified:L,exportMyKeys:P,importMyKeys:D,regenerateSessionKey:j}}function Pn(a){return`${window.location.origin}${window.location.pathname}#connect=${a}`}function Ut(){const a=window.location.hash;let s=null;return a.startsWith("#connect=")&&(s=a.slice(9),window.history.replaceState(null,"",window.location.pathname+window.location.search)),{pendingConnect:s}}const Te={host:"fbaio.xyz",port:443,path:"/peer",secure:!0,debug:3},et=50,{pendingConnect:Bt}=Ut(),Ht=()=>{try{const a=localStorage.getItem("peer_config");return a?JSON.parse(a):Te}catch{return Te}},Vt=Ke((a,s)=>({chats:{},isStorageReady:!1,typingStates:{},sessions:[],activeSessionId:"",peerConfig:Ht(),selectedPeerId:null,showMobileDashboard:!1,showSettings:!1,showNewSessionDialog:!1,pendingConnectPeerId:Bt,setChats:e=>a(t=>({chats:typeof e=="function"?e(t.chats):e})),setIsStorageReady:e=>a({isStorageReady:e}),setTypingStates:e=>a(t=>({typingStates:typeof e=="function"?e(t.typingStates):e})),setSessions:e=>a(t=>({sessions:typeof e=="function"?e(t.sessions):e})),setActiveSessionId:e=>a({activeSessionId:e}),setPeerConfig:e=>{localStorage.setItem("peer_config",JSON.stringify(e)),a({peerConfig:e})},setSelectedPeerId:e=>a({selectedPeerId:e}),setShowMobileDashboard:e=>a({showMobileDashboard:e}),setShowSettings:e=>a({showSettings:e}),setShowNewSessionDialog:e=>a({showNewSessionDialog:e}),setPendingConnectPeerId:e=>a({pendingConnectPeerId:e}),selectChat:e=>a({selectedPeerId:e,showMobileDashboard:!1}),backToSidebar:()=>a({selectedPeerId:null,showMobileDashboard:!1}),renameChat:(e,t)=>{const n=s(),r=n.chats[e];if(!r)return;const c={...r,name:t.trim()===""?void 0:t.trim()};re(n.activeSessionId,c),a({chats:{...n.chats,[e]:c}})},deleteChat:(e,t)=>{const n=s();if(e&&confirm("Are you sure you want to delete this conversation?")){t(e);const r={...n.chats};delete r[e],At(n.activeSessionId,e),a({chats:r,selectedPeerId:null})}},switchSession:async e=>{const t=s();if(e!==t.activeSessionId){a({selectedPeerId:null,chats:{}}),Ne(e),a({activeSessionId:e});try{const n=await qe(e);a({chats:n})}catch(n){console.error("Failed to load chats for session:",n)}}},createNewSession:async()=>{const e=s(),t=Se(),n={id:t,createdAt:Date.now()};Qe(n);const r=[...e.sessions,n];Ne(t),a({sessions:r,activeSessionId:t,chats:{},selectedPeerId:null,showNewSessionDialog:!1})},deleteSession:async e=>{const t=s();if(e!==t.activeSessionId){Gt(e);try{await _t(e)}catch(n){console.error("Failed to delete chats for session:",n)}a({sessions:t.sessions.filter(n=>n.id!==e)})}}}));let ae=null;const q=new Map,de=[];let Je=Te;const Ee={message:new Set,connectionOpened:new Set,connectionClosed:new Set,connectionLimitExceeded:new Set},pe=Ke((a,s)=>({myId:"",isReady:!1,isReconnecting:!1,peerError:null,connectionStates:{},activeConnectionsCount:0,addListener:(e,t)=>(Ee[e].add(t),()=>Ee[e].delete(t)),emit:(e,t,n)=>{Ee[e].forEach(r=>r(t,n))},updatePeerState:(e,t)=>a(n=>({connectionStates:{...n.connectionStates,[e]:t}})),handleConnection:e=>{s().updatePeerState(e.peer,"connecting"),e.on("open",()=>{const n=s();if(q.size>=et){const r=de[0];if(r){const c=q.get(r);c&&c.close(),q.delete(r);const u=de.indexOf(r);u>-1&&de.splice(u,1),n.updatePeerState(r,"disconnected"),n.emit("connectionClosed",r),n.emit("connectionLimitExceeded",r)}}q.set(e.peer,e),de.push(e.peer),n.updatePeerState(e.peer,"connected"),n.emit("connectionOpened",e.peer),a({activeConnectionsCount:Array.from(q.values()).filter(r=>r==null?void 0:r.open).length}),e.send({type:"presence",status:"online"})}),e.on("data",n=>{const r=s();n&&typeof n=="object"&&n.type==="presence"||r.emit("message",e.peer,n)}),e.on("close",()=>{const n=s();q.delete(e.peer);const r=de.indexOf(e.peer);r>-1&&de.splice(r,1),n.updatePeerState(e.peer,"disconnected"),n.emit("connectionClosed",e.peer),a({activeConnectionsCount:Array.from(q.values()).filter(c=>c==null?void 0:c.open).length})}),e.on("error",n=>{console.error("Connection-specific error:",n),q.delete(e.peer),s().updatePeerState(e.peer,"failed")})},initPeer:(e,t=Te)=>{Je=t,a({isReconnecting:!0,myId:e});const n=window.Peer||wt,r={iceServers:[{urls:"turns:global.relay.metered.ca:443?transport=tcp",username:"85255418786a1fec898fa979",credential:"gePlRCYyZJ2VMswp"},{urls:"turn:global.relay.metered.ca:443",username:"85255418786a1fec898fa979",credential:"gePlRCYyZJ2VMswp"},{urls:"turn:global.relay.metered.ca:80?transport=tcp",username:"85255418786a1fec898fa979",credential:"gePlRCYyZJ2VMswp"},{urls:"turn:global.relay.metered.ca:80",username:"85255418786a1fec898fa979",credential:"gePlRCYyZJ2VMswp"},{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"},{urls:"stun:stun.relay.metered.ca:80"}],iceCandidatePoolSize:10};console.log("[P2P Store] Initializing with RTCConfig:",r);const c=new n(e,{host:t.host,port:t.port,path:t.path,secure:t.secure,debug:t.debug||0,config:r});c.on("open",d=>{console.log("My Peer ID is: "+d),a({isReady:!0,isReconnecting:!1,peerError:null})}),c.on("connection",d=>{s().handleConnection(d)}),c.on("disconnected",()=>{console.log("Peer disconnected from server."),a({isReady:!1}),setTimeout(()=>{ae&&!ae.destroyed&&(console.log("Attempting to reconnect..."),a({isReconnecting:!0}),ae.reconnect())},3e3)}),c.on("error",d=>{if(console.error("PeerJS error:",d),a({isReconnecting:!1}),d.type==="unavailable-id")a({peerError:"ID is already taken. Please choose another.",isReady:!1});else if(d.message&&d.message.includes("is taken"))a({peerError:`ID is taken: ${d.message}`,isReady:!1});else if(d.type==="peer-unavailable"){const i=(d.message||"").match(/Could not connect to peer (.*)/);i&&i[1]&&s().updatePeerState(i[1],"failed")}else d.type==="network"||d.type==="disconnected"?(a({isReady:!1,peerError:"Network error. Reconnecting..."}),setTimeout(()=>{ae&&!ae.destroyed&&(a({isReconnecting:!0}),ae.reconnect())},3e3)):a({peerError:"Connection error: "+(d.message||"Unknown error")})}),ae=c;const u=()=>{c==null||c.destroy()};window.addEventListener("beforeunload",u)},destroyPeer:()=>{ae&&(ae.destroy(),ae=null),q.clear(),de.length=0,a({connectionStates:{},isReady:!1,activeConnectionsCount:0})},connectToPeer:e=>{const t=s();if(!(!ae||!t.isReady)){if(q.has(e)){const n=q.get(e);if(n!=null&&n.open){t.updatePeerState(e,"connected");return}}t.updatePeerState(e,"connecting");try{const n=ae.connect(e,{reliable:!0});t.handleConnection(n),setTimeout(()=>{a(r=>r.connectionStates[e]==="connecting"?{connectionStates:{...r.connectionStates,[e]:"failed"}}:r)},1e4)}catch(n){console.error("Connect error",n),t.updatePeerState(e,"failed")}}},disconnectPeer:e=>{const t=q.get(e);t&&(t.close(),q.delete(e));const n=de.indexOf(e);n>-1&&de.splice(n,1),s().updatePeerState(e,"disconnected"),a({activeConnectionsCount:Array.from(q.values()).filter(r=>r==null?void 0:r.open).length})},sendMessage:(e,t)=>{const n=q.get(e);return n&&n.open?(n.send(t),!0):!1},updateId:(e,t)=>{const n=s();!e||e===n.myId||(n.destroyPeer(),a({peerError:null}),n.initPeer(e,t||Je))}})),_e=64*1024,kn=50*1024*1024;class Jt{constructor(){this.gameClasses=new Map,this.gameDefinitionCache=new Map}register(s){const e=new s,t=e.gameId;if(this.gameClasses.has(t)){console.warn(`Game ${t} is already registered, skipping...`);return}this.gameClasses.set(t,s),this.gameDefinitionCache.set(t,e.getDefinition())}createInstance(s){const e=this.gameClasses.get(s);return e?new e:(console.warn(`Game ${s} not found in registry`),null)}getAllDefinitions(){return Array.from(this.gameDefinitionCache.values())}has(s){return this.gameClasses.has(s)}getDefinition(s){return this.gameDefinitionCache.get(s)}}const te=new Jt;class tt{getDefinition(){return{id:this.gameId,name:this.gameName,icon:this.gameIcon,description:this.gameDescription,minPlayers:2,maxPlayers:2}}getNextTurn(s){return s.currentTurn===s.hostId?s.guestId:s.hostId}isPlayerTurn(s,e){return s.currentTurn===e&&s.status==="playing"}}function Zt({state:a,myId:s,onMove:e,isMyTurn:t}){const{board:n}=a.data,c=s===a.hostId?"X":"O",{leaveGame:u}=ve(),h=(()=>{const g=[[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];for(const C of g){const[Y,x,R]=C;if(n[Y]&&n[Y]===n[x]&&n[Y]===n[R])return C}return null})(),i=g=>{!t||n[g]||a.status!=="playing"||e(g)};return l.jsxs("div",{className:"flex flex-col items-center gap-6 p-4 w-full max-w-sm mx-auto",children:[l.jsxs("div",{className:"flex flex-col items-center gap-2",children:[l.jsx("div",{className:"text-xl font-bold flex items-center gap-2",children:a.status==="finished"?a.winner?l.jsx("span",{className:a.winner===s?"text-green-400":"text-red-400",children:a.winner===s?"You Won!":"Opponent Won!"}):l.jsx("span",{className:"text-yellow-400",children:"Draw!"}):l.jsx("span",{className:t?"text-primary-400":"text-slate-400",children:t?"Your Turn":"Opponent's Turn"})}),l.jsxs("div",{className:"text-sm text-slate-500 flex items-center gap-4",children:[l.jsxs("span",{className:"flex items-center gap-1",children:[l.jsx(ke,{className:"w-4 h-4 text-blue-400"})," You: ",c]}),l.jsxs("span",{className:"flex items-center gap-1",children:[l.jsx(Ae,{className:"w-4 h-4 text-red-400"})," Opponent:"," ",c==="X"?"O":"X"]})]})]}),l.jsx("div",{className:"grid grid-cols-3 gap-3 bg-slate-800 p-3 rounded-xl relative",children:n.map((g,C)=>{const Y=h==null?void 0:h.includes(C),x=t&&!g&&a.status==="playing";return l.jsxs("button",{onClick:()=>i(C),disabled:!x,className:`
                w-20 h-20 sm:w-24 sm:h-24 rounded-lg flex items-center justify-center text-4xl transition-all
                ${g?"bg-slate-700 shadow-inner":"bg-slate-750 hover:bg-slate-700"}
                ${Y?"bg-green-500/20 ring-2 ring-green-500":""}
                ${x?"cursor-pointer hover:ring-2 hover:ring-primary-500/50":"cursor-default"}
              `,children:[g==="X"&&l.jsx(ke,{className:`w-12 h-12 ${Y?"text-green-400":"text-blue-400"}`,strokeWidth:2.5}),g==="O"&&l.jsx(Ae,{className:`w-10 h-10 ${Y?"text-green-400":"text-red-400"}`,strokeWidth:2.5})]},C)})}),a.status==="finished"&&l.jsxs("div",{className:"flex gap-3 w-full",children:[l.jsx("button",{onClick:()=>ve.getState().restartGame(),className:"flex-1 py-3 bg-primary-600 hover:bg-primary-500 rounded-lg text-white font-medium transition-colors shadow-lg shadow-primary-900/20",children:"Play Again"}),l.jsx("button",{onClick:u,className:"flex-1 py-3 bg-slate-800 hover:bg-slate-700 rounded-lg text-slate-300 font-medium transition-colors",children:"Close Game"})]})]})}const qt=[[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];class Qt extends tt{constructor(){super(...arguments),this.gameId="tictactoe",this.gameName="Tic-Tac-Toe",this.gameIcon="â­•",this.gameDescription="Classic 3x3 strategy game"}createInitialState(s,e){return{board:Array(9).fill(null),winningLine:null}}isValidMove(s,e){const{board:t}=s.data,n=e.payload;return!(n<0||n>8||t[n]!==null||s.winner||!this.isPlayerTurn(s,e.playerId))}applyMove(s,e){const{board:t}=s.data,n=e.payload,r=e.playerId===s.hostId?"X":"O",c=[...t];return c[n]=r,{...s,data:{...s.data,board:c}}}checkGameEnd(s){const{board:e}=s.data;for(const t of qt){const[n,r,c]=t;if(e[n]&&e[n]===e[r]&&e[n]===e[c])return{isEnded:!0,winner:e[n]==="X"?s.hostId:s.guestId,isDraw:!1}}return e.every(t=>t!==null)?{isEnded:!0,winner:null,isDraw:!0}:{isEnded:!1,winner:null,isDraw:!1}}renderGame(s,e,t,n){return be.createElement(Zt,{state:s,myId:e,onMove:t,isMyTurn:n})}}class nt{getDefinition(){return{id:this.gameId,name:this.gameName,icon:this.gameIcon,description:this.gameDescription,minPlayers:2,maxPlayers:2,isRealTime:!0}}}const Ze=["#ef4444","#3b82f6","#22c55e","#eab308","#a855f7","#ec4899","#000000"];function en({state:a,myId:s,onAction:e}){const t=m.useRef(null),[n,r]=m.useState(!1),[c,u]=m.useState(Ze[0]),[d,h]=m.useState([]),{leaveGame:i}=ve();a.hostId,m.useEffect(()=>{const P=t.current;if(!P)return;const D=P.getContext("2d");D&&(D.clearRect(0,0,P.width,P.height),a.data.strokes.forEach(j=>{if(!(j.points.length<2)){D.strokeStyle=j.color,D.lineWidth=j.width,D.lineCap="round",D.lineJoin="round",D.beginPath(),D.moveTo(j.points[0].x,j.points[0].y);for(let y=1;y<j.points.length;y++)D.lineTo(j.points[y].x,j.points[y].y);D.stroke()}}))},[a.data.strokes]);const g=P=>{const D=t.current,j=D.getBoundingClientRect(),y=P.clientX-j.left,N=P.clientY-j.top,b=D.width/j.width,A=D.height/j.height;return{x:y*b,y:N*A}},C=P=>{r(!0);const D=g(P);h([D])},Y=P=>{if(!n)return;const D=g(P);h(N=>[...N,D]);const y=t.current.getContext("2d");d.length>0&&(y.strokeStyle=c,y.lineWidth=3,y.lineCap="round",y.lineJoin="round",y.beginPath(),y.moveTo(d[d.length-1].x,d[d.length-1].y),y.lineTo(D.x,D.y),y.stroke())},x=()=>{if(!n||d.length<2){r(!1),h([]);return}const P={id:`${s}_${Date.now()}`,playerId:s,points:d,color:c,width:3};e({type:"draw",stroke:P}),r(!1),h([])},R=P=>{const D=t.current,j=D.getBoundingClientRect(),y=P.touches[0]||P.changedTouches[0],N=y.clientX-j.left,b=y.clientY-j.top,A=D.width/j.width,_=D.height/j.height;return{x:N*A,y:b*_}},V=P=>{r(!0);const D=R(P);h([D])},Q=P=>{if(!n)return;const D=R(P);h(N=>[...N,D]);const y=t.current.getContext("2d");d.length>0&&(y.strokeStyle=c,y.lineWidth=3,y.lineCap="round",y.lineJoin="round",y.beginPath(),y.moveTo(d[d.length-1].x,d[d.length-1].y),y.lineTo(D.x,D.y),y.stroke())},z=()=>{if(!n||d.length<2){r(!1),h([]);return}const P={id:`${s}_${Date.now()}`,playerId:s,points:d,color:c,width:3};e({type:"draw",stroke:P}),r(!1),h([])},L=()=>{confirm("Clear the entire canvas?")&&e({type:"clear"})};return l.jsxs("div",{className:"flex flex-col items-center gap-2 md:gap-4 p-2 md:p-4 w-full h-full max-w-full md:max-w-2xl mx-auto",children:[l.jsxs("div",{className:"flex items-center gap-1.5 md:gap-2 p-1.5 md:p-2 bg-slate-800 rounded-lg w-full justify-center",children:[l.jsx(xt,{className:"w-3 h-3 md:w-4 md:h-4 text-slate-400 hidden md:block"}),Ze.map(P=>l.jsx("button",{onClick:()=>u(P),className:`w-7 h-7 md:w-8 md:h-8 rounded-full border-2 transition-all ${c===P?"border-white scale-110":"border-slate-600 hover:scale-105"}`,style:{backgroundColor:P},title:P},P)),l.jsx("div",{className:"w-px h-6 md:h-8 bg-slate-700 mx-0.5 md:mx-1"}),l.jsx("button",{onClick:L,className:"p-2 hover:bg-slate-700 rounded-lg transition-colors text-slate-400 hover:text-red-400",title:"Clear canvas",children:l.jsx(vt,{className:"w-4 h-4"})})]}),l.jsx("canvas",{ref:t,width:600,height:400,onMouseDown:C,onMouseMove:Y,onMouseUp:x,onMouseLeave:x,onTouchStart:V,onTouchMove:Q,onTouchEnd:z,className:"w-full flex-1 md:flex-none border-2 border-slate-700 rounded-lg bg-white cursor-crosshair touch-none",style:{aspectRatio:"3/2",minHeight:"200px"}}),l.jsxs("div",{className:"text-xs text-slate-500",children:[a.data.strokes.length," strokes"]})]})}class tn extends nt{constructor(){super(...arguments),this.gameId="canvas",this.gameName="Draw Together",this.gameIcon="ðŸŽ¨",this.gameDescription="Collaborative drawing canvas"}createInitialState(s,e){return{strokes:[]}}applyAction(s,e){const{payload:t}=e;switch(t.type){case"draw":return{...s,data:{...s.data,strokes:[...s.data.strokes,t.stroke]},updatedAt:Date.now()};case"clear":return{...s,data:{...s.data,strokes:[]},updatedAt:Date.now()};default:return s}}renderGame(s,e,t){return be.createElement(en,{state:s,myId:e,onAction:t})}}function nn({state:a,myId:s,onAction:e}){const t=m.useRef(null),[n,r]=m.useState(""),[c,u]=m.useState(!1),d=m.useRef(!1),h=s===a.hostId;m.useEffect(()=>{var V;if(window.YT){u(!0);return}const x=document.createElement("script");x.src="https://www.youtube.com/iframe_api";const R=document.getElementsByTagName("script")[0];(V=R.parentNode)==null||V.insertBefore(x,R),window.onYouTubeIframeAPIReady=()=>{u(!0)}},[]),m.useEffect(()=>{!c||!a.data.videoId||(t.current&&t.current.destroy(),t.current=new window.YT.Player("youtube-player",{videoId:a.data.videoId,playerVars:{autoplay:0,controls:1,modestbranding:1,rel:0},events:{onReady:i,onStateChange:g}}))},[c,a.data.videoId]),m.useEffect(()=>{if(!t.current||!t.current.getPlayerState||d.current)return;const x=t.current;a.data.isPlaying?x.getPlayerState()!==1&&(d.current=!0,x.playVideo(),setTimeout(()=>d.current=!1,500)):x.getPlayerState()===1&&(d.current=!0,x.pauseVideo(),setTimeout(()=>d.current=!1,500));const R=x.getCurrentTime();Math.abs(R-a.data.currentTime)>2&&(d.current=!0,x.seekTo(a.data.currentTime,!0),setTimeout(()=>d.current=!1,500))},[a.data.isPlaying,a.data.currentTime,a.updatedAt]);const i=x=>{t.current=x.target},g=x=>{if(d.current)return;const V=x.target.getCurrentTime();x.data===1?e({type:"play",time:V}):x.data===2&&e({type:"pause",time:V})},C=x=>{const R=[/(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&\n?#]+)/,/^([a-zA-Z0-9_-]{11})$/];for(const V of R){const Q=x.match(V);if(Q)return Q[1]}return null},Y=()=>{const x=C(n);x?(e({type:"load_video",videoId:x}),r("")):alert("Invalid YouTube URL or video ID")};return l.jsxs("div",{className:"flex flex-col gap-3 p-2 md:p-4 w-full h-full max-w-full md:max-w-6xl mx-auto",children:[l.jsxs("div",{className:"flex gap-2",children:[l.jsxs("div",{className:"flex-1 relative",children:[l.jsx(St,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"}),l.jsx("input",{type:"text",value:n,onChange:x=>r(x.target.value),onKeyDown:x=>{x.key==="Enter"&&Y()},placeholder:"Paste YouTube URL or video ID...",className:"w-full pl-10 pr-4 py-2 bg-slate-800 border border-slate-700 rounded-lg text-slate-200 placeholder-slate-500 focus:outline-none focus:border-primary-500"})]}),l.jsx("button",{onClick:Y,className:"px-4 py-2 bg-primary-600 hover:bg-primary-500 rounded-lg text-white font-medium transition-colors",children:"Load"})]}),a.data.videoId?l.jsx("div",{className:"relative w-full flex-1 bg-black rounded-lg overflow-hidden min-h-[400px] md:min-h-[500px]",children:l.jsx("div",{id:"youtube-player",className:"absolute inset-0",style:{width:"100%",height:"100%"}})}):l.jsx("div",{className:"flex-1 flex items-center justify-center bg-slate-800 rounded-lg border-2 border-dashed border-slate-700",children:l.jsxs("div",{className:"text-center p-8",children:[l.jsx("div",{className:"text-6xl mb-4",children:"ðŸ“º"}),l.jsx("div",{className:"text-slate-300 font-semibold mb-2",children:"No video loaded"}),l.jsx("div",{className:"text-sm text-slate-500",children:"Paste a YouTube URL above to start watching together"})]})}),l.jsxs("div",{className:"text-xs text-slate-500 flex items-center justify-between",children:[l.jsxs("span",{children:["You are ",h?"Host":"Guest"]}),a.data.videoId&&l.jsx("span",{className:"flex items-center gap-2",children:a.data.isPlaying?l.jsxs(l.Fragment,{children:[l.jsx(bt,{className:"w-3 h-3 text-green-400"}),"Playing"]}):l.jsxs(l.Fragment,{children:[l.jsx(It,{className:"w-3 h-3 text-yellow-400"}),"Paused"]})})]})]})}class sn extends nt{constructor(){super(...arguments),this.gameId="youtube",this.gameName="Watch Together",this.gameIcon="ðŸ“º",this.gameDescription="Watch YouTube videos together"}createInitialState(s,e){return{videoId:null,isPlaying:!1,currentTime:0}}applyAction(s,e){const{payload:t}=e;switch(t.type){case"load_video":return{...s,data:{videoId:t.videoId,isPlaying:!1,currentTime:0},updatedAt:Date.now()};case"play":return{...s,data:{...s.data,isPlaying:!0,currentTime:t.time},updatedAt:Date.now()};case"pause":return{...s,data:{...s.data,isPlaying:!1,currentTime:t.time},updatedAt:Date.now()};case"seek":return{...s,data:{...s.data,currentTime:t.time},updatedAt:Date.now()};default:return s}}renderGame(s,e,t){return be.createElement(nn,{state:s,myId:e,onAction:t})}}const me=50,xe=40;function an({state:a,myId:s,onMove:e,isMyTurn:t}){const{board:n,winningLine:r}=a.data,u=s===a.hostId?"X":"O",{leaveGame:d}=ve(),h=m.useRef(null),i=m.useRef(null),[g,C]=m.useState({x:20,y:20}),[Y,x]=m.useState(!1),[R,V]=m.useState({x:0,y:0,viewportX:0,viewportY:0}),[Q,z]=m.useState(null),[L,P]=m.useState({width:600,height:600}),D=()=>{const v=Object.keys(n);if(v.length===0)return null;const f=v[v.length-1],[k,W]=f.split(",").map(Number);return{row:k,col:W}};m.useEffect(()=>{const v=()=>{if(i.current){const f=i.current.clientWidth,k=i.current.clientHeight;P({width:f,height:k})}};return v(),window.addEventListener("resize",v),()=>window.removeEventListener("resize",v)},[]),m.useEffect(()=>{const v=h.current;if(!v)return;const f=v.getContext("2d");if(!f)return;f.clearRect(0,0,L.width,L.height);const k=xe,W=Math.ceil(L.width/k),ee=Math.ceil(L.height/k),ie=-(g.x*k)%k,ce=-(g.y*k)%k,J=Math.floor(g.x),se=Math.floor(g.y);f.strokeStyle="#334155",f.lineWidth=1;for(let X=0;X<=W+1;X++){const O=ie+X*k;f.beginPath(),f.moveTo(O,0),f.lineTo(O,L.height),f.stroke()}for(let X=0;X<=ee+1;X++){const O=ce+X*k;f.beginPath(),f.moveTo(0,O),f.lineTo(L.width,O),f.stroke()}if(Q&&t&&a.status==="playing"){const X=Q.col-J,O=Q.row-se;X>=0&&X<W&&O>=0&&O<ee&&(f.fillStyle="rgba(148, 163, 184, 0.2)",f.fillRect(ie+X*k,ce+O*k,k,k))}for(let X=0;X<W+1;X++)for(let O=0;O<ee+1;O++){const oe=J+X,ye=se+O;if(oe<0||oe>=me||ye<0||ye>=me)continue;const Ge=`${ye},${oe}`,De=n[Ge];if(!De)continue;const we=ie+X*k+k/2,ue=ce+O*k+k/2,Ie=r==null?void 0:r.some(([Z,fe])=>Z===ye&&fe===oe),U=D(),Me=U&&U.row===ye&&U.col===oe;if(De==="X"){f.strokeStyle=Ie?"#4ade80":"#3b82f6",f.lineWidth=Me?4:3;const Z=k*.3;f.beginPath(),f.moveTo(we-Z,ue-Z),f.lineTo(we+Z,ue+Z),f.stroke(),f.beginPath(),f.moveTo(we+Z,ue-Z),f.lineTo(we-Z,ue+Z),f.stroke()}else{f.strokeStyle=Ie?"#4ade80":"#ef4444",f.lineWidth=Me?4:3;const Z=k*.25;f.beginPath(),f.arc(we,ue,Z,0,Math.PI*2),f.stroke()}}f.fillStyle="#64748b",f.font="10px monospace",f.fillText(`(${J}, ${se})`,5,15)},[g,n,r,Q,t,a.status,L]);const j=(v,f)=>{const k=h.current;if(!k)return null;const W=k.getBoundingClientRect(),ee=v-W.left,ie=f-W.top,ce=xe,J=Math.floor(g.x+ee/ce),se=Math.floor(g.y+ie/ce);return J<0||J>=me||se<0||se>=me?null:{row:se,col:J}},y=v=>{x(!0),V({x:v.clientX,y:v.clientY,viewportX:g.x,viewportY:g.y})},N=v=>{const f=j(v.clientX,v.clientY);if(z(f),Y){const k=(R.x-v.clientX)/xe,W=(R.y-v.clientY)/xe;C({x:Math.max(0,Math.min(me-1,R.viewportX+k)),y:Math.max(0,Math.min(me-1,R.viewportY+W))})}},b=()=>{x(!1)},A=()=>{x(!1),z(null)},_=v=>{if(Math.abs(v.clientX-R.x)>5||Math.abs(v.clientY-R.y)>5||!t||a.status!=="playing")return;const f=j(v.clientX,v.clientY);if(!f)return;const k=`${f.row},${f.col}`;n[k]||e(f)},ne=v=>{const f=v.touches[0];x(!0),V({x:f.clientX,y:f.clientY,viewportX:g.x,viewportY:g.y})},le=v=>{const f=v.touches[0],k=j(f.clientX,f.clientY);if(z(k),Y){const W=(R.x-f.clientX)/xe,ee=(R.y-f.clientY)/xe;C({x:Math.max(0,Math.min(me-1,R.viewportX+W)),y:Math.max(0,Math.min(me-1,R.viewportY+ee))})}},ge=v=>{const f=v.changedTouches[0];if(Math.abs(f.clientX-R.x)>5||Math.abs(f.clientY-R.y)>5){x(!1),z(null);return}if(x(!1),z(null),!t||a.status!=="playing")return;const k=j(f.clientX,f.clientY);if(!k)return;const W=`${k.row},${k.col}`;n[W]||e(k)},he=()=>{const v=D();if(!v)return;const f=Math.max(0,v.col-3),k=Math.max(0,v.row-3),W=g.x,ee=g.y,ie=performance.now(),ce=300,J=se=>{const X=se-ie,O=Math.min(X/ce,1),oe=1-Math.pow(1-O,3);C({x:W+(f-W)*oe,y:ee+(k-ee)*oe}),O<1&&requestAnimationFrame(J)};requestAnimationFrame(J)};return l.jsxs("div",{className:"flex flex-col gap-3 p-2 md:p-4 w-full h-full",children:[l.jsxs("div",{className:"flex items-center justify-between",children:[l.jsxs("div",{className:"flex items-center gap-3",children:[l.jsx("div",{className:"text-sm font-semibold",children:a.status==="finished"?a.winner?l.jsx("span",{className:a.winner===s?"text-green-400":"text-red-400",children:a.winner===s?"You Won!":"Opponent Won!"}):l.jsx("span",{className:"text-yellow-400",children:"Draw!"}):l.jsx("span",{className:t?"text-primary-400":"text-slate-400",children:t?"Your Turn":"Opponent's Turn"})}),l.jsxs("div",{className:"text-xs text-slate-500 flex items-center gap-2",children:[l.jsxs("span",{className:"flex items-center gap-1",children:[l.jsx(ke,{className:"w-3 h-3 text-blue-400"})," ",u==="X"?"You":"Opp"]}),l.jsxs("span",{className:"flex items-center gap-1",children:[l.jsx(Ae,{className:"w-3 h-3 text-red-400"})," ",u==="O"?"You":"Opp"]})]})]}),l.jsx("div",{className:"flex gap-2 text-xs",children:a.status==="finished"?l.jsxs("button",{onClick:()=>ve.getState().restartGame(),className:"px-2 py-1 bg-primary-600 hover:bg-primary-500 rounded text-white flex items-center gap-1",title:"New game",children:[l.jsx(Ct,{className:"w-3 h-3"}),l.jsx("span",{children:"New Game"})]}):l.jsxs("button",{onClick:he,disabled:Object.keys(n).length===0,className:"px-2 py-1 bg-slate-800 hover:bg-slate-700 rounded text-slate-300 flex items-center gap-1 disabled:opacity-50 disabled:cursor-not-allowed",title:"Focus to last move",children:[l.jsx(Pt,{className:"w-3 h-3"}),l.jsx("span",{children:"Last"})]})})]}),l.jsx("div",{ref:i,className:"flex-1 min-h-0",children:l.jsx("canvas",{ref:h,width:L.width,height:L.height,className:"w-full h-full border-2 border-slate-700 rounded-lg bg-slate-900 cursor-move touch-none",onMouseDown:y,onMouseMove:N,onMouseUp:b,onMouseLeave:A,onClick:_,onTouchStart:ne,onTouchMove:le,onTouchEnd:ge})}),l.jsx("div",{className:"text-xs text-slate-500 text-center",children:"Drag to pan â€¢ Click to place"})]})}class rn extends tt{constructor(){super(...arguments),this.gameId="caro",this.gameName="Caro (Gomoku)",this.gameIcon="âŒ",this.gameDescription="5-in-a-row on large board",this.BOARD_SIZE=50,this.WIN_LENGTH=5}createInitialState(s,e){return{board:{},winningLine:null}}isValidMove(s,e){const{row:t,col:n}=e.payload,r=`${t},${n}`;return s.currentTurn===e.playerId&&!s.data.board[r]&&t>=0&&t<this.BOARD_SIZE&&n>=0&&n<this.BOARD_SIZE}applyMove(s,e){const{row:t,col:n}=e.payload,r=`${t},${n}`,c=s.currentTurn===s.hostId?"X":"O";return{...s,data:{...s.data,board:{...s.data.board,[r]:c}}}}checkGameEnd(s){const{board:e}=s.data;for(const t in e){const[n,r]=t.split(",").map(Number);if(this.checkWinFrom(e,n,r))return{isEnded:!0,winner:e[t]==="X"?s.hostId:s.guestId,isDraw:!1}}return{isEnded:!1,winner:null,isDraw:!1}}checkWinFrom(s,e,t){const n=s[`${e},${t}`];if(!n)return null;const r=[[0,1],[1,0],[1,1],[1,-1]];for(const[c,u]of r){const d=[[e,t]];for(let h=1;h<this.WIN_LENGTH;h++){const i=e+c*h,g=t+u*h;if(s[`${i},${g}`]===n)d.push([i,g]);else break}for(let h=1;h<this.WIN_LENGTH;h++){const i=e-c*h,g=t-u*h;if(s[`${i},${g}`]===n)d.unshift([i,g]);else break}if(d.length>=this.WIN_LENGTH)return d.slice(0,this.WIN_LENGTH)}return null}renderGame(s,e,t,n){return be.createElement(an,{state:s,myId:e,onMove:t,isMyTurn:n})}}te.register(Qt);te.register(rn);te.register(tn);te.register(sn);const on=()=>`game_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,ve=Ke((a,s)=>({activeGame:null,pendingInvites:[],setActiveGame:e=>a({activeGame:e}),addPendingInvite:e=>a(t=>({pendingInvites:[...t.pendingInvites,e]})),removePendingInvite:e=>a(t=>({pendingInvites:t.pendingInvites.filter(n=>n.sessionId!==e)})),clearPendingInvites:()=>a({pendingInvites:[]}),createGame:(e,t)=>{const{sendMessage:n,myId:r}=pe.getState(),c=te.createInstance(e);if(!c||!r)return null;const u=on(),d=c.createInitialState(r,t),h={id:u,gameType:e,hostId:r,guestId:t,status:"waiting",currentTurn:r,winner:null,isDraw:!1,data:d,createdAt:Date.now(),updatedAt:Date.now()};return a({activeGame:h}),n(t,{type:"game_invite",gameType:e,sessionId:u,hostId:r}),u},acceptInvite:e=>{const t=s(),{sendMessage:n,myId:r}=pe.getState(),c=t.pendingInvites.find(i=>i.sessionId===e);if(!c||!r)return;const u=te.createInstance(c.gameType);if(!u)return;t.removePendingInvite(e),n(c.hostId,{type:"game_accept",sessionId:e});const d=u.createInitialState(c.hostId,r),h={id:e,gameType:c.gameType,hostId:c.hostId,guestId:r,status:"waiting",currentTurn:c.hostId,winner:null,isDraw:!1,data:d,createdAt:Date.now(),updatedAt:Date.now()};a({activeGame:h})},declineInvite:e=>{const t=s(),{sendMessage:n}=pe.getState(),r=t.pendingInvites.find(c=>c.sessionId===e);r&&(t.removePendingInvite(e),n(r.hostId,{type:"game_decline",sessionId:e}))},makeMove:e=>{const t=s(),{sendMessage:n,myId:r}=pe.getState(),{activeGame:c}=t;if(!c||c.status!=="playing"||!r)return;const u=te.createInstance(c.gameType),d=te.getDefinition(c.gameType);if(!u)return;const h=r===c.hostId?c.guestId:c.hostId;if(d!=null&&d.isRealTime){const i={type:"action",playerId:r,timestamp:Date.now(),payload:e};let g=u.applyAction(c,i);if(typeof u.checkGameEnd=="function"){const C=u.checkGameEnd(g);C.isEnded&&(g={...g,status:"finished",winner:C.winner,isDraw:C.isDraw})}g.updatedAt=Date.now(),a({activeGame:g}),n(h,{type:"game_realtime_action",sessionId:c.id,action:i})}else{const i={type:"move",playerId:r,timestamp:Date.now(),payload:e};if(!u.isValidMove(c,i)){console.warn("Invalid move attempted");return}if(r===c.hostId){let C=u.applyMove(c,i);const Y=u.checkGameEnd(C);Y.isEnded?C={...C,status:"finished",winner:Y.winner,isDraw:Y.isDraw}:C={...C,currentTurn:u.getNextTurn(C)},C.updatedAt=Date.now(),a({activeGame:C}),n(h,{type:"game_state_sync",sessionId:c.id,state:C})}else n(h,{type:"game_action",sessionId:c.id,action:i})}},restartGame:()=>{const e=s(),{sendMessage:t,myId:n}=pe.getState(),{activeGame:r}=e;if(!r||!n)return;const c=te.createInstance(r.gameType);if(!c)return;const u=n===r.hostId?r.guestId:r.hostId,d=c.createInitialState(r.hostId,r.guestId),h={...r,status:"playing",currentTurn:r.hostId,winner:null,isDraw:!1,data:d,updatedAt:Date.now()};a({activeGame:h}),t(u,{type:"game_state_sync",sessionId:r.id,state:h})},leaveGame:()=>{const e=s(),{sendMessage:t,myId:n}=pe.getState(),{activeGame:r}=e;if(!r||!n){a({activeGame:null});return}const c=n===r.hostId?r.guestId:r.hostId;t(c,{type:"game_leave",sessionId:r.id}),a({activeGame:null})},handleGameMessage:(e,t)=>{const n=s(),{sendMessage:r,myId:c}=pe.getState();switch(t.type){case"game_invite":{n.addPendingInvite({sessionId:t.sessionId,gameType:t.gameType,hostId:t.hostId,receivedAt:Date.now()});break}case"game_accept":{const{activeGame:u}=n;if(!u||u.id!==t.sessionId||!c)break;const d=te.createInstance(u.gameType);if(!d)break;const h=d.createInitialState(c,u.guestId),i={...u,status:"playing",data:h,updatedAt:Date.now()};a({activeGame:i}),r(u.guestId,{type:"game_state_sync",sessionId:u.id,state:i});break}case"game_decline":{const{activeGame:u}=n;(u==null?void 0:u.id)===t.sessionId&&a({activeGame:null});break}case"game_action":{const{activeGame:u}=n;if(!u||u.id!==t.sessionId||!c||c!==u.hostId)break;const d=te.createInstance(u.gameType),h=te.getDefinition(u.gameType);if(!d||h!=null&&h.isRealTime)break;const i=t.action;if(!d.isValidMove(u,i)){console.warn("Invalid move from guest");break}let g=d.applyMove(u,i);const C=d.checkGameEnd(g);C.isEnded?g={...g,status:"finished",winner:C.winner,isDraw:C.isDraw}:g={...g,currentTurn:d.getNextTurn(g)},g.updatedAt=Date.now(),a({activeGame:g}),r(u.guestId,{type:"game_state_sync",sessionId:u.id,state:g});break}case"game_state_sync":{const{activeGame:u}=n;if(!u||u.id!==t.sessionId)break;a({activeGame:t.state});break}case"game_realtime_action":{const{activeGame:u}=n;if(!u||u.id!==t.sessionId)break;const d=te.createInstance(u.gameType);if(!d)break;const h=t.action;let i=d.applyAction(u,h);if(typeof d.checkGameEnd=="function"){const g=d.checkGameEnd(i);g.isEnded&&(i={...i,status:"finished",winner:g.winner,isDraw:g.isDraw})}i.updatedAt=Date.now(),a({activeGame:i});break}case"game_leave":{const{activeGame:u}=n;(u==null?void 0:u.id)===t.sessionId&&a({activeGame:{...u,status:"cancelled"}});break}}}}));function cn(){var Oe,Fe;const{chats:a,setChats:s,isStorageReady:e,setIsStorageReady:t,setTypingStates:n,setSessions:r,activeSessionId:c,setActiveSessionId:u,peerConfig:d,setPeerConfig:h,selectedPeerId:i,setSelectedPeerId:g,showMobileDashboard:C,showSettings:Y,pendingConnectPeerId:x,setPendingConnectPeerId:R}=Vt(),{handleGameMessage:V}=ve(),[Q,z]=m.useState("idle"),[L,P]=m.useState(null),[D,j]=m.useState(null),[y,N]=m.useState(null),[b,A]=m.useState(null),[_,ne]=m.useState(null),[le,ge]=m.useState(null),he=m.useRef(new Map),v=m.useRef("");m.useEffect(()=>{v.current=c},[c]);const f=m.useRef(()=>!1),k=m.useRef(async()=>!1),W=m.useRef(async()=>null),ee=m.useRef(()=>{}),ie=m.useRef(()=>!1);m.useEffect(()=>{(async()=>{try{await Kt();let o=Lt(),M=$t();if(o.length===0){const K=Se(),$={id:K,createdAt:Date.now()};Qe($),Ne(K),o=[$],M=K}else(!M||!o.find(K=>K.id===M))&&(M=o[0].id,Ne(M));r(o),u(M);const G=await qe(M);s(G)}catch(o){console.error("Failed to init storage:",o)}finally{t(!0)}})()},[]);const ce=p=>{h(p)},J=m.useCallback((p,o)=>{if(o&&typeof o=="object"&&o.type==="typing"){n(S=>({...S,[p]:o.isTyping}));return}if(o&&typeof o=="object"&&o.type==="presence")return;if(o&&typeof o=="object"&&o.type==="key_exchange"){const S=ie.current(p);k.current(p,o).then(w=>{w&&(console.log("Key exchange completed with",p),S||W.current().then(I=>{I&&f.current(p,{type:"key_exchange",...I})}))});return}if(o&&typeof o=="object"&&o.type==="encrypted_message"){Ye.current(p,o.payload).then(S=>{if(S)try{const w=JSON.parse(S);ee.current(p,{...w,_encrypted:!0})}catch{console.error("Failed to parse decrypted message")}});return}if(o&&typeof o=="object"&&o.type==="receipt"){const{messageId:S,status:w,timestamp:I}=o;s(T=>{const E=T[p];if(!E)return T;const F=E.messages.map(H=>{if(H.id===S){if(w==="delivered")return{...H,status:"delivered",receivedAt:I};if(w==="read")return{...H,status:"read",readAt:I}}return H}),B={...E,messages:F};return re(v.current,B),{...T,[p]:B}});return}if(o&&typeof o=="object"&&o.type==="file_start"){const{fileId:S,fileName:w,fileSize:I,mimeType:T,totalChunks:E,messageType:F}=o,B={id:S,fileName:w,fileSize:I,mimeType:T,totalChunks:E,receivedChunks:new Map,progress:0,messageType:F||"file"};he.current.set(S,B),ge({fileId:S,fileName:w,progress:0});return}if(o&&typeof o=="object"&&o.type==="file_chunk"){const{fileId:S,chunkIndex:w,data:I}=o,T=he.current.get(S);if(!T)return;T.receivedChunks.set(w,I);const E=Math.round(T.receivedChunks.size/T.totalChunks*100);T.progress=E,ge({fileId:S,fileName:T.fileName,progress:E});return}if(o&&typeof o=="object"&&o.type==="file_end"){const{fileId:S}=o,w=he.current.get(S);if(!w)return;const I=[];for(let F=0;F<w.totalChunks;F++){const B=w.receivedChunks.get(F);B&&I.push(B)}const T=new Blob(I),E={id:Se(),senderId:p,content:w.fileName,timestamp:Date.now(),receivedAt:Date.now(),status:"delivered",type:w.messageType,file:{name:w.fileName,size:w.fileSize,mimeType:w.mimeType,data:T}};s(F=>{const B=F[p]||{peerId:p,messages:[],lastUpdated:Date.now(),unreadCount:0},H={...B,messages:[...B.messages,E],lastUpdated:Date.now(),unreadCount:i===p?0:B.unreadCount+1};return re(v.current,H),{...F,[p]:H}}),f.current(p,{type:"receipt",messageId:E.id,status:"delivered",timestamp:Date.now()}),he.current.delete(S),ge(null);return}if(o&&typeof o=="object"&&o.type==="sync_request"){z("incoming"),P(p);return}if(o&&typeof o=="object"&&o.type==="sync_reject"){z("idle"),P(null),alert(`${p} declined the sync request.`);return}if(o&&typeof o=="object"&&o.type==="sync_cancel"){z("idle"),P(null);return}if(o&&typeof o=="object"&&(o.type==="sync_data_initial"||o.type==="sync_data_final")){const S=o.messages;if(!Array.isArray(S))return;s(w=>{const I=w[p]||{peerId:p,messages:[],lastUpdated:Date.now(),unreadCount:0},T=new Set(I.messages.map(H=>H.id)),E=S.filter(H=>!T.has(H.id));if(E.length===0&&o.type==="sync_data_final")return w;const F=[...I.messages,...E].sort((H,yt)=>H.timestamp-yt.timestamp),B={...I,messages:F};return re(v.current,B),o.type==="sync_data_initial"&&f.current(p,{type:"sync_data_final",messages:F}),{...w,[p]:B}}),j({phase:o.type==="sync_data_initial"?"Receiving":"Merging",count:S.length}),setTimeout(()=>{z("idle"),P(null),j(null)},500);return}const M=o.id||Se(),G=o.timestamp||Date.now(),K=o._encrypted===!0;let $;typeof o=="string"?$={id:M,senderId:p,content:o,timestamp:G,receivedAt:Date.now(),status:"delivered",type:"text",encrypted:!1}:$={id:M,senderId:p,content:o.content||"",timestamp:G,receivedAt:Date.now(),status:"delivered",type:o.type||"text",file:o.file,encrypted:K},!(!$.content&&!$.file)&&(f.current(p,{type:"receipt",messageId:M,status:"delivered",timestamp:Date.now()}),s(S=>{const w=S[p]||{peerId:p,messages:[],lastUpdated:Date.now(),unreadCount:0},I={...w,messages:[...w.messages,$],lastUpdated:Date.now(),unreadCount:i===p?0:w.unreadCount+1},T={...S,[p]:I};return re(v.current,I),T}))},[i]),se=m.useCallback(p=>{s(o=>{if(!o[p]){const M={peerId:p,messages:[],lastUpdated:Date.now(),unreadCount:0};return re(v.current,M),{...o,[p]:M}}return o}),W.current().then(o=>{o&&f.current(p,{type:"key_exchange",...o})}),window.innerWidth>=768&&!i&&g(p)},[i]),X=m.useCallback(p=>{n(o=>({...o,[p]:!1}))},[]),{myId:O,isReady:oe,isReconnecting:ye,peerError:Ge,connectionStates:De,activeConnectionsCount:we,connectToPeer:ue,disconnectPeer:Ie,sendMessage:U,updateId:Me,initPeer:Z,addListener:fe}=pe();m.useEffect(()=>{const p=M=>{var K;const G=((K=a[M])==null?void 0:K.name)||M.slice(0,8);N(`Disconnected "${G}" - max ${et} connections reached`),setTimeout(()=>N(null),4e3)},o=[fe("message",J),fe("message",V),fe("connectionOpened",se),fe("connectionClosed",X),fe("connectionLimitExceeded",p)];return()=>o.forEach(M=>M())},[J,se,X,a,fe]),m.useEffect(()=>{c&&e&&Z(c,d)},[c,d,e,Z]);const{myFingerprint:at,createKeyExchange:Le,handleKeyExchange:$e,encrypt:Ce,decrypt:je,getPeerFingerprint:rt,hasPeerKey:Pe,markPeerVerified:ot,exportMyKeys:it,importMyKeys:ct}=zt({sessionId:c,onKeyChange:(p,o,M)=>{A({peerId:p,oldFingerprint:o,newFingerprint:M})}}),lt=m.useRef(Ce),Ye=m.useRef(je);m.useEffect(()=>{lt.current=Ce,Ye.current=je,k.current=$e,W.current=Le,ie.current=Pe},[Ce,je,$e,Le,Pe]),m.useEffect(()=>{f.current=U},[U]),m.useEffect(()=>{ee.current=J},[J]),m.useEffect(()=>{oe&&x&&x!==O&&(console.log("Auto-connecting to peer from URL:",x),ue(x),g(x),R(null))},[oe,x,O,ue]);const dt=async p=>{if(!i)return;const o=Se(),M=Date.now();let G={id:o,timestamp:M};typeof p=="string"?(G.content=p,G.type="text"):G={...G,...p};const K=Pe(i);let $=!1,S=!1;if(K){const w=await Ce(i,JSON.stringify(G));w?($=U(i,{type:"encrypted_message",payload:w}),S=!0):$=U(i,G)}else $=U(i,G);if($){const w={id:o,senderId:O,content:G.content||"",timestamp:M,status:"sent",type:G.type,file:G.file,encrypted:S};s(I=>{const T=I[i]||{peerId:i,messages:[],lastUpdated:Date.now(),unreadCount:0},E={...T,messages:[...T.messages,w],lastUpdated:Date.now()},F={...I,[i]:E};return re(v.current,E),F}),setTimeout(()=>{s(I=>{const T=I[i];if(!T)return I;const E=T.messages.find(F=>F.id===o);if(E&&E.status==="sent"){const F=T.messages.map(H=>H.id===o?{...H,status:"failed"}:H),B={...T,messages:F};return re(v.current,B),{...I,[i]:B}}return I})},1e4)}else{const w={id:o,senderId:O,content:G.content||"",timestamp:M,status:"failed",type:G.type,file:G.file};s(I=>{const T=I[i]||{peerId:i,messages:[],lastUpdated:Date.now(),unreadCount:0},E={...T,messages:[...T.messages,w],lastUpdated:Date.now()},F={...I,[i]:E};return re(v.current,E),F})}},ut=async(p,o,M)=>{if(!i)return;const G=Math.ceil(o.size/_e),K=await o.arrayBuffer();U(i,{type:"file_start",fileId:p,fileName:o.name,fileSize:o.size,mimeType:o.type,totalChunks:G,messageType:M});const $={id:p,senderId:O,content:o.name,timestamp:Date.now(),status:"sending",type:M,file:{name:o.name,size:o.size,mimeType:o.type,data:new Blob([K])}};s(S=>{const w=S[i]||{peerId:i,messages:[],lastUpdated:Date.now(),unreadCount:0},I={...w,messages:[...w.messages,$],lastUpdated:Date.now()};return{...S,[i]:I}});for(let S=0;S<G;S++){const w=S*_e,I=Math.min(w+_e,o.size),T=K.slice(w,I);U(i,{type:"file_chunk",fileId:p,chunkIndex:S,data:T});const E=Math.round((S+1)/G*100);ne({fileId:p,progress:E}),await new Promise(F=>setTimeout(F,10))}U(i,{type:"file_end",fileId:p}),s(S=>{const w=S[i];if(!w)return S;const I=w.messages.map(E=>E.id===p?{...E,status:"sent"}:E),T={...w,messages:I};return re(v.current,T),{...S,[i]:T}}),ne(null)},ft=p=>{if(!i)return;const o=a[i];if(!o)return;const M=o.messages.find(K=>K.id===p);if(!M||M.status!=="failed")return;U(i,{id:M.id,content:M.content,timestamp:M.timestamp})&&(s(K=>{const $=K[i];if(!$)return K;const S=$.messages.map(I=>I.id===p?{...I,status:"sent"}:I),w={...$,messages:S};return re(v.current,w),{...K,[i]:w}}),setTimeout(()=>{s(K=>{const $=K[i];if(!$)return K;const S=$.messages.find(w=>w.id===p);if(S&&S.status==="sent"){const w=$.messages.map(T=>T.id===p?{...T,status:"failed"}:T),I={...$,messages:w};return re(v.current,I),{...K,[i]:I}}return K})},1e4))},mt=()=>{i&&(U(i,{type:"sync_request"}),z("outgoing"),P(i))},pt=()=>{L&&U(L,{type:"sync_cancel"}),z("idle"),P(null)},gt=()=>{if(!L)return;const p=a[L],o=p?p.messages:[];z("outgoing"),j({phase:"Sending",count:o.length}),U(L,{type:"sync_data_initial",messages:o}),setTimeout(()=>{z("idle"),P(null),j(null)},800)},ht=()=>{L&&(U(L,{type:"sync_reject"}),z("idle"),P(null))};return e?l.jsxs("div",{className:"flex h-screen overflow-hidden bg-slate-950 text-slate-100 font-sans selection:bg-primary-500/30 relative",children:[y&&l.jsx("div",{className:"absolute bottom-20 left-1/2 -translate-x-1/2 z-50 animate-in fade-in slide-in-from-bottom-4",children:l.jsxs("div",{className:"bg-yellow-500/10 border border-yellow-500/50 backdrop-blur-md text-yellow-200 px-4 py-3 rounded-lg shadow-xl flex items-center gap-3",children:[l.jsx("span",{className:"text-sm font-medium",children:y}),l.jsx("button",{onClick:()=>N(null),className:"p-1 hover:bg-yellow-500/20 rounded-full transition-colors",children:l.jsx(ke,{className:"w-4 h-4"})})]})}),l.jsx("div",{className:`
        ${i||C?"hidden md:flex":"flex"}
        w-full md:w-80 flex-col border-r border-slate-800
      `,children:l.jsx(Yt,{})}),l.jsx("div",{className:`
        ${i||C?"flex":"hidden md:flex"}
        flex-1 flex-col min-w-0 bg-slate-950
      `,children:l.jsx(Ot,{onSendMessage:dt,onResendMessage:ft,onRequestSync:mt,onSendFileChunked:ut,sendingProgress:_,receivingProgress:le,peerFingerprint:i?rt(i):null,isEncrypted:i?Pe(i):!1})}),l.jsx(Wt,{status:Q,targetPeerId:L,peerName:L?(Oe=a[L])==null?void 0:Oe.name:void 0,progress:D,onCancel:pt,onAccept:gt,onReject:ht}),Y&&l.jsx(Ft,{config:d,onSave:ce,myFingerprint:at,onExportKeys:it,onImportKeys:ct}),l.jsx(Xt,{warning:b,peerName:b?(Fe=a[b.peerId])==null?void 0:Fe.name:void 0,onDisconnect:()=>{b&&(Ie(b.peerId),A(null))},onTrust:()=>{b&&(ot(b.peerId),A(null))}})]}):l.jsx("div",{className:"h-screen w-screen flex items-center justify-center bg-slate-950 text-white",children:"Initializing..."})}const st=document.getElementById("root");if(!st)throw new Error("Could not find root element to mount to");const ln=kt.createRoot(st);ln.render(l.jsx(be.StrictMode,{children:l.jsx(cn,{})}));export{_e as F,kn as M,pe as a,ve as b,Pn as c,Cn as d,te as g,Vt as u};
