import{r as l,$ as De,j as c,X as ce,R as ke,v as Me,w as _e}from"./vendor-B6XYtufB.js";import{a as Re,g as q,s as le}from"./services/storage-D0kpk6bz.js";import{s as _,i as Pe,g as Ee,d as Te}from"./services/db-j9Cw9oXj.js";import{C as Ue}from"./components/chatsidebar-VWzYg0VW.js";import{C as Ae}from"./components/chatwindow-BQTFX7fe.js";import{S as ze}from"./components/settingsmodal-1jMb3uNP.js";import"./index-B4s0x4X5.js";(function(){const g=document.createElement("link").relList;if(g&&g.supports&&g.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))U(s);new MutationObserver(s=>{for(const b of s)if(b.type==="childList")for(const P of b.addedNodes)P.tagName==="LINK"&&P.rel==="modulepreload"&&U(P)}).observe(document,{childList:!0,subtree:!0});function L(s){const b={};return s.integrity&&(b.integrity=s.integrity),s.referrerPolicy&&(b.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?b.credentials="include":s.crossOrigin==="anonymous"?b.credentials="omit":b.credentials="same-origin",b}function U(s){if(s.ep)return;s.ep=!0;const b=L(s);fetch(s.href,b)}})();function Ke(x){return x&&x.__esModule&&Object.prototype.hasOwnProperty.call(x,"default")?x.default:x}const ue={host:"fbaio.xyz",port:443,path:"/peer",secure:!0,debug:3},Oe=50,Fe=({config:x=ue,onMessageReceived:g,onConnectionOpened:L,onConnectionClosed:U,onConnectionLimitExceeded:s})=>{const[b,P]=l.useState(""),[N,X]=l.useState(null),w=l.useRef(new Map),A=l.useRef([]),[G,z]=l.useState({}),[I,O]=l.useState(!1),[R,C]=l.useState(null),[E,T]=l.useState(null),j=(n,a)=>{z(m=>({...m,[n]:a}))},F=l.useCallback(n=>{j(n.peer,"connecting"),n.on("open",()=>{if(w.current.size>=Oe){const a=A.current[0];if(a){const m=w.current.get(a);m&&m.close(),w.current.delete(a),A.current=A.current.filter(v=>v!==a),j(a,"disconnected"),U(a),s&&s(a)}}w.current.set(n.peer,n),A.current.push(n.peer),j(n.peer,"connected"),L(n.peer),n.send({type:"presence",status:"online"})}),n.on("data",a=>{a&&typeof a=="object"&&a.type==="presence"||g(n.peer,a)}),n.on("close",()=>{w.current.delete(n.peer),A.current=A.current.filter(a=>a!==n.peer),j(n.peer,"disconnected"),U(n.peer)}),n.on("error",a=>{console.error("Connection-specific error:",a),w.current.delete(n.peer),j(n.peer,"failed")})},[L,U,g]);l.useCallback(()=>{N&&(N.destroy(),X(null)),w.current.clear(),z({}),O(!1)},[N]);const B=l.useCallback(n=>{const a=window.Peer||De,m=new a(n,{host:x.host,port:x.port,path:x.path,secure:x.secure,debug:x.debug||0});return m.on("open",v=>{console.log("My Peer ID is: "+v),O(!0),C(null)}),m.on("connection",v=>{F(v)}),m.on("error",v=>{if(console.error("PeerJS error:",v),v.type==="unavailable-id")C("ID is already taken. Please choose another."),O(!1);else if(v.type==="peer-unavailable"){const k=(v.message||"").match(/Could not connect to peer (.*)/);k&&k[1]?(j(k[1],"failed"),T(`User '${k[1]}' not found or offline.`)):T("Peer not found or offline.")}else C("Connection error: "+(v.message||"Unknown error"))}),X(m),m},[F]);l.useEffect(()=>{let n=Re();n||(n=q(),le(n)),P(n),P(n);const a=B(n),m=()=>{a==null||a.destroy()};return window.addEventListener("beforeunload",m),()=>{window.removeEventListener("beforeunload",m),a==null||a.destroy()}},[x]);const H=l.useCallback(n=>{!n||n===b||(N&&N.destroy(),w.current.clear(),z({}),O(!1),C(null),T(null),le(n),P(n),B(n))},[b,N,B]),K=l.useCallback(n=>{if(!(!N||!I)){if(w.current.has(n)){const a=w.current.get(n);if(a!=null&&a.open){j(n,"connected");return}}j(n,"connecting");try{const a=N.connect(n,{reliable:!0});F(a),setTimeout(()=>{z(m=>m[n]==="connecting"?{...m,[n]:"failed"}:m)},1e4)}catch(a){console.error("Connect error",a),j(n,"failed")}}},[N,I,F]),Q=l.useCallback(n=>{const a=w.current.get(n);a&&(a.close(),w.current.delete(n)),j(n,"disconnected")},[]),W=l.useCallback((n,a)=>{const m=w.current.get(n);return m&&m.open?(m.send(a),!0):!1},[]);return{myId:b,isReady:I,peerError:R,connectionError:E,resetConnectionError:()=>T(null),connectionStates:G,activeConnectionsCount:Array.from(w.current.values()).filter(n=>n==null?void 0:n.open).length,connectToPeer:K,disconnectPeer:Q,sendMessage:W,updateId:H}},V=64*1024,Ze=50*1024*1024;function Be(){var ie;const[x,g]=l.useState({}),[L,U]=l.useState(!1),[s,b]=l.useState(null),[P,N]=l.useState(!1),[X,w]=l.useState({}),[A,G]=l.useState(!1),[z,I]=l.useState(()=>{const t=localStorage.getItem("peer_config");return t?JSON.parse(t):ue}),[O,R]=l.useState("idle"),[C,E]=l.useState(null),[T,j]=l.useState(null),[F,B]=l.useState(null),[H,K]=l.useState(null),[Q,W]=l.useState(null),J=l.useRef(new Map),n=l.useRef(()=>!1);l.useEffect(()=>{(async()=>{try{await Pe();const e=await Ee();g(e)}catch(e){console.error("Failed to init storage:",e)}finally{U(!0)}})()},[]);const a=t=>{I(t),localStorage.setItem("peer_config",JSON.stringify(t))},m=l.useCallback((t,e)=>{if(e&&typeof e=="object"&&e.type==="typing"){w(u=>({...u,[t]:e.isTyping}));return}if(e&&typeof e=="object"&&e.type==="presence")return;if(e&&typeof e=="object"&&e.type==="receipt"){const{messageId:u,status:o,timestamp:r}=e;g(i=>{const d=i[t];if(!d)return i;const y=d.messages.map(D=>{if(D.id===u){if(o==="delivered")return{...D,status:"delivered",receivedAt:r};if(o==="read")return{...D,status:"read",readAt:r}}return D}),S={...d,messages:y};return _(S),{...i,[t]:S}});return}if(e&&typeof e=="object"&&e.type==="file_start"){const{fileId:u,fileName:o,fileSize:r,mimeType:i,totalChunks:d,messageType:y}=e,S={id:u,fileName:o,fileSize:r,mimeType:i,totalChunks:d,receivedChunks:new Map,progress:0,messageType:y||"file"};J.current.set(u,S),W({fileId:u,fileName:o,progress:0});return}if(e&&typeof e=="object"&&e.type==="file_chunk"){const{fileId:u,chunkIndex:o,data:r}=e,i=J.current.get(u);if(!i)return;i.receivedChunks.set(o,r);const d=Math.round(i.receivedChunks.size/i.totalChunks*100);i.progress=d,W({fileId:u,fileName:i.fileName,progress:d});return}if(e&&typeof e=="object"&&e.type==="file_end"){const{fileId:u}=e,o=J.current.get(u);if(!o)return;const r=[];for(let y=0;y<o.totalChunks;y++){const S=o.receivedChunks.get(y);S&&r.push(S)}const i=new Blob(r),d={id:q(),senderId:t,content:o.fileName,timestamp:Date.now(),receivedAt:Date.now(),status:"delivered",type:o.messageType,file:{name:o.fileName,size:o.fileSize,mimeType:o.mimeType,data:i}};g(y=>{const S=y[t]||{peerId:t,messages:[],lastUpdated:Date.now(),unreadCount:0},D={...S,messages:[...S.messages,d],lastUpdated:Date.now(),unreadCount:s===t?0:S.unreadCount+1};return _(D),{...y,[t]:D}}),n.current(t,{type:"receipt",messageId:d.id,status:"delivered",timestamp:Date.now()}),J.current.delete(u),W(null);return}if(e&&typeof e=="object"&&e.type==="sync_request"){R("incoming"),E(t);return}if(e&&typeof e=="object"&&e.type==="sync_reject"){R("idle"),E(null),alert(`${t} declined the sync request.`);return}if(e&&typeof e=="object"&&e.type==="sync_cancel"){R("idle"),E(null);return}if(e&&typeof e=="object"&&(e.type==="sync_data_initial"||e.type==="sync_data_final")){const u=e.messages;if(!Array.isArray(u))return;g(o=>{const r=o[t]||{peerId:t,messages:[],lastUpdated:Date.now(),unreadCount:0},i=new Set(r.messages.map(D=>D.id)),d=u.filter(D=>!i.has(D.id));if(d.length===0&&e.type==="sync_data_final")return o;const y=[...r.messages,...d].sort((D,ve)=>D.timestamp-ve.timestamp),S={...r,messages:y};return _(S),e.type==="sync_data_initial"&&n.current(t,{type:"sync_data_final",messages:y}),{...o,[t]:S}}),j({phase:e.type==="sync_data_initial"?"Receiving":"Merging",count:u.length}),setTimeout(()=>{R("idle"),E(null),j(null)},500);return}const f=e.id||q(),h=e.timestamp||Date.now();let p;typeof e=="string"?p={id:f,senderId:t,content:e,timestamp:h,receivedAt:Date.now(),status:"delivered",type:"text"}:p={id:f,senderId:t,content:e.content||"",timestamp:h,receivedAt:Date.now(),status:"delivered",type:e.type||"text",file:e.file},!(!p.content&&!p.file)&&(n.current(t,{type:"receipt",messageId:f,status:"delivered",timestamp:Date.now()}),g(u=>{const o=u[t]||{peerId:t,messages:[],lastUpdated:Date.now(),unreadCount:0},r={...o,messages:[...o.messages,p],lastUpdated:Date.now(),unreadCount:s===t?0:o.unreadCount+1},i={...u,[t]:r};return _(r),i}))},[s]),v=l.useCallback(t=>{g(e=>{if(!e[t]){const f={peerId:t,messages:[],lastUpdated:Date.now(),unreadCount:0};return _(f),{...e,[t]:f}}return e}),window.innerWidth>=768&&b(e=>e||t)},[]),Y=l.useCallback(t=>{w(e=>({...e,[t]:!1}))},[]),{myId:k,activeConnectionsCount:fe,connectToPeer:ee,disconnectPeer:te,sendMessage:M,updateId:$,peerError:se,connectionError:ne,resetConnectionError:me,isReady:oe,connectionStates:Z}=Fe({config:z,onMessageReceived:m,onConnectionOpened:v,onConnectionClosed:Y,onConnectionLimitExceeded:t=>{var f;const e=((f=x[t])==null?void 0:f.name)||t.slice(0,8);B(`Disconnected "${e}" - max 5 connections reached`),setTimeout(()=>B(null),4e3)}});l.useEffect(()=>{n.current=M},[M]);const pe=t=>{if(!s)return;const e=q(),f=Date.now();let h={id:e,timestamp:f};if(typeof t=="string"?(h.content=t,h.type="text"):h={...h,...t},M(s,h)){const u={id:e,senderId:k,content:h.content||"",timestamp:f,status:"sent",type:h.type,file:h.file};g(o=>{const r=o[s]||{peerId:s,messages:[],lastUpdated:Date.now(),unreadCount:0},i={...r,messages:[...r.messages,u],lastUpdated:Date.now()},d={...o,[s]:i};return _(i),d}),setTimeout(()=>{g(o=>{const r=o[s];if(!r)return o;const i=r.messages.find(d=>d.id===e);if(i&&i.status==="sent"){const d=r.messages.map(S=>S.id===e?{...S,status:"failed"}:S),y={...r,messages:d};return _(y),{...o,[s]:y}}return o})},1e4)}else{const u={id:e,senderId:k,content:h.content||"",timestamp:f,status:"failed",type:h.type,file:h.file};g(o=>{const r=o[s]||{peerId:s,messages:[],lastUpdated:Date.now(),unreadCount:0},i={...r,messages:[...r.messages,u],lastUpdated:Date.now()},d={...o,[s]:i};return _(i),d})}},ge=async(t,e,f)=>{if(!s)return;const h=Math.ceil(e.size/V),p=await e.arrayBuffer();M(s,{type:"file_start",fileId:t,fileName:e.name,fileSize:e.size,mimeType:e.type,totalChunks:h,messageType:f});const u={id:t,senderId:k,content:e.name,timestamp:Date.now(),status:"sending",type:f,file:{name:e.name,size:e.size,mimeType:e.type,data:new Blob([p])}};g(o=>{const r=o[s]||{peerId:s,messages:[],lastUpdated:Date.now(),unreadCount:0},i={...r,messages:[...r.messages,u],lastUpdated:Date.now()};return{...o,[s]:i}});for(let o=0;o<h;o++){const r=o*V,i=Math.min(r+V,e.size),d=p.slice(r,i);M(s,{type:"file_chunk",fileId:t,chunkIndex:o,data:d});const y=Math.round((o+1)/h*100);K({fileId:t,progress:y}),await new Promise(S=>setTimeout(S,10))}M(s,{type:"file_end",fileId:t}),g(o=>{const r=o[s];if(!r)return o;const i=r.messages.map(y=>y.id===t?{...y,status:"sent"}:y),d={...r,messages:i};return _(d),{...o,[s]:d}}),K(null)},he=t=>{s&&M(s,{type:"typing",isTyping:t})},ye=t=>{if(!s)return;const e=x[s];if(!e)return;const f=e.messages.find(p=>p.id===t);if(!f||f.status!=="failed")return;M(s,{id:f.id,content:f.content,timestamp:f.timestamp})&&(g(p=>{const u=p[s];if(!u)return p;const o=u.messages.map(i=>i.id===t?{...i,status:"sent"}:i),r={...u,messages:o};return _(r),{...p,[s]:r}}),setTimeout(()=>{g(p=>{const u=p[s];if(!u)return p;const o=u.messages.find(r=>r.id===t);if(o&&o.status==="sent"){const r=u.messages.map(d=>d.id===t?{...d,status:"failed"}:d),i={...u,messages:r};return _(i),{...p,[s]:i}}return p})},1e4))},xe=()=>{s&&(M(s,{type:"sync_request"}),R("outgoing"),E(s))},be=()=>{C&&M(C,{type:"sync_cancel"}),R("idle"),E(null)},Se=()=>{if(!C)return;const t=x[C],e=t?t.messages:[];R("outgoing"),j({phase:"Sending",count:e.length}),M(C,{type:"sync_data_initial",messages:e}),setTimeout(()=>{R("idle"),E(null),j(null)},800)},we=()=>{C&&(M(C,{type:"sync_reject"}),R("idle"),E(null))},re=t=>{ee(t),b(t),N(!1)},Ce=()=>{s&&confirm("Are you sure you want to delete this conversation?")&&(te(s),g(t=>{const e={...t};return delete e[s],Te(s),e}),b(null))},ae=(t,e)=>{g(f=>{const h=f[t];if(!h)return f;const p={...h,name:e.trim()===""?void 0:e.trim()};return _(p),{...f,[t]:p}})},je=()=>{b(null),N(!1)},Ne=Object.keys(Z).filter(t=>Z[t]==="connected");return L?c.jsxs("div",{className:"flex h-screen overflow-hidden bg-slate-950 text-slate-100 font-sans selection:bg-primary-500/30 relative",children:[ne&&c.jsx("div",{className:"absolute bottom-6 left-1/2 -translate-x-1/2 z-50 animate-in fade-in slide-in-from-bottom-4",children:c.jsxs("div",{className:"bg-red-500/10 border border-red-500/50 backdrop-blur-md text-red-200 px-4 py-3 rounded-lg shadow-xl flex items-center gap-3",children:[c.jsx("span",{className:"text-sm font-medium",children:ne}),c.jsx("button",{onClick:me,className:"p-1 hover:bg-red-500/20 rounded-full transition-colors",children:c.jsx(ce,{className:"w-4 h-4"})})]})}),F&&c.jsx("div",{className:"absolute bottom-20 left-1/2 -translate-x-1/2 z-50 animate-in fade-in slide-in-from-bottom-4",children:c.jsxs("div",{className:"bg-yellow-500/10 border border-yellow-500/50 backdrop-blur-md text-yellow-200 px-4 py-3 rounded-lg shadow-xl flex items-center gap-3",children:[c.jsx("span",{className:"text-sm font-medium",children:F}),c.jsx("button",{onClick:()=>B(null),className:"p-1 hover:bg-yellow-500/20 rounded-full transition-colors",children:c.jsx(ce,{className:"w-4 h-4"})})]})}),c.jsx("div",{className:`
        ${s||P?"hidden md:flex":"flex"}
        w-full md:w-80 flex-col border-r border-slate-800
      `,children:c.jsx(Ue,{myId:k,chats:x,activeConnections:Ne,selectedPeerId:s,onSelectPeer:t=>{b(t),N(!1),Z[t]!=="connected"&&ee(t)},onConnect:re,onUpdateId:$,onRenameChat:ae,onShowDashboard:()=>N(!0),peerError:se,isReady:oe,onRetry:()=>$(k),onRandomId:()=>$(q()),onOpenSettings:()=>G(!0)})}),c.jsx("div",{className:`
        ${s||P?"flex":"hidden md:flex"}
        flex-1 flex-col min-w-0 bg-slate-950
      `,children:c.jsx(Ae,{myId:k,peerId:s||"",session:s?x[s]:void 0,connectionState:s&&Z[s]||"disconnected",onSendMessage:pe,onDeleteChat:Ce,onBack:je,onConnect:()=>s&&re(s),onCancelConnection:()=>s&&te(s),isReady:oe,activeConnectionsCount:fe,totalChats:Object.keys(x).length,isPeerTyping:s?X[s]:!1,onTyping:he,peerError:se,onRetry:()=>$(k),onRandomId:()=>$(q()),onUpdateId:$,onRenameChat:t=>s&&ae(s,t),onResendMessage:ye,onRequestSync:xe,onSendFileChunked:ge,sendingProgress:H,receivingProgress:Q})}),O==="outgoing"&&c.jsx("div",{className:"fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4",children:c.jsxs("div",{className:"bg-slate-900 border border-slate-700 rounded-xl p-6 max-w-sm w-full shadow-xl",children:[c.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[c.jsx("div",{className:"animate-spin",children:c.jsx(ke,{className:"w-6 h-6 text-primary-400"})}),c.jsxs("div",{children:[c.jsx("h3",{className:"text-lg font-medium text-white",children:T?T.phase:"Waiting for confirmation..."}),T&&c.jsxs("p",{className:"text-sm text-slate-400",children:[T.count," messages"]})]})]}),T?c.jsx("div",{className:"mb-4",children:c.jsx("div",{className:"h-2 bg-slate-700 rounded-full overflow-hidden",children:c.jsx("div",{className:"h-full bg-primary-500 animate-pulse w-full"})})}):c.jsx("p",{className:"text-slate-400 mb-4",children:"Asking peer to authorize history sync."}),c.jsx("button",{onClick:be,className:"w-full py-2 bg-slate-800 hover:bg-slate-700 text-white rounded-lg transition-colors",children:"Cancel"})]})}),O==="incoming"&&c.jsx("div",{className:"fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4",children:c.jsxs("div",{className:"bg-slate-900 border border-slate-700 rounded-xl p-6 max-w-sm w-full shadow-xl",children:[c.jsx("h3",{className:"text-lg font-medium text-white mb-2",children:"Sync Request"}),c.jsxs("p",{className:"text-slate-400 mb-6",children:[c.jsx("span",{className:"font-mono text-primary-400",children:((ie=x[C||""])==null?void 0:ie.name)||(C==null?void 0:C.slice(0,8))}),"wants to sync chat history. This will merge messages on both devices."]}),c.jsxs("div",{className:"flex gap-3",children:[c.jsx("button",{onClick:we,className:"flex-1 py-2 bg-slate-800 hover:bg-slate-700 text-slate-300 rounded-lg transition-colors",children:"Decline"}),c.jsx("button",{onClick:Se,className:"flex-1 py-2 bg-primary-600 hover:bg-primary-500 text-white rounded-lg transition-colors",children:"Allow"})]})]})}),A&&c.jsx(ze,{config:z,onSave:a,onClose:()=>G(!1)})]}):c.jsx("div",{className:"h-screen w-screen flex items-center justify-center bg-slate-950 text-white",children:"Initializing..."})}const de=document.getElementById("root");if(!de)throw new Error("Could not find root element to mount to");const Le=Me.createRoot(de);Le.render(c.jsx(_e.StrictMode,{children:c.jsx(Be,{})}));export{ue as D,V as F,Ze as M,Ke as g};
