import{r as m,K as Fe,$ as bt,j as a,X as Ge,z as $e,N as st,O as ve,Q as St,T as Ct,V as Nt,W as jt,Y as kt,Z as Ye,_ as It,a0 as Ke,a1 as Rt,P as Pt,a2 as Se,a3 as Dt}from"./vendor-oXHEIvo-.js";import{c as Tt,v as Mt,d as Et,e as Gt,a as _t,b as ze,i as Be,g as Ve,f as Je,h as Ue,j as At}from"./services/crypto-DOdyDEE6.js";import{g as Ze,s as Qe,a as et,b as qt,d as Kt,e as rt,f as Ut,h as ie,i as Ot}from"./services/db-DWyvzVjS.js";import{d as Lt,s as at,g as Pe,a as _e,b as $t,e as Yt}from"./services/storage-CphQKvNS.js";import{C as Ft}from"./components/chatsidebar-C85qs3qO.js";import{C as Wt}from"./components/chatwindow-6yNVRvCK.js";import{S as Ht}from"./components/settingsmodal-L9KEVif4.js";import{S as Xt}from"./components/syncmodal-875jDdAX.js";import{K as zt}from"./components/keychangewarningmodal-f3HN16Ss.js";import"./index-D_R22nPJ.js";import"./components/sessionswitcher-C3O8cDT3.js";import"./components/newsessiondialog-DH_rFNaV.js";import"./components/gameselector-C5mZUsWQ.js";import"./components/gamecontainer-EqE2aok0.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const i of o.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&n(i)}).observe(document,{childList:!0,subtree:!0});function t(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerPolicy&&(o.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?o.credentials="include":s.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function n(s){if(s.ep)return;s.ep=!0;const o=t(s);fetch(s.href,o)}})();function Dn(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}function Bt({sessionId:r,onKeyChange:e}){const[t,n]=m.useState(!1),[s,o]=m.useState(null),[i,u]=m.useState(null),l=m.useRef(null),h=m.useRef(null),c=m.useRef(new Map),[,I]=m.useState({}),j=m.useCallback(()=>I({}),[]);m.useEffect(()=>{if(!r)return;(async()=>{try{const x=await qt(r);if(x){const G=await Be({publicKey:x.identityPubKey,privateKey:x.identityPrivKey});l.current=G}else{const G=await At();l.current=G;const Z=await ze(G),ne={sessionId:r,identityPubKey:Z.publicKey,identityPrivKey:Z.privateKey,createdAt:Date.now()};await et(ne)}h.current=await Ue();const S=await Ve(l.current.publicKey),_=await Je(l.current.publicKey);o(S),u(_),n(!0)}catch(x){console.error("Failed to initialize encryption:",x)}})()},[r]);const q=m.useCallback(async()=>!l.current||!h.current?null:Tt(l.current,h.current),[]),p=m.useCallback(async(f,x)=>{if(!h.current)return!1;try{const S=await Mt(x);if(!S.valid||!S.sessionKey||!S.fingerprint)return console.warn("Invalid key exchange from",f),!1;const _=await Et(h.current.privateKey,S.sessionKey),G=await Ze(f);let Z=!1;G&&G.fingerprint!==S.fingerprint&&(Z=!0,e&&e(f,G.fingerprint,S.fingerprint)),c.current.set(f,{sessionKey:_,fingerprint:S.fingerprint,verified:(G==null?void 0:G.verified)||!1,keyChanged:Z});const ne={peerId:f,identityPubKey:x.identityPubKey,fingerprint:S.fingerprint,firstSeen:(G==null?void 0:G.firstSeen)||Date.now(),lastSeen:Date.now(),verified:(G==null?void 0:G.verified)||!1};return await Qe(ne),j(),!0}catch(S){return console.error("Key exchange failed:",S),!1}},[e,j]),M=m.useCallback(async(f,x)=>{const S=c.current.get(f);if(!(S!=null&&S.sessionKey))return console.warn("No session key for peer:",f),null;try{return await Gt(x,S.sessionKey)}catch(_){return console.error("Encryption failed:",_),null}},[]),R=m.useCallback(async(f,x)=>{const S=c.current.get(f);if(!(S!=null&&S.sessionKey))return console.warn("No session key for peer:",f),null;try{return await _t(x,S.sessionKey)}catch(_){return console.error("Decryption failed:",_),null}},[]),L=m.useCallback(f=>{var x;return((x=c.current.get(f))==null?void 0:x.fingerprint)||null},[]),K=m.useCallback(f=>{var x;return c.current.has(f)&&((x=c.current.get(f))==null?void 0:x.sessionKey)!==null},[]),Y=m.useCallback(async f=>{const x=c.current.get(f);if(!x)return;x.verified=!0,x.keyChanged=!1;const S=await Ze(f);S&&(S.verified=!0,await Qe(S)),j()},[j]),w=m.useCallback(async()=>{if(!l.current)return null;try{const f=await ze(l.current);return JSON.stringify({sessionId:r,keys:f,exportedAt:Date.now()},null,2)}catch(f){return console.error("Failed to export keys:",f),null}},[r]),P=m.useCallback(async f=>{var x,S;try{const _=JSON.parse(f);if(!((x=_.keys)!=null&&x.publicKey)||!((S=_.keys)!=null&&S.privateKey))throw new Error("Invalid key format");const G=await Be(_.keys);l.current=G;const Z={sessionId:r,identityPubKey:_.keys.publicKey,identityPrivKey:_.keys.privateKey,createdAt:_.exportedAt||Date.now()};await et(Z);const ne=await Ve(G.publicKey),me=await Je(G.publicKey);return o(ne),u(me),h.current=await Ue(),!0}catch(_){return console.error("Failed to import keys:",_),!1}},[r]),b=m.useCallback(async()=>{h.current=await Ue(),c.current.clear(),j()},[j]);return{isReady:t,myFingerprint:s,myShortFingerprint:i,identityKeyPair:l.current,sessionKeyPair:h.current,peerStates:c.current,createKeyExchange:q,handleKeyExchange:p,encrypt:M,decrypt:R,getPeerFingerprint:L,hasPeerKey:K,markPeerVerified:Y,exportMyKeys:w,importMyKeys:P,regenerateSessionKey:b}}function Tn(r){return`${window.location.origin}${window.location.pathname}#connect=${r}`}function Vt(){const r=window.location.hash;let e=null;return r.startsWith("#connect=")&&(e=r.slice(9),window.history.replaceState(null,"",window.location.pathname+window.location.search)),{pendingConnect:e}}const Ae={host:"fbaio.xyz",port:443,path:"/peer",secure:!0,debug:3},ot=50,{pendingConnect:Jt}=Vt(),Zt=()=>{try{const r=localStorage.getItem("peer_config");return r?JSON.parse(r):Ae}catch{return Ae}},Qt=Fe((r,e)=>({chats:{},isStorageReady:!1,typingStates:{},sessions:[],activeSessionId:"",peerConfig:Zt(),selectedPeerId:null,showMobileDashboard:!1,showSettings:!1,showNewSessionDialog:!1,pendingConnectPeerId:Jt,setChats:t=>r(n=>({chats:typeof t=="function"?t(n.chats):t})),setIsStorageReady:t=>r({isStorageReady:t}),setTypingStates:t=>r(n=>({typingStates:typeof t=="function"?t(n.typingStates):t})),setSessions:t=>r(n=>({sessions:typeof t=="function"?t(n.sessions):t})),setActiveSessionId:t=>r({activeSessionId:t}),setPeerConfig:t=>{localStorage.setItem("peer_config",JSON.stringify(t)),r({peerConfig:t})},setSelectedPeerId:t=>r({selectedPeerId:t}),setShowMobileDashboard:t=>r({showMobileDashboard:t}),setShowSettings:t=>r({showSettings:t}),setShowNewSessionDialog:t=>r({showNewSessionDialog:t}),setPendingConnectPeerId:t=>r({pendingConnectPeerId:t}),selectChat:t=>r({selectedPeerId:t,showMobileDashboard:!1}),backToSidebar:()=>r({selectedPeerId:null,showMobileDashboard:!1}),renameChat:(t,n)=>{const s=e(),o=s.chats[t];if(!o)return;const i={...o,name:n.trim()===""?void 0:n.trim()};ie(s.activeSessionId,i),r({chats:{...s.chats,[t]:i}})},deleteChat:(t,n)=>{const s=e();if(t&&confirm("Are you sure you want to delete this conversation?")){n(t);const o={...s.chats};delete o[t],Ut(s.activeSessionId,t),r({chats:o,selectedPeerId:null})}},switchSession:async t=>{const n=e();if(t!==n.activeSessionId){r({selectedPeerId:null,chats:{}}),_e(t),r({activeSessionId:t});try{const s=await rt(t);r({chats:s})}catch(s){console.error("Failed to load chats for session:",s)}}},createNewSession:async()=>{const t=e(),n=Pe(),s={id:n,createdAt:Date.now()};at(s);const o=[...t.sessions,s];_e(n),r({sessions:o,activeSessionId:n,chats:{},selectedPeerId:null,showNewSessionDialog:!1})},deleteSession:async t=>{const n=e();if(t!==n.activeSessionId){Lt(t);try{await Kt(t)}catch(s){console.error("Failed to delete chats for session:",s)}r({sessions:n.sessions.filter(s=>s.id!==t)})}}}));let oe=null;const ee=new Map,he=[];let tt=Ae;const Oe={message:new Set,connectionOpened:new Set,connectionClosed:new Set,connectionLimitExceeded:new Set},we=Fe((r,e)=>({myId:"",isReady:!1,isReconnecting:!1,peerError:null,connectionStates:{},activeConnectionsCount:0,addListener:(t,n)=>(Oe[t].add(n),()=>Oe[t].delete(n)),emit:(t,n,s)=>{Oe[t].forEach(o=>o(n,s))},updatePeerState:(t,n)=>r(s=>({connectionStates:{...s.connectionStates,[t]:n}})),handleConnection:t=>{e().updatePeerState(t.peer,"connecting"),t.on("open",()=>{const s=e();if(ee.size>=ot){const o=he[0];if(o){const i=ee.get(o);i&&i.close(),ee.delete(o);const u=he.indexOf(o);u>-1&&he.splice(u,1),s.updatePeerState(o,"disconnected"),s.emit("connectionClosed",o),s.emit("connectionLimitExceeded",o)}}ee.set(t.peer,t),he.push(t.peer),s.updatePeerState(t.peer,"connected"),s.emit("connectionOpened",t.peer),r({activeConnectionsCount:Array.from(ee.values()).filter(o=>o==null?void 0:o.open).length}),t.send({type:"presence",status:"online"})}),t.on("data",s=>{const o=e();s&&typeof s=="object"&&s.type==="presence"||o.emit("message",t.peer,s)}),t.on("close",()=>{const s=e();ee.delete(t.peer);const o=he.indexOf(t.peer);o>-1&&he.splice(o,1),s.updatePeerState(t.peer,"disconnected"),s.emit("connectionClosed",t.peer),r({activeConnectionsCount:Array.from(ee.values()).filter(i=>i==null?void 0:i.open).length})}),t.on("error",s=>{console.error("Connection-specific error:",s),ee.delete(t.peer),e().updatePeerState(t.peer,"failed")})},initPeer:(t,n=Ae)=>{tt=n,r({isReconnecting:!0,myId:t});const s=window.Peer||bt,o={iceServers:[{urls:"turns:global.relay.metered.ca:443?transport=tcp",username:"85255418786a1fec898fa979",credential:"gePlRCYyZJ2VMswp"},{urls:"turn:global.relay.metered.ca:443",username:"85255418786a1fec898fa979",credential:"gePlRCYyZJ2VMswp"},{urls:"turn:global.relay.metered.ca:80?transport=tcp",username:"85255418786a1fec898fa979",credential:"gePlRCYyZJ2VMswp"},{urls:"turn:global.relay.metered.ca:80",username:"85255418786a1fec898fa979",credential:"gePlRCYyZJ2VMswp"},{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"},{urls:"stun:stun.relay.metered.ca:80"}],iceCandidatePoolSize:10};console.log("[P2P Store] Initializing with RTCConfig:",o);const i=new s(t,{host:n.host,port:n.port,path:n.path,secure:n.secure,debug:n.debug||0,config:o});i.on("open",l=>{console.log("My Peer ID is: "+l),r({isReady:!0,isReconnecting:!1,peerError:null})}),i.on("connection",l=>{e().handleConnection(l)}),i.on("disconnected",()=>{console.log("Peer disconnected from server."),r({isReady:!1}),setTimeout(()=>{oe&&!oe.destroyed&&(console.log("Attempting to reconnect..."),r({isReconnecting:!0}),oe.reconnect())},3e3)}),i.on("error",l=>{if(console.error("PeerJS error:",l),r({isReconnecting:!1}),l.type==="unavailable-id")r({peerError:"ID is already taken. Please choose another.",isReady:!1});else if(l.message&&l.message.includes("is taken"))r({peerError:`ID is taken: ${l.message}`,isReady:!1});else if(l.type==="peer-unavailable"){const c=(l.message||"").match(/Could not connect to peer (.*)/);c&&c[1]&&e().updatePeerState(c[1],"failed")}else l.type==="network"||l.type==="disconnected"?(r({isReady:!1,peerError:"Network error. Reconnecting..."}),setTimeout(()=>{oe&&!oe.destroyed&&(r({isReconnecting:!0}),oe.reconnect())},3e3)):r({peerError:"Connection error: "+(l.message||"Unknown error")})}),oe=i;const u=()=>{i==null||i.destroy()};window.addEventListener("beforeunload",u)},destroyPeer:()=>{oe&&(oe.destroy(),oe=null),ee.clear(),he.length=0,r({connectionStates:{},isReady:!1,activeConnectionsCount:0})},connectToPeer:t=>{const n=e();if(!(!oe||!n.isReady)){if(ee.has(t)){const s=ee.get(t);if(s!=null&&s.open){n.updatePeerState(t,"connected");return}}n.updatePeerState(t,"connecting");try{const s=oe.connect(t,{reliable:!0});n.handleConnection(s),setTimeout(()=>{r(o=>o.connectionStates[t]==="connecting"?{connectionStates:{...o.connectionStates,[t]:"failed"}}:o)},1e4)}catch(s){console.error("Connect error",s),n.updatePeerState(t,"failed")}}},disconnectPeer:t=>{const n=ee.get(t);n&&(n.close(),ee.delete(t));const s=he.indexOf(t);s>-1&&he.splice(s,1),e().updatePeerState(t,"disconnected"),r({activeConnectionsCount:Array.from(ee.values()).filter(o=>o==null?void 0:o.open).length})},sendMessage:(t,n)=>{const s=ee.get(t);return s&&s.open?(s.send(n),!0):!1},updateId:(t,n)=>{const s=e();!t||t===s.myId||(s.destroyPeer(),r({peerError:null}),s.initPeer(t,n||tt))}})),Le=64*1024,Mn=50*1024*1024;class en{constructor(){this.gameClasses=new Map,this.gameDefinitionCache=new Map}register(e){const t=new e,n=t.gameId;if(this.gameClasses.has(n)){console.warn(`Game ${n} is already registered, skipping...`);return}this.gameClasses.set(n,e),this.gameDefinitionCache.set(n,t.getDefinition())}createInstance(e){const t=this.gameClasses.get(e);return t?new t:(console.warn(`Game ${e} not found in registry`),null)}getAllDefinitions(){return Array.from(this.gameDefinitionCache.values())}has(e){return this.gameClasses.has(e)}getDefinition(e){return this.gameDefinitionCache.get(e)}}const ce=new en;class De{getDefinition(){return{id:this.gameId,name:this.gameName,icon:this.gameIcon,description:this.gameDescription,minPlayers:2,maxPlayers:2}}getStateSnapshot(e){return e}applyStateSnapshot(e,t){return t}}function tn({state:r,myId:e,onMove:t,onSwitchTurn:n,isMyTurn:s}){const{board:o}=r.data,u=e===r.hostId?"X":"O",{leaveGame:l}=be(),c=(()=>{const p=[[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];for(const M of p){const[R,L,K]=M;if(o[R]&&o[R]===o[L]&&o[R]===o[K])return M}return null})(),j=(()=>{for(let p=o.length-1;p>=0;p--)if(o[p]!==null)return p;return null})(),q=p=>{!s||o[p]||r.status!=="playing"||t(p)};return a.jsxs("div",{className:"flex flex-col items-center gap-6 p-4 w-full max-w-sm mx-auto",children:[a.jsxs("div",{className:"flex flex-col items-center gap-2",children:[a.jsx("div",{className:"text-xl font-bold flex items-center gap-2",children:r.status==="finished"?r.winner?a.jsx("span",{className:r.winner===e?"text-green-400":"text-red-400",children:r.winner===e?"You Won!":"Opponent Won!"}):a.jsx("span",{className:"text-yellow-400",children:"Draw!"}):a.jsx("span",{className:s?"text-primary-400":"text-slate-400",children:s?"Your Turn":"Opponent's Turn"})}),a.jsxs("div",{className:"text-sm text-slate-500 flex items-center gap-4",children:[a.jsxs("span",{className:"flex items-center gap-1",children:[a.jsx(Ge,{className:"w-4 h-4 text-blue-400"})," You: ",u]}),a.jsxs("span",{className:"flex items-center gap-1",children:[a.jsx($e,{className:"w-4 h-4 text-red-400"})," Opponent:"," ",u==="X"?"O":"X"]})]}),r.status==="playing"&&o.every(p=>p===null)&&s&&a.jsxs("button",{onClick:n,className:"px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-slate-300 text-sm font-medium transition-colors flex items-center gap-2",title:"Give first move to opponent",children:[a.jsx(st,{className:"w-4 h-4"}),"Give First Move"]})]}),a.jsx("div",{className:"grid grid-cols-3 gap-3 bg-slate-800 p-3 rounded-xl relative",children:o.map((p,M)=>{const R=c==null?void 0:c.includes(M),L=j===M,K=s&&!p&&r.status==="playing";return a.jsxs("button",{onClick:()=>q(M),disabled:!K,className:`
                w-20 h-20 sm:w-24 sm:h-24 rounded-lg flex items-center justify-center text-4xl transition-all
                ${p?"bg-slate-700 shadow-inner":"bg-slate-750 hover:bg-slate-700"}
                ${R?"bg-green-500/20 ring-2 ring-green-500":""}
                ${L&&!R?"bg-amber-500/20 ring-2 ring-amber-500/50":""}
                ${K?"cursor-pointer hover:ring-2 hover:ring-primary-500/50":"cursor-default"}
              `,children:[p==="X"&&a.jsx(Ge,{className:`w-12 h-12 ${R?"text-green-400":"text-blue-400"}`,strokeWidth:2.5}),p==="O"&&a.jsx($e,{className:`w-10 h-10 ${R?"text-green-400":"text-red-400"}`,strokeWidth:2.5})]},M)})}),r.status==="finished"&&a.jsxs("div",{className:"flex gap-3 w-full",children:[a.jsx("button",{onClick:()=>be.getState().restartGame(),className:"flex-1 py-3 bg-primary-600 hover:bg-primary-500 rounded-lg text-white font-medium transition-colors shadow-lg shadow-primary-900/20",children:"Play Again"}),a.jsx("button",{onClick:l,className:"flex-1 py-3 bg-slate-800 hover:bg-slate-700 rounded-lg text-slate-300 font-medium transition-colors",children:"Close Game"})]})]})}const nn=[[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];class sn extends De{constructor(){super(...arguments),this.gameId="tictactoe",this.gameName="Tic-Tac-Toe",this.gameIcon="â­•",this.gameDescription="Classic 3x3 strategy game"}createInitialState(e,t){return{board:Array(9).fill(null),currentTurn:e,winningLine:null}}handleInput(e,t,n,s){if(t.action==="switchTurn"){const{board:I,currentTurn:j}=e.data;if(I.some(p=>p!==null)||n!==j)return e;const q=n===e.hostId?e.clientId:e.hostId;return{...e,data:{...e.data,currentTurn:q},updatedAt:Date.now()}}const{cellIndex:o}=t;if(o===void 0)return e;const{board:i,currentTurn:u}=e.data;if(o<0||o>8||i[o]!==null||e.winner||n!==u)return e;const l=n===e.hostId?"X":"O",h=[...i];h[o]=l;const c=n===e.hostId?e.clientId:e.hostId;return{...e,data:{...e.data,board:h,currentTurn:c},updatedAt:Date.now()}}checkGameEnd(e){const{board:t}=e.data;for(const n of nn){const[s,o,i]=n;if(t[s]&&t[s]===t[o]&&t[s]===t[i])return{isEnded:!0,winner:t[s]==="X"?e.hostId:e.clientId,isDraw:!1}}return t.every(n=>n!==null)?{isEnded:!0,winner:null,isDraw:!0}:{isEnded:!1,winner:null,isDraw:!1}}render(e,t,n,s){const o=e.data.currentTurn===t;return ve.createElement(tn,{state:e,myId:t,onMove:i=>s({action:"move",cellIndex:i}),onSwitchTurn:()=>s({action:"switchTurn"}),isMyTurn:o})}}const nt=["#ef4444","#3b82f6","#22c55e","#eab308","#a855f7","#ec4899","#000000"];function rn({state:r,myId:e,onAction:t}){const n=m.useRef(null),[s,o]=m.useState(!1),[i,u]=m.useState(nt[0]),[l,h]=m.useState([]),{leaveGame:c}=be();r.hostId,m.useEffect(()=>{const w=n.current;if(!w)return;const P=w.getContext("2d");P&&(P.clearRect(0,0,w.width,w.height),r.data.strokes.forEach(b=>{if(!(b.points.length<2)){P.strokeStyle=b.color,P.lineWidth=b.width,P.lineCap="round",P.lineJoin="round",P.beginPath(),P.moveTo(b.points[0].x,b.points[0].y);for(let f=1;f<b.points.length;f++)P.lineTo(b.points[f].x,b.points[f].y);P.stroke()}}))},[r.data.strokes]);const I=w=>{const P=n.current,b=P.getBoundingClientRect(),f=w.clientX-b.left,x=w.clientY-b.top,S=P.width/b.width,_=P.height/b.height;return{x:f*S,y:x*_}},j=w=>{o(!0);const P=I(w);h([P])},q=w=>{if(!s)return;const P=I(w);h(x=>[...x,P]);const f=n.current.getContext("2d");l.length>0&&(f.strokeStyle=i,f.lineWidth=3,f.lineCap="round",f.lineJoin="round",f.beginPath(),f.moveTo(l[l.length-1].x,l[l.length-1].y),f.lineTo(P.x,P.y),f.stroke())},p=()=>{if(!s||l.length<2){o(!1),h([]);return}const w={id:`${e}_${Date.now()}`,playerId:e,points:l,color:i,width:3};t({type:"draw",stroke:w}),o(!1),h([])},M=w=>{const P=n.current,b=P.getBoundingClientRect(),f=w.touches[0]||w.changedTouches[0],x=f.clientX-b.left,S=f.clientY-b.top,_=P.width/b.width,G=P.height/b.height;return{x:x*_,y:S*G}},R=w=>{o(!0);const P=M(w);h([P])},L=w=>{if(!s)return;const P=M(w);h(x=>[...x,P]);const f=n.current.getContext("2d");l.length>0&&(f.strokeStyle=i,f.lineWidth=3,f.lineCap="round",f.lineJoin="round",f.beginPath(),f.moveTo(l[l.length-1].x,l[l.length-1].y),f.lineTo(P.x,P.y),f.stroke())},K=()=>{if(!s||l.length<2){o(!1),h([]);return}const w={id:`${e}_${Date.now()}`,playerId:e,points:l,color:i,width:3};t({type:"draw",stroke:w}),o(!1),h([])},Y=()=>{confirm("Clear the entire canvas?")&&t({type:"clear"})};return a.jsxs("div",{className:"flex flex-col items-center gap-2 md:gap-4 p-2 md:p-4 w-full h-full max-w-full md:max-w-2xl mx-auto",children:[a.jsxs("div",{className:"flex items-center gap-1.5 md:gap-2 p-1.5 md:p-2 bg-slate-800 rounded-lg w-full justify-center",children:[a.jsx(St,{className:"w-3 h-3 md:w-4 md:h-4 text-slate-400 hidden md:block"}),nt.map(w=>a.jsx("button",{onClick:()=>u(w),className:`w-7 h-7 md:w-8 md:h-8 rounded-full border-2 transition-all ${i===w?"border-white scale-110":"border-slate-600 hover:scale-105"}`,style:{backgroundColor:w},title:w},w)),a.jsx("div",{className:"w-px h-6 md:h-8 bg-slate-700 mx-0.5 md:mx-1"}),a.jsx("button",{onClick:Y,className:"p-2 hover:bg-slate-700 rounded-lg transition-colors text-slate-400 hover:text-red-400",title:"Clear canvas",children:a.jsx(Ct,{className:"w-4 h-4"})})]}),a.jsx("canvas",{ref:n,width:600,height:400,onMouseDown:j,onMouseMove:q,onMouseUp:p,onMouseLeave:p,onTouchStart:R,onTouchMove:L,onTouchEnd:K,className:"w-full flex-1 md:flex-none border-2 border-slate-700 rounded-lg bg-white cursor-crosshair touch-none",style:{aspectRatio:"3/2",minHeight:"200px"}}),a.jsxs("div",{className:"text-xs text-slate-500",children:[r.data.strokes.length," strokes"]})]})}class an extends De{constructor(){super(...arguments),this.gameId="canvas",this.gameName="Draw Together",this.gameIcon="ðŸŽ¨",this.gameDescription="Collaborative drawing canvas"}createInitialState(e,t){return{strokes:[]}}handleInput(e,t,n,s){switch(t.type){case"draw":return{...e,data:{...e.data,strokes:[...e.data.strokes,t.stroke]},updatedAt:Date.now()};case"clear":return{...e,data:{...e.data,strokes:[]},updatedAt:Date.now()};default:return e}}render(e,t,n,s){return ve.createElement(rn,{state:e,myId:t,onAction:s})}}function on({state:r,myId:e,onAction:t}){const n=m.useRef(null),[s,o]=m.useState(""),[i,u]=m.useState(!1),l=m.useRef(!1),h=e===r.hostId;m.useEffect(()=>{var R;if(window.YT){u(!0);return}const p=document.createElement("script");p.src="https://www.youtube.com/iframe_api";const M=document.getElementsByTagName("script")[0];(R=M.parentNode)==null||R.insertBefore(p,M),window.onYouTubeIframeAPIReady=()=>{u(!0)}},[]),m.useEffect(()=>{!i||!r.data.videoId||(n.current&&n.current.destroy(),n.current=new window.YT.Player("youtube-player",{videoId:r.data.videoId,playerVars:{autoplay:0,controls:1,modestbranding:1,rel:0},events:{onReady:c,onStateChange:I}}))},[i,r.data.videoId]),m.useEffect(()=>{if(!n.current||!n.current.getPlayerState||l.current)return;const p=n.current;r.data.isPlaying?p.getPlayerState()!==1&&(l.current=!0,p.playVideo(),setTimeout(()=>l.current=!1,500)):p.getPlayerState()===1&&(l.current=!0,p.pauseVideo(),setTimeout(()=>l.current=!1,500));const M=p.getCurrentTime();Math.abs(M-r.data.currentTime)>2&&(l.current=!0,p.seekTo(r.data.currentTime,!0),setTimeout(()=>l.current=!1,500))},[r.data.isPlaying,r.data.currentTime,r.updatedAt]);const c=p=>{n.current=p.target},I=p=>{if(l.current)return;const R=p.target.getCurrentTime();p.data===1?t({type:"play",time:R}):p.data===2&&t({type:"pause",time:R})},j=p=>{const M=[/(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&\n?#]+)/,/^([a-zA-Z0-9_-]{11})$/];for(const R of M){const L=p.match(R);if(L)return L[1]}return null},q=()=>{const p=j(s);p?(t({type:"load_video",videoId:p}),o("")):alert("Invalid YouTube URL or video ID")};return a.jsxs("div",{className:"flex flex-col gap-3 p-2 md:p-4 w-full h-full max-w-full md:max-w-6xl mx-auto",children:[a.jsxs("div",{className:"flex gap-2",children:[a.jsxs("div",{className:"flex-1 relative",children:[a.jsx(Nt,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"}),a.jsx("input",{type:"text",value:s,onChange:p=>o(p.target.value),onKeyDown:p=>{p.key==="Enter"&&q()},placeholder:"Paste YouTube URL or video ID...",className:"w-full pl-10 pr-4 py-2 bg-slate-800 border border-slate-700 rounded-lg text-slate-200 placeholder-slate-500 focus:outline-none focus:border-primary-500"})]}),a.jsx("button",{onClick:q,className:"px-4 py-2 bg-primary-600 hover:bg-primary-500 rounded-lg text-white font-medium transition-colors",children:"Load"})]}),r.data.videoId?a.jsx("div",{className:"relative w-full flex-1 bg-black rounded-lg overflow-hidden min-h-[400px] md:min-h-[500px]",children:a.jsx("div",{id:"youtube-player",className:"absolute inset-0",style:{width:"100%",height:"100%"}})}):a.jsx("div",{className:"flex-1 flex items-center justify-center bg-slate-800 rounded-lg border-2 border-dashed border-slate-700",children:a.jsxs("div",{className:"text-center p-8",children:[a.jsx("div",{className:"text-6xl mb-4",children:"ðŸ“º"}),a.jsx("div",{className:"text-slate-300 font-semibold mb-2",children:"No video loaded"}),a.jsx("div",{className:"text-sm text-slate-500",children:"Paste a YouTube URL above to start watching together"})]})}),a.jsxs("div",{className:"text-xs text-slate-500 flex items-center justify-between",children:[a.jsxs("span",{children:["You are ",h?"Host":"Guest"]}),r.data.videoId&&a.jsx("span",{className:"flex items-center gap-2",children:r.data.isPlaying?a.jsxs(a.Fragment,{children:[a.jsx(jt,{className:"w-3 h-3 text-green-400"}),"Playing"]}):a.jsxs(a.Fragment,{children:[a.jsx(kt,{className:"w-3 h-3 text-yellow-400"}),"Paused"]})})]})]})}class cn extends De{constructor(){super(...arguments),this.gameId="youtube",this.gameName="Watch Together",this.gameIcon="ðŸ“º",this.gameDescription="Watch YouTube videos together"}createInitialState(e,t){return{videoId:null,isPlaying:!1,currentTime:0}}handleInput(e,t,n,s){switch(t.type){case"load_video":return{...e,data:{videoId:t.videoId,isPlaying:!1,currentTime:0},updatedAt:Date.now()};case"play":return{...e,data:{...e.data,isPlaying:!0,currentTime:t.time},updatedAt:Date.now()};case"pause":return{...e,data:{...e.data,isPlaying:!1,currentTime:t.time},updatedAt:Date.now()};case"seek":return{...e,data:{...e.data,currentTime:t.time},updatedAt:Date.now()};default:return e}}render(e,t,n,s){return ve.createElement(on,{state:e,myId:t,onAction:s})}}const ye=50,xe=40;function ln({state:r,myId:e,onMove:t,onSwitchTurn:n,onUndoRequest:s,onUndoConfirm:o,onUndoDecline:i,isMyTurn:u}){const{board:l,winningLine:h,pendingUndoRequest:c}=r.data,j=e===r.hostId?"X":"O",{leaveGame:q}=be(),p=m.useRef(null),M=m.useRef(null),[R,L]=m.useState({x:20,y:20}),[K,Y]=m.useState(!1),[w,P]=m.useState({x:0,y:0,viewportX:0,viewportY:0}),[b,f]=m.useState(null),[x,S]=m.useState({width:600,height:600}),_=()=>{const D=Object.keys(l);if(D.length===0)return null;const g=D[D.length-1],[C,H]=g.split(",").map(Number);return{row:C,col:H}};m.useEffect(()=>{const D=()=>{if(M.current){const g=M.current.clientWidth,C=M.current.clientHeight;S({width:g,height:C})}};return D(),window.addEventListener("resize",D),()=>window.removeEventListener("resize",D)},[]),m.useEffect(()=>{const D=p.current;if(!D)return;const g=D.getContext("2d");if(!g)return;g.clearRect(0,0,x.width,x.height);const C=xe,H=Math.ceil(x.width/C),re=Math.ceil(x.height/C),Q=-(R.x*C)%C,se=-(R.y*C)%C,le=Math.floor(R.x),de=Math.floor(R.y);g.strokeStyle="#334155",g.lineWidth=1;for(let W=0;W<=H+1;W++){const X=Q+W*C;g.beginPath(),g.moveTo(X,0),g.lineTo(X,x.height),g.stroke()}for(let W=0;W<=re+1;W++){const X=se+W*C;g.beginPath(),g.moveTo(0,X),g.lineTo(x.width,X),g.stroke()}if(b&&u&&r.status==="playing"){const W=b.col-le,X=b.row-de;W>=0&&W<H&&X>=0&&X<re&&(g.fillStyle="rgba(148, 163, 184, 0.2)",g.fillRect(Q+W*C,se+X*C,C,C))}for(let W=0;W<H+1;W++)for(let X=0;X<re+1;X++){const ue=le+W,fe=de+X;if(ue<0||ue>=ye||fe<0||fe>=ye)continue;const z=`${fe},${ue}`,qe=l[z];if(!qe)continue;const ge=Q+W*C+C/2,ae=se+X*C+C/2,Ie=h==null?void 0:h.some(([B,Re])=>B===fe&&Re===ue),Ne=_(),je=Ne&&Ne.row===fe&&Ne.col===ue;if(je&&!Ie&&(g.fillStyle="rgba(251, 191, 36, 0.25)",g.fillRect(Q+W*C,se+X*C,C,C)),qe==="X"){g.strokeStyle=Ie?"#4ade80":"#3b82f6",g.lineWidth=je?4:3;const B=C*.3;g.beginPath(),g.moveTo(ge-B,ae-B),g.lineTo(ge+B,ae+B),g.stroke(),g.beginPath(),g.moveTo(ge+B,ae-B),g.lineTo(ge-B,ae+B),g.stroke()}else{g.strokeStyle=Ie?"#4ade80":"#ef4444",g.lineWidth=je?4:3;const B=C*.25;g.beginPath(),g.arc(ge,ae,B,0,Math.PI*2),g.stroke()}}g.fillStyle="#64748b",g.font="10px monospace",g.fillText(`(${le}, ${de})`,5,15)},[R,l,h,b,u,r.status,x]);const G=(D,g)=>{const C=p.current;if(!C)return null;const H=C.getBoundingClientRect(),re=D-H.left,Q=g-H.top,se=xe,le=Math.floor(R.x+re/se),de=Math.floor(R.y+Q/se);return le<0||le>=ye||de<0||de>=ye?null:{row:de,col:le}},Z=D=>{Y(!0),P({x:D.clientX,y:D.clientY,viewportX:R.x,viewportY:R.y})},ne=D=>{const g=G(D.clientX,D.clientY);if(f(g),K){const C=(w.x-D.clientX)/xe,H=(w.y-D.clientY)/xe;L({x:Math.max(0,Math.min(ye-1,w.viewportX+C)),y:Math.max(0,Math.min(ye-1,w.viewportY+H))})}},me=()=>{Y(!1)},Ce=()=>{Y(!1),f(null)},te=D=>{if(Math.abs(D.clientX-w.x)>5||Math.abs(D.clientY-w.y)>5||!u||r.status!=="playing")return;const g=G(D.clientX,D.clientY);if(!g)return;const C=`${g.row},${g.col}`;l[C]||t(g)},pe=D=>{const g=D.touches[0];Y(!0),P({x:g.clientX,y:g.clientY,viewportX:R.x,viewportY:R.y})},Te=D=>{const g=D.touches[0],C=G(g.clientX,g.clientY);if(f(C),K){const H=(w.x-g.clientX)/xe,re=(w.y-g.clientY)/xe;L({x:Math.max(0,Math.min(ye-1,w.viewportX+H)),y:Math.max(0,Math.min(ye-1,w.viewportY+re))})}},ke=D=>{const g=D.changedTouches[0];if(Math.abs(g.clientX-w.x)>5||Math.abs(g.clientY-w.y)>5){Y(!1),f(null);return}if(Y(!1),f(null),!u||r.status!=="playing")return;const C=G(g.clientX,g.clientY);if(!C)return;const H=`${C.row},${C.col}`;l[H]||t(C)},Me=()=>{const D=_();if(!D)return;const g=x.width/xe,C=x.height/xe,H=Math.max(0,D.col-g/2+.5),re=Math.max(0,D.row-C/2+.5),Q=R.x,se=R.y,le=performance.now(),de=300,W=X=>{const ue=X-le,fe=Math.min(ue/de,1),z=1-Math.pow(1-fe,3);L({x:Q+(H-Q)*z,y:se+(re-se)*z}),fe<1&&requestAnimationFrame(W)};requestAnimationFrame(W)};return a.jsxs("div",{className:"flex flex-col gap-3 p-2 md:p-4 w-full h-full",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("div",{className:"text-sm font-semibold",children:r.status==="finished"?r.winner?a.jsx("span",{className:r.winner===e?"text-green-400":"text-red-400",children:r.winner===e?"You Won!":"Opponent Won!"}):a.jsx("span",{className:"text-yellow-400",children:"Draw!"}):a.jsx("span",{className:u?"text-primary-400":"text-slate-400",children:u?"Your Turn":"Opponent's Turn"})}),a.jsxs("div",{className:"text-xs text-slate-500 flex items-center gap-2",children:[a.jsxs("span",{className:"flex items-center gap-1",children:[a.jsx(Ge,{className:"w-3 h-3 text-blue-400"})," ",j==="X"?"You":"Opp"]}),a.jsxs("span",{className:"flex items-center gap-1",children:[a.jsx($e,{className:"w-3 h-3 text-red-400"})," ",j==="O"?"You":"Opp"]})]})]}),a.jsxs("div",{className:"flex gap-1 md:gap-2 text-xs",children:[r.status==="finished"?a.jsxs("button",{onClick:()=>be.getState().restartGame(),className:"px-2 py-1 bg-primary-600 hover:bg-primary-500 rounded text-white flex items-center gap-1",title:"New game",children:[a.jsx(Ye,{className:"w-3 h-3"}),a.jsx("span",{children:"New Game"})]}):Object.keys(l).length>0?a.jsxs("button",{onClick:Me,disabled:Object.keys(l).length===0,className:"px-2 py-1 bg-slate-800 hover:bg-slate-700 rounded text-slate-300 flex items-center gap-1 disabled:opacity-50 disabled:cursor-not-allowed",title:"Focus to last move",children:[a.jsx(It,{className:"w-3 h-3"}),a.jsx("span",{children:"Last"})]}):null,r.status==="playing"&&Object.keys(l).length>0&&!u&&!c&&a.jsxs("button",{onClick:s,className:"px-2 py-1 bg-slate-800 hover:bg-slate-700 rounded text-slate-300 flex items-center gap-1",title:"Request undo from opponent",children:[a.jsx(Ke,{className:"w-3 h-3"}),a.jsx("span",{children:"Undo"})]}),r.status==="playing"&&Object.keys(l).length===0&&u&&a.jsxs("button",{onClick:n,className:"px-2 py-1 bg-slate-800 hover:bg-slate-700 rounded text-slate-300 flex items-center gap-1",title:"Give first move to opponent",children:[a.jsx(st,{className:"w-3 h-3"}),a.jsx("span",{children:"Give First Move"})]})]})]}),c&&a.jsxs("div",{className:"px-3 py-2 bg-slate-800/50 rounded-lg border border-slate-700",children:[c===e&&a.jsxs("div",{className:"flex items-center justify-center gap-2 text-sm text-amber-400",children:[a.jsx(Ke,{className:"w-4 h-4 animate-pulse"}),a.jsx("span",{children:"Waiting for opponent to respond to undo request..."})]}),c!==e&&a.jsxs("div",{className:"flex items-center justify-between gap-3",children:[a.jsxs("div",{className:"flex items-center gap-2 text-sm text-slate-300",children:[a.jsx(Ke,{className:"w-4 h-4 text-amber-400"}),a.jsx("span",{children:"Opponent is requesting to undo their last move"})]}),a.jsxs("div",{className:"flex gap-2",children:[a.jsx("button",{onClick:o,className:"px-3 py-1.5 bg-green-600 hover:bg-green-500 rounded text-white text-sm font-medium flex items-center gap-1.5",title:"Allow undo",children:a.jsx("span",{children:"Allow"})}),a.jsx("button",{onClick:i,className:"px-3 py-1.5 bg-red-600 hover:bg-red-500 rounded text-white text-sm font-medium flex items-center gap-1.5",title:"Deny undo",children:a.jsx("span",{children:"Deny"})})]})]})]}),a.jsx("div",{ref:M,className:"flex-1 min-h-0",children:a.jsx("canvas",{ref:p,width:x.width,height:x.height,className:"w-full h-full border-2 border-slate-700 rounded-lg bg-slate-900 cursor-move touch-none",onMouseDown:Z,onMouseMove:ne,onMouseUp:me,onMouseLeave:Ce,onClick:te,onTouchStart:pe,onTouchMove:Te,onTouchEnd:ke})}),a.jsx("div",{className:"text-xs text-slate-500 text-center",children:"Drag to pan â€¢ Click to place"})]})}class dn extends De{constructor(){super(...arguments),this.gameId="caro",this.gameName="Caro (Gomoku)",this.gameIcon="âŒ",this.gameDescription="5-in-a-row on large board",this.BOARD_SIZE=50,this.WIN_LENGTH=5}createInitialState(e,t){return{board:{},currentTurn:e,winningLine:null,pendingUndoRequest:null}}handleInput(e,t,n,s){if(t.action==="undoRequest"){const{board:j,currentTurn:q,pendingUndoRequest:p}=e.data;return Object.keys(j).length===0||p||n===q?e:{...e,data:{...e.data,pendingUndoRequest:n},updatedAt:Date.now()}}if(t.action==="undoConfirm"){const{board:j,currentTurn:q,pendingUndoRequest:p}=e.data;if(!p||n!==q)return e;const M=Object.keys(j);if(M.length===0)return e;const R=M[M.length-1],L={...j};delete L[R];const K=q===e.hostId?e.clientId:e.hostId;return{...e,data:{...e.data,board:L,currentTurn:K,pendingUndoRequest:null},updatedAt:Date.now()}}if(t.action==="undoDecline"){const{pendingUndoRequest:j}=e.data;return j?{...e,data:{...e.data,pendingUndoRequest:null},updatedAt:Date.now()}:e}if(t.action==="switchTurn"){const{board:j,currentTurn:q}=e.data;if(Object.keys(j).length>0||n!==q)return e;const p=n===e.hostId?e.clientId:e.hostId;return{...e,data:{...e.data,currentTurn:p},updatedAt:Date.now()}}const{row:o,col:i}=t;if(o===void 0||i===void 0)return e;const{board:u,currentTurn:l}=e.data,h=`${o},${i}`;if(n!==l||u[h]||o<0||o>=this.BOARD_SIZE||i<0||i>=this.BOARD_SIZE)return e;const c=n===e.hostId?"X":"O",I=n===e.hostId?e.clientId:e.hostId;return{...e,data:{...e.data,board:{...u,[h]:c},currentTurn:I},updatedAt:Date.now()}}checkGameEnd(e){const{board:t}=e.data;for(const n in t){const[s,o]=n.split(",").map(Number);if(this.checkWinFrom(t,s,o))return{isEnded:!0,winner:t[n]==="X"?e.hostId:e.clientId,isDraw:!1}}return{isEnded:!1,winner:null,isDraw:!1}}checkWinFrom(e,t,n){const s=e[`${t},${n}`];if(!s)return null;const o=[[0,1],[1,0],[1,1],[1,-1]];for(const[i,u]of o){const l=[[t,n]];for(let h=1;h<this.WIN_LENGTH;h++){const c=t+i*h,I=n+u*h;if(e[`${c},${I}`]===s)l.push([c,I]);else break}for(let h=1;h<this.WIN_LENGTH;h++){const c=t-i*h,I=n-u*h;if(e[`${c},${I}`]===s)l.unshift([c,I]);else break}if(l.length>=this.WIN_LENGTH)return l.slice(0,this.WIN_LENGTH)}return null}render(e,t,n,s){const o=e.data.currentTurn===t;return ve.createElement(ln,{state:e,myId:t,onMove:i=>s({action:"move",...i}),onSwitchTurn:()=>s({action:"switchTurn"}),onUndoRequest:()=>s({action:"undoRequest"}),onUndoConfirm:()=>s({action:"undoConfirm"}),onUndoDecline:()=>s({action:"undoDecline"}),isMyTurn:o})}}function un({state:r,myId:e,isHost:t,isMyTurn:n,chess:s,onMove:o,onUndoRequest:i,onUndoConfirm:u,onUndoDecline:l,onNewGameRequest:h,onNewGameConfirm:c,onNewGameDecline:I}){const j=m.useRef(null),q=m.useRef(null),{leaveGame:p}=be(),M=t?"white":"black",R=s.inCheck(),L=s.turn();m.useEffect(()=>{if(!(!j.current||q.current))return q.current=Rt(j.current,{fen:r.data.fen,orientation:M,turnColor:L==="w"?"white":"black",movable:{free:!1,color:n?M:void 0,dests:K()},events:{move:(b,f)=>{Y(b,f)}},draggable:{enabled:!0,showGhost:!0},highlight:{lastMove:!0,check:!0},animation:{enabled:!0,duration:200}}),()=>{var b;(b=q.current)==null||b.destroy(),q.current=null}},[]),m.useEffect(()=>{q.current&&q.current.set({fen:r.data.fen,turnColor:L==="w"?"white":"black",movable:{free:!1,color:n&&r.status==="playing"?M:void 0,dests:n?K():new Map},check:R?L==="w"?"white":"black":void 0})},[r.data.fen,n,r.status]);const K=()=>{const b=new Map;if(console.log("getValidMoves check:",{isMyTurn:n,status:r.status,turn:s.turn(),myColor:M,isHost:t}),!n||r.status!=="playing")return b;const f=["a","b","c","d","e","f","g","h"],x=["1","2","3","4","5","6","7","8"];let S=0;return f.forEach(_=>{x.forEach(G=>{const Z=`${_}${G}`,ne=s.moves({square:Z,verbose:!0});ne.length>0&&(S+=ne.length,b.set(Z,ne.map(me=>me.to)))})}),console.log("getValidMoves result:",{count:S,squaresWithMoves:b.size}),b},Y=(b,f)=>{const x=s.get(b);(x==null?void 0:x.type)==="p"&&(x.color==="w"&&f[1]==="8"||x.color==="b"&&f[1]==="1")?o(b,f,"q"):o(b,f)},w=r.data.moveHistory[r.data.moveHistory.length-1],P={p:"pawn",n:"knight",b:"bishop",r:"rook",q:"queen",k:"king"};return a.jsxs("div",{className:"flex flex-col items-center gap-4 p-4 w-full max-w-2xl mx-auto",children:[a.jsxs("div",{className:"w-full flex items-center justify-between",children:[a.jsxs("div",{className:"flex flex-col gap-1",children:[r.status==="finished"?a.jsx("div",{className:"text-lg font-bold",children:r.winner?a.jsx("span",{className:r.winner===e?"text-green-400":"text-red-400",children:r.winner===e?"You Won!":"Opponent Won!"}):a.jsx("span",{className:"text-yellow-400",children:"Draw!"})}):a.jsxs(a.Fragment,{children:[a.jsx("div",{className:`text-lg font-bold ${n?"text-primary-400":"text-slate-400"}`,children:n?"Your Turn":"Opponent's Turn"}),R&&L===M[0]&&a.jsx("div",{className:"text-sm text-red-400 font-semibold",children:"You are in check!"})]}),a.jsxs("div",{className:"text-xs text-slate-500",children:["Playing as ",t?"White":"Black"]})]}),r.status==="finished"&&a.jsxs("div",{className:"flex gap-2",children:[a.jsxs("button",{onClick:()=>be.getState().restartGame(),className:"px-3 py-2 bg-primary-600 hover:bg-primary-500 rounded-lg text-white font-medium transition-colors flex items-center gap-2",children:[a.jsx(Ye,{className:"w-4 h-4"}),"Play Again"]}),a.jsx("button",{onClick:p,className:"px-3 py-2 bg-slate-800 hover:bg-slate-700 rounded-lg text-slate-300 font-medium transition-colors",children:"Close"})]})]}),r.status==="playing"&&a.jsxs("div",{className:"flex justify-center w-full gap-1",children:[r.data.pendingUndoRequest?r.data.pendingUndoRequest===e?a.jsx("div",{className:"px-3 py-2 bg-yellow-500/20 text-yellow-200 rounded-lg text-sm font-medium flex items-center gap-2",children:a.jsx("span",{children:"Undo requested..."})}):a.jsxs("div",{className:"flex items-center gap-2 bg-slate-800 p-1 rounded-lg border border-slate-700",children:[a.jsx("span",{className:"text-sm text-slate-300 px-2",children:"Opp request undo"}),a.jsx("button",{onClick:u,className:"px-3 py-1 bg-green-600 hover:bg-green-500 text-white rounded text-sm transition-colors",children:"Accept"}),a.jsx("button",{onClick:l,className:"px-3 py-1 bg-red-600 hover:bg-red-500 text-white rounded text-sm transition-colors",children:"Decline"})]}):a.jsxs("button",{onClick:i,disabled:r.data.moveHistory.length===0,className:"px-3 py-2 bg-slate-800 hover:bg-slate-700 disabled:opacity-50 disabled:cursor-not-allowed rounded-lg text-slate-300 font-medium transition-colors flex items-center gap-2 text-sm",children:[a.jsx("div",{className:"scale-x-[-1]",children:a.jsx(Ye,{className:"w-4 h-4"})}),"Undo"]}),r.data.pendingNewGameRequest?r.data.pendingNewGameRequest===e?a.jsx("div",{className:"px-3 py-2 bg-blue-500/20 text-blue-200 rounded-lg text-sm font-medium flex items-center gap-2",children:a.jsx("span",{children:"New Game requested..."})}):a.jsxs("div",{className:"flex items-center gap-2 bg-slate-800 p-2 rounded-lg border border-slate-700 w-full justify-between",children:[a.jsx("span",{className:"text-sm text-slate-300 px-2",children:"Opp request New Game"}),a.jsxs("div",{className:"flex gap-2",children:[a.jsx("button",{onClick:c,className:"px-3 py-1 bg-green-600 hover:bg-green-500 text-white rounded text-sm transition-colors",children:"Accept"}),a.jsx("button",{onClick:I,className:"px-3 py-1 bg-red-600 hover:bg-red-500 text-white rounded text-sm transition-colors",children:"Decline"})]})]}):!r.data.pendingUndoRequest&&a.jsxs("button",{onClick:h,className:"px-3 py-2 bg-slate-800 hover:bg-slate-700 rounded-lg text-slate-300 font-medium transition-colors flex items-center gap-2 text-sm justify-center",children:[a.jsx(Pt,{className:"w-4 h-4"}),"New Game"]})]}),a.jsx("div",{className:"w-full max-w-xl",children:a.jsx("div",{ref:j,className:"w-full aspect-square",style:{maxHeight:"min(80vh, 600px)"}})}),r.data.moveHistory.length>0&&a.jsxs("div",{className:"w-full bg-slate-800 rounded-lg p-3",children:[a.jsx("div",{className:"text-sm text-slate-400 mb-2",children:"Last move:"}),a.jsx("div",{className:"text-lg font-mono text-slate-200",children:w})]}),a.jsxs("div",{className:"w-full flex justify-between gap-4 text-sm",children:[a.jsxs("div",{className:"bg-slate-800 rounded-lg p-2 flex-1",children:[a.jsx("div",{className:"text-xs text-slate-400 mb-1",children:"White captured:"}),a.jsx("div",{className:"flex flex-wrap gap-1",children:r.data.capturedPieces.white.length>0?r.data.capturedPieces.white.map((b,f)=>a.jsx("div",{className:"cg-wrap",style:{width:25,height:25},children:ve.createElement("piece",{className:`piece ${P[b.toLowerCase()]} black`,style:{width:25,height:25}})},f)):a.jsx("span",{className:"text-slate-600",children:"-"})})]}),a.jsxs("div",{className:"bg-slate-800 rounded-lg p-2 flex-1",children:[a.jsx("div",{className:"text-xs text-slate-400 mb-1",children:"Black captured:"}),a.jsx("div",{className:"flex flex-wrap gap-1",children:r.data.capturedPieces.black.length>0?r.data.capturedPieces.black.map((b,f)=>a.jsx("div",{className:"cg-wrap",style:{width:25,height:25},children:ve.createElement("piece",{className:`piece ${P[b.toLowerCase()]} white`,style:{width:25,height:25}})},f)):a.jsx("span",{className:"text-slate-600",children:"-"})})]})]})]})}class fn extends De{constructor(){super(...arguments),this.gameId="chess",this.gameName="Chess",this.gameIcon="ðŸ‘‘",this.gameDescription="Classic chess game"}createInitialState(e,t){return{fen:new Se().fen(),moveHistory:[],capturedPieces:{white:[],black:[]},pendingUndoRequest:null,pendingNewGameRequest:null}}handleInput(e,t,n,s){if(t.action==="undoRequest")return e.data.moveHistory.length===0||e.data.pendingUndoRequest?e:{...e,data:{...e.data,pendingUndoRequest:n},updatedAt:Date.now()};if(t.action==="undoConfirm"){if(!e.data.pendingUndoRequest||n===e.data.pendingUndoRequest)return e;const o=e.data.moveHistory;if(o.length===0)return e;const i=o.slice(0,-1),u=new Se;i.forEach(I=>{u.move(I)});const l=[],h=[],c=new Se;return i.forEach(I=>{const j=c.move(I);j&&j.captured&&((j.color==="w"?"white":"black")==="white"?l.push(j.captured):h.push(j.captured))}),{...e,data:{fen:u.fen(),moveHistory:i,capturedPieces:{white:l,black:h},pendingUndoRequest:null,pendingNewGameRequest:null},updatedAt:Date.now()}}if(t.action==="undoDecline")return!e.data.pendingUndoRequest||n===e.data.pendingUndoRequest?e:{...e,data:{...e.data,pendingUndoRequest:null},updatedAt:Date.now()};if(t.action==="newGameRequest")return e.data.pendingNewGameRequest?e:{...e,data:{...e.data,pendingNewGameRequest:n},updatedAt:Date.now()};if(t.action==="newGameConfirm"){if(!e.data.pendingNewGameRequest||n===e.data.pendingNewGameRequest)return e;const o=new Se;return{...e,data:{fen:o.fen(),moveHistory:[],capturedPieces:{white:[],black:[]},pendingUndoRequest:null,pendingNewGameRequest:null},updatedAt:Date.now()}}if(t.action==="newGameDecline")return!e.data.pendingNewGameRequest||n===e.data.pendingNewGameRequest?e:{...e,data:{...e.data,pendingNewGameRequest:null},updatedAt:Date.now()};if(t.action==="move"){const{from:o,to:i,promotion:u}=t;if(!o||!i)return e;const l=new Se(e.data.fen),h=l.turn()==="w"?e.hostId:e.clientId;if(n!==h)return e;try{const c=l.move({from:o,to:i,promotion:u||"q"});if(!c)return e;const I={...e.data.capturedPieces};if(c.captured){const j=c.color==="w"?"white":"black";I[j].push(c.captured)}return{...e,data:{fen:l.fen(),moveHistory:[...e.data.moveHistory,c.san],capturedPieces:I,pendingUndoRequest:e.data.pendingUndoRequest,pendingNewGameRequest:e.data.pendingNewGameRequest},updatedAt:Date.now()}}catch{return e}}return e}checkGameEnd(e){const t=new Se(e.data.fen);return t.isCheckmate()?{isEnded:!0,winner:t.turn()==="w"?e.clientId:e.hostId,isDraw:!1}:t.isStalemate()||t.isThreefoldRepetition()||t.isInsufficientMaterial()||t.isDraw()?{isEnded:!0,winner:null,isDraw:!0}:{isEnded:!1,winner:null,isDraw:!1}}render(e,t,n,s){const o=new Se(e.data.fen),i=o.turn()==="w"&&t===e.hostId||o.turn()==="b"&&t===e.clientId;return ve.createElement(un,{state:e,myId:t,isHost:n,isMyTurn:i,chess:o,onMove:(u,l,h)=>s({action:"move",from:u,to:l,promotion:h}),onUndoRequest:()=>s({action:"undoRequest"}),onUndoConfirm:()=>s({action:"undoConfirm"}),onUndoDecline:()=>s({action:"undoDecline"}),onNewGameRequest:()=>s({action:"newGameRequest"}),onNewGameConfirm:()=>s({action:"newGameConfirm"}),onNewGameDecline:()=>s({action:"newGameDecline"})})}}ce.register(sn);ce.register(dn);ce.register(fn);ce.register(an);ce.register(cn);const mn=()=>`game_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,be=Fe((r,e)=>({activeGame:null,pendingInvites:[],setActiveGame:t=>r({activeGame:t}),addPendingInvite:t=>r(n=>({pendingInvites:[...n.pendingInvites,t]})),removePendingInvite:t=>r(n=>({pendingInvites:n.pendingInvites.filter(s=>s.sessionId!==t)})),clearPendingInvites:()=>r({pendingInvites:[]}),createGame:(t,n)=>{const{sendMessage:s,myId:o}=we.getState(),i=ce.createInstance(t);if(!i||!o)return null;const u=mn(),l=i.createInitialState(o,n),h={id:u,gameType:t,hostId:o,clientId:n,status:"waiting",winner:null,isDraw:!1,data:l,createdAt:Date.now(),updatedAt:Date.now()};return r({activeGame:h}),s(n,{type:"game_invite",gameType:t,sessionId:u,hostId:o}),u},acceptInvite:t=>{const n=e(),{sendMessage:s,myId:o}=we.getState(),i=n.pendingInvites.find(c=>c.sessionId===t);if(!i||!o)return;const u=ce.createInstance(i.gameType);if(!u)return;n.removePendingInvite(t),s(i.hostId,{type:"game_accept",sessionId:t});const l=u.createInitialState(i.hostId,o),h={id:t,gameType:i.gameType,hostId:i.hostId,clientId:o,status:"waiting",winner:null,isDraw:!1,data:l,createdAt:Date.now(),updatedAt:Date.now()};r({activeGame:h})},declineInvite:t=>{const n=e(),{sendMessage:s}=we.getState(),o=n.pendingInvites.find(i=>i.sessionId===t);o&&(n.removePendingInvite(t),s(o.hostId,{type:"game_decline",sessionId:t}))},makeMove:t=>{const n=e(),{sendMessage:s,myId:o}=we.getState(),{activeGame:i}=n;if(!i||i.status!=="playing"||!o)return;const u=ce.createInstance(i.gameType);if(!u)return;const l=o===i.hostId,h=l?i.clientId:i.hostId;let c=u.handleInput(i,t,o,l);if(u.checkGameEnd){const I=u.checkGameEnd(c);I.isEnded&&(c={...c,status:"finished",winner:I.winner,isDraw:I.isDraw})}c.updatedAt=Date.now(),r({activeGame:c}),l?(s(h,{type:"game_input",sessionId:i.id,playerId:o,input:t}),s(h,{type:"game_state_sync",sessionId:i.id,state:c})):s(h,{type:"game_input",sessionId:i.id,playerId:o,input:t})},restartGame:()=>{const t=e(),{sendMessage:n,myId:s}=we.getState(),{activeGame:o}=t;if(!o||!s)return;const i=ce.createInstance(o.gameType);if(!i)return;const u=s===o.hostId?o.clientId:o.hostId,l=i.createInitialState(o.hostId,o.clientId),h={...o,status:"playing",winner:null,isDraw:!1,data:l,updatedAt:Date.now()};r({activeGame:h}),n(u,{type:"game_state_sync",sessionId:o.id,state:h})},leaveGame:()=>{const t=e(),{sendMessage:n,myId:s}=we.getState(),{activeGame:o}=t;if(!o||!s){r({activeGame:null});return}const i=s===o.hostId?o.clientId:o.hostId;n(i,{type:"game_leave",sessionId:o.id}),r({activeGame:null})},handleGameMessage:(t,n)=>{const s=e(),{sendMessage:o,myId:i}=we.getState();switch(n.type){case"game_invite":{s.addPendingInvite({sessionId:n.sessionId,gameType:n.gameType,hostId:n.hostId,receivedAt:Date.now()});break}case"game_accept":{const{activeGame:u}=s;if(!u||u.id!==n.sessionId||!i)break;const l=ce.createInstance(u.gameType);if(!l)break;const h=l.createInitialState(i,u.clientId),c={...u,status:"playing",data:h,updatedAt:Date.now()};r({activeGame:c}),o(u.clientId,{type:"game_state_sync",sessionId:u.id,state:c});break}case"game_decline":{const{activeGame:u}=s;(u==null?void 0:u.id)===n.sessionId&&r({activeGame:null});break}case"game_input":{const{activeGame:u}=s;if(!u||u.id!==n.sessionId||!i)break;const l=ce.createInstance(u.gameType);if(!l)break;const h=i===u.hostId,c=n.input;let I=l.handleInput(u,c,n.playerId,h);if(l.checkGameEnd){const j=l.checkGameEnd(I);j.isEnded&&(I={...I,status:"finished",winner:j.winner,isDraw:j.isDraw})}I.updatedAt=Date.now(),r({activeGame:I}),h&&o(u.clientId,{type:"game_state_sync",sessionId:u.id,state:I});break}case"game_state_sync":{const{activeGame:u}=s;if(!u||u.id!==n.sessionId)break;r({activeGame:n.state});break}case"game_leave":{const{activeGame:u}=s;(u==null?void 0:u.id)===n.sessionId&&r({activeGame:{...u,status:"cancelled"}}),s.removePendingInvite(n.sessionId);break}}}}));function hn(){var He,Xe;const{chats:r,setChats:e,isStorageReady:t,setIsStorageReady:n,setTypingStates:s,setSessions:o,activeSessionId:i,setActiveSessionId:u,peerConfig:l,setPeerConfig:h,selectedPeerId:c,setSelectedPeerId:I,showMobileDashboard:j,showSettings:q,pendingConnectPeerId:p,setPendingConnectPeerId:M}=Qt(),{handleGameMessage:R}=be(),[L,K]=m.useState("idle"),[Y,w]=m.useState(null),[P,b]=m.useState(null),[f,x]=m.useState(null),[S,_]=m.useState(null),[G,Z]=m.useState(null),[ne,me]=m.useState(null),Ce=m.useRef(new Map),te=m.useRef("");m.useEffect(()=>{te.current=i},[i]);const pe=m.useRef(()=>!1),Te=m.useRef(async()=>!1),ke=m.useRef(async()=>null),Me=m.useRef(()=>{}),D=m.useRef(()=>!1);m.useEffect(()=>{(async()=>{try{await Ot();let d=$t(),E=Yt();if(d.length===0){const U=Pe(),$={id:U,createdAt:Date.now()};at($),_e(U),d=[$],E=U}else(!E||!d.find(U=>U.id===E))&&(E=d[0].id,_e(E));o(d),u(E);const O=await rt(E);e(O)}catch(d){console.error("Failed to init storage:",d)}finally{n(!0)}})()},[]);const g=y=>{h(y)},C=m.useCallback((y,d)=>{if(d&&typeof d=="object"&&d.type==="typing"){s(N=>({...N,[y]:d.isTyping}));return}if(d&&typeof d=="object"&&d.type==="presence")return;if(d&&typeof d=="object"&&d.type==="key_exchange"){const N=D.current(y);Te.current(y,d).then(v=>{v&&(console.log("Key exchange completed with",y),N||ke.current().then(k=>{k&&pe.current(y,{type:"key_exchange",...k})}))});return}if(d&&typeof d=="object"&&d.type==="encrypted_message"){We.current(y,d.payload).then(N=>{if(N)try{const v=JSON.parse(N);Me.current(y,{...v,_encrypted:!0})}catch{console.error("Failed to parse decrypted message")}});return}if(d&&typeof d=="object"&&d.type==="receipt"){const{messageId:N,status:v,timestamp:k}=d;e(T=>{const A=T[y];if(!A)return T;const F=A.messages.map(J=>{if(J.id===N){if(v==="delivered")return{...J,status:"delivered",receivedAt:k};if(v==="read")return{...J,status:"read",readAt:k}}return J}),V={...A,messages:F};return ie(te.current,V),{...T,[y]:V}});return}if(d&&typeof d=="object"&&d.type==="file_start"){const{fileId:N,fileName:v,fileSize:k,mimeType:T,totalChunks:A,messageType:F}=d,V={id:N,fileName:v,fileSize:k,mimeType:T,totalChunks:A,receivedChunks:new Map,progress:0,messageType:F||"file"};Ce.current.set(N,V),me({fileId:N,fileName:v,progress:0});return}if(d&&typeof d=="object"&&d.type==="file_chunk"){const{fileId:N,chunkIndex:v,data:k}=d,T=Ce.current.get(N);if(!T)return;T.receivedChunks.set(v,k);const A=Math.round(T.receivedChunks.size/T.totalChunks*100);T.progress=A,me({fileId:N,fileName:T.fileName,progress:A});return}if(d&&typeof d=="object"&&d.type==="file_end"){const{fileId:N}=d,v=Ce.current.get(N);if(!v)return;const k=[];for(let F=0;F<v.totalChunks;F++){const V=v.receivedChunks.get(F);V&&k.push(V)}const T=new Blob(k),A={id:Pe(),senderId:y,content:v.fileName,timestamp:Date.now(),receivedAt:Date.now(),status:"delivered",type:v.messageType,file:{name:v.fileName,size:v.fileSize,mimeType:v.mimeType,data:T}};e(F=>{const V=F[y]||{peerId:y,messages:[],lastUpdated:Date.now(),unreadCount:0},J={...V,messages:[...V.messages,A],lastUpdated:Date.now(),unreadCount:c===y?0:V.unreadCount+1};return ie(te.current,J),{...F,[y]:J}}),pe.current(y,{type:"receipt",messageId:A.id,status:"delivered",timestamp:Date.now()}),Ce.current.delete(N),me(null);return}if(d&&typeof d=="object"&&d.type==="sync_request"){K("incoming"),w(y);return}if(d&&typeof d=="object"&&d.type==="sync_reject"){K("idle"),w(null),alert(`${y} declined the sync request.`);return}if(d&&typeof d=="object"&&d.type==="sync_cancel"){K("idle"),w(null);return}if(d&&typeof d=="object"&&(d.type==="sync_data_initial"||d.type==="sync_data_final")){const N=d.messages;if(!Array.isArray(N))return;e(v=>{const k=v[y]||{peerId:y,messages:[],lastUpdated:Date.now(),unreadCount:0},T=new Set(k.messages.map(J=>J.id)),A=N.filter(J=>!T.has(J.id));if(A.length===0&&d.type==="sync_data_final")return v;const F=[...k.messages,...A].sort((J,vt)=>J.timestamp-vt.timestamp),V={...k,messages:F};return ie(te.current,V),d.type==="sync_data_initial"&&pe.current(y,{type:"sync_data_final",messages:F}),{...v,[y]:V}}),b({phase:d.type==="sync_data_initial"?"Receiving":"Merging",count:N.length}),setTimeout(()=>{K("idle"),w(null),b(null)},500);return}const E=d.id||Pe(),O=d.timestamp||Date.now(),U=d._encrypted===!0;let $;typeof d=="string"?$={id:E,senderId:y,content:d,timestamp:O,receivedAt:Date.now(),status:"delivered",type:"text",encrypted:!1}:$={id:E,senderId:y,content:d.content||"",timestamp:O,receivedAt:Date.now(),status:"delivered",type:d.type||"text",file:d.file,encrypted:U},!(!$.content&&!$.file)&&(pe.current(y,{type:"receipt",messageId:E,status:"delivered",timestamp:Date.now()}),e(N=>{const v=N[y]||{peerId:y,messages:[],lastUpdated:Date.now(),unreadCount:0},k={...v,messages:[...v.messages,$],lastUpdated:Date.now(),unreadCount:c===y?0:v.unreadCount+1},T={...N,[y]:k};return ie(te.current,k),T}))},[c]),H=m.useCallback(y=>{e(d=>{if(!d[y]){const E={peerId:y,messages:[],lastUpdated:Date.now(),unreadCount:0};return ie(te.current,E),{...d,[y]:E}}return d}),ke.current().then(d=>{d&&pe.current(y,{type:"key_exchange",...d})}),window.innerWidth>=768&&!c&&I(y)},[c]),re=m.useCallback(y=>{s(d=>({...d,[y]:!1}))},[]),{myId:Q,isReady:se,isReconnecting:le,peerError:de,connectionStates:W,activeConnectionsCount:X,connectToPeer:ue,disconnectPeer:fe,sendMessage:z,updateId:qe,initPeer:ge,addListener:ae}=we();m.useEffect(()=>{const y=E=>{var U;const O=((U=r[E])==null?void 0:U.name)||E.slice(0,8);x(`Disconnected "${O}" - max ${ot} connections reached`),setTimeout(()=>x(null),4e3)},d=[ae("message",C),ae("message",R),ae("connectionOpened",H),ae("connectionClosed",re),ae("connectionLimitExceeded",y)];return()=>d.forEach(E=>E())},[C,H,re,r,ae]),m.useEffect(()=>{i&&t&&ge(i,l)},[i,l,t,ge]);const{myFingerprint:Ie,createKeyExchange:Ne,handleKeyExchange:je,encrypt:B,decrypt:Re,getPeerFingerprint:ct,hasPeerKey:Ee,markPeerVerified:lt,exportMyKeys:dt,importMyKeys:ut}=Bt({sessionId:i,onKeyChange:(y,d,E)=>{_({peerId:y,oldFingerprint:d,newFingerprint:E})}}),ft=m.useRef(B),We=m.useRef(Re);m.useEffect(()=>{ft.current=B,We.current=Re,Te.current=je,ke.current=Ne,D.current=Ee},[B,Re,je,Ne,Ee]),m.useEffect(()=>{pe.current=z},[z]),m.useEffect(()=>{Me.current=C},[C]),m.useEffect(()=>{se&&p&&p!==Q&&(console.log("Auto-connecting to peer from URL:",p),ue(p),I(p),M(null))},[se,p,Q,ue]);const mt=async y=>{if(!c)return;const d=Pe(),E=Date.now();let O={id:d,timestamp:E};typeof y=="string"?(O.content=y,O.type="text"):O={...O,...y};const U=Ee(c);let $=!1,N=!1;if(U){const v=await B(c,JSON.stringify(O));v?($=z(c,{type:"encrypted_message",payload:v}),N=!0):$=z(c,O)}else $=z(c,O);if($){const v={id:d,senderId:Q,content:O.content||"",timestamp:E,status:"sent",type:O.type,file:O.file,encrypted:N};e(k=>{const T=k[c]||{peerId:c,messages:[],lastUpdated:Date.now(),unreadCount:0},A={...T,messages:[...T.messages,v],lastUpdated:Date.now()},F={...k,[c]:A};return ie(te.current,A),F}),setTimeout(()=>{e(k=>{const T=k[c];if(!T)return k;const A=T.messages.find(F=>F.id===d);if(A&&A.status==="sent"){const F=T.messages.map(J=>J.id===d?{...J,status:"failed"}:J),V={...T,messages:F};return ie(te.current,V),{...k,[c]:V}}return k})},1e4)}else{const v={id:d,senderId:Q,content:O.content||"",timestamp:E,status:"failed",type:O.type,file:O.file};e(k=>{const T=k[c]||{peerId:c,messages:[],lastUpdated:Date.now(),unreadCount:0},A={...T,messages:[...T.messages,v],lastUpdated:Date.now()},F={...k,[c]:A};return ie(te.current,A),F})}},ht=async(y,d,E)=>{if(!c)return;const O=Math.ceil(d.size/Le),U=await d.arrayBuffer();z(c,{type:"file_start",fileId:y,fileName:d.name,fileSize:d.size,mimeType:d.type,totalChunks:O,messageType:E});const $={id:y,senderId:Q,content:d.name,timestamp:Date.now(),status:"sending",type:E,file:{name:d.name,size:d.size,mimeType:d.type,data:new Blob([U])}};e(N=>{const v=N[c]||{peerId:c,messages:[],lastUpdated:Date.now(),unreadCount:0},k={...v,messages:[...v.messages,$],lastUpdated:Date.now()};return{...N,[c]:k}});for(let N=0;N<O;N++){const v=N*Le,k=Math.min(v+Le,d.size),T=U.slice(v,k);z(c,{type:"file_chunk",fileId:y,chunkIndex:N,data:T});const A=Math.round((N+1)/O*100);Z({fileId:y,progress:A}),await new Promise(F=>setTimeout(F,10))}z(c,{type:"file_end",fileId:y}),e(N=>{const v=N[c];if(!v)return N;const k=v.messages.map(A=>A.id===y?{...A,status:"sent"}:A),T={...v,messages:k};return ie(te.current,T),{...N,[c]:T}}),Z(null)},pt=y=>{if(!c)return;const d=r[c];if(!d)return;const E=d.messages.find(U=>U.id===y);if(!E||E.status!=="failed")return;z(c,{id:E.id,content:E.content,timestamp:E.timestamp})&&(e(U=>{const $=U[c];if(!$)return U;const N=$.messages.map(k=>k.id===y?{...k,status:"sent"}:k),v={...$,messages:N};return ie(te.current,v),{...U,[c]:v}}),setTimeout(()=>{e(U=>{const $=U[c];if(!$)return U;const N=$.messages.find(v=>v.id===y);if(N&&N.status==="sent"){const v=$.messages.map(T=>T.id===y?{...T,status:"failed"}:T),k={...$,messages:v};return ie(te.current,k),{...U,[c]:k}}return U})},1e4))},gt=()=>{c&&(z(c,{type:"sync_request"}),K("outgoing"),w(c))},yt=()=>{Y&&z(Y,{type:"sync_cancel"}),K("idle"),w(null)},xt=()=>{if(!Y)return;const y=r[Y],d=y?y.messages:[];K("outgoing"),b({phase:"Sending",count:d.length}),z(Y,{type:"sync_data_initial",messages:d}),setTimeout(()=>{K("idle"),w(null),b(null)},800)},wt=()=>{Y&&(z(Y,{type:"sync_reject"}),K("idle"),w(null))};return t?a.jsxs("div",{className:"flex h-screen overflow-hidden bg-slate-950 text-slate-100 font-sans selection:bg-primary-500/30 relative",children:[f&&a.jsx("div",{className:"absolute bottom-20 left-1/2 -translate-x-1/2 z-50 animate-in fade-in slide-in-from-bottom-4",children:a.jsxs("div",{className:"bg-yellow-500/10 border border-yellow-500/50 backdrop-blur-md text-yellow-200 px-4 py-3 rounded-lg shadow-xl flex items-center gap-3",children:[a.jsx("span",{className:"text-sm font-medium",children:f}),a.jsx("button",{onClick:()=>x(null),className:"p-1 hover:bg-yellow-500/20 rounded-full transition-colors",children:a.jsx(Ge,{className:"w-4 h-4"})})]})}),a.jsx("div",{className:`
        ${c||j?"hidden md:flex":"flex"}
        w-full md:w-80 flex-col border-r border-slate-800
      `,children:a.jsx(Ft,{})}),a.jsx("div",{className:`
        ${c||j?"flex":"hidden md:flex"}
        flex-1 flex-col min-w-0 bg-slate-950
      `,children:a.jsx(Wt,{onSendMessage:mt,onResendMessage:pt,onRequestSync:gt,onSendFileChunked:ht,sendingProgress:G,receivingProgress:ne,peerFingerprint:c?ct(c):null,isEncrypted:c?Ee(c):!1})}),a.jsx(Xt,{status:L,targetPeerId:Y,peerName:Y?(He=r[Y])==null?void 0:He.name:void 0,progress:P,onCancel:yt,onAccept:xt,onReject:wt}),q&&a.jsx(Ht,{config:l,onSave:g,myFingerprint:Ie,onExportKeys:dt,onImportKeys:ut}),a.jsx(zt,{warning:S,peerName:S?(Xe=r[S.peerId])==null?void 0:Xe.name:void 0,onDisconnect:()=>{S&&(fe(S.peerId),_(null))},onTrust:()=>{S&&(lt(S.peerId),_(null))}})]}):a.jsx("div",{className:"h-screen w-screen flex items-center justify-center bg-slate-950 text-white",children:"Initializing..."})}const it=document.getElementById("root");if(!it)throw new Error("Could not find root element to mount to");const pn=Dt.createRoot(it);pn.render(a.jsx(ve.StrictMode,{children:a.jsx(hn,{})}));export{Le as F,Mn as M,we as a,be as b,Tn as c,Dn as d,ce as g,Qt as u};
